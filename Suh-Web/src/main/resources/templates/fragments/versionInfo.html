<!-- src/main/resources/templates/fragments/versionInfo.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>

<!-- 버전 정보 컴포넌트 -->
<!-- 사용법: <div th:replace="~{fragments/versionInfo :: versionInfo(moduleType='TRANSLATOR')}"></div> -->

<div th:fragment="versionInfo(moduleType)" class="version-info-segment">
  <div class="collapse collapse-arrow bg-base-200 version-accordion"
       th:id="${moduleType.toLowerCase() + 'VersionAccordion'}"></div>

  <script th:inline="javascript">
    $(document).ready(function () {
      loadModuleVersions([[${moduleType}]], [[${moduleType.toLowerCase() + 'VersionAccordion'}]]);
    });

    /**
     * 모듈 버전 정보를 로드하고 중첩 아코디언으로 표시
     * @param {string} moduleType - 모듈 타입 (예: "TRANSLATOR", "GITHUB_ISSUE_HELPER")
     * @param {string} containerId - 버전 정보를 표시할 컨테이너 ID
     */
    function loadModuleVersions(moduleType, containerId = 'versionAccordion') {
      // 로딩 상태 표시
      const versionAccordion = document.getElementById(containerId);
      if (!versionAccordion) {
        console.error(`Container with ID '${containerId}' not found`);
        return;
      }

      // 플레이스홀더 ID 생성
      const placeholderId = `${containerId}-placeholder`;
      // 컨텐츠 ID 생성
      const contentId = `${containerId}-content`;
      // 모듈 타입을 소문자로 변환
      const moduleTypeLower = moduleType.toLowerCase();

      versionAccordion.innerHTML = `
        <div id="${placeholderId}" class="space-y-4">
          <!-- 최신 버전 섹션 플레이스홀더 -->
          <div class="skeleton h-8 w-3/4"></div>
          <div class="skeleton h-4 w-full"></div>
          <div class="skeleton h-4 w-5/6"></div>
          <div class="skeleton h-4 w-4/5"></div>

          <!-- 전체 버전 기록 플레이스홀더 -->
          <div class="skeleton h-8 w-3/4"></div>
          <div class="skeleton h-4 w-full"></div>
          <div class="skeleton h-4 w-5/6"></div>
          <div class="skeleton h-4 w-4/5"></div>
          <div class="skeleton h-4 w-3/4"></div>
        </div>

          <!-- 메인 버전 정보 아코디언 -->
      <div id="${contentId}" class="collapse collapse-arrow bg-base-200 ${moduleTypeLower}-main-accordion hidden"></div>
      `
      ;

      var formData = new FormData();
      formData.append("moduleType", moduleType);

      $.ajax({
        url: '/api/module/get/versions',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function (response) {
          console.log(
              `Version response for ${moduleType}:`
              , response);

          if (response && response.versions) {
            // 플레이스홀더 숨기기
            $(
                `#${placeholderId}`
            ).hide();

            // 버전 정보 렌더링
            renderVersionsWithNestedAccordion(response.versions, contentId, moduleType);

            // 컨텐츠 표시
            $(
                `#${contentId}`
            ).show();

            // 초기화 이벤트 바인딩 호출
            initializeAccordions(contentId, moduleType);
          } else {
            console.error('Unexpected response structure:', response);
            versionAccordion.innerHTML =
                `
      <div class="alert alert-warning">
      <i class="fa-solid fa-triangle-exclamation"></i>
      <div>
        <h3 class="font-bold">버전 정보를 불러올 수 없습니다</h3>
        <p>서버에서 올바른 형식의 데이터를 받지 못했습니다.</p>
      </div>
      </div>
      `
            ;
            if (typeof showToast === 'function') {
              showToast("버전 정보 형식이 올바르지 않습니다.", "negative");
            }
          }
        },
        error: function (xhr, status, error) {
          console.error('Error loading module versions:', xhr.status, xhr.responseText, error);

          versionAccordion.innerHTML =
              `
      <div class="alert alert-error">
      <i class="fa-solid fa-circle-exclamation"></i>
      <div>
        <h3 class="font-bold">버전 정보를 불러올 수 없습니다</h3>
        <p>서버 오류가 발생했습니다. 나중에 다시 시도해 주세요.</p>
      </div>
      </div>
      `
          ;

          if (typeof showToast === 'function') {
            showToast("버전 정보를 불러오는 데 실패했습니다: " + xhr.status, "negative");
          }
        }
      });
    }

      /**
       * 아코디언 초기화 및 이벤트 바인딩
       * @param {string} contentId - 메인 컨텐츠 ID
       * @param {string} moduleType - 모듈 타입
       */
      function initializeAccordions(contentId, moduleType) {
        const moduleTypeLower = moduleType.toLowerCase();

        // DaisyUI collapse는 기본적으로 작동하므로 추가 초기화 불필요
        // 각 요소마다 클릭 가능 표시
        $(
            `.${moduleTypeLower}-main-title-label, .${moduleTypeLower}-version-title-label`
        ).css('cursor', 'pointer');
      }

      /**
       * 중첩 아코디언 구조로 버전 정보 렌더링
       * @param {Array} versions - 버전 정보 배열
       * @param {string} containerId - 버전 정보를 표시할 컨테이너 ID
       * @param {string} moduleType - 모듈 타입
       */
      function renderVersionsWithNestedAccordion(versions, containerId, moduleType) {
        const accordion = document.getElementById(containerId);
        if (!accordion) {
          console.error(
              `Container with ID '${containerId}' not found`
          );
          return;
        }

        if (!versions || !Array.isArray(versions) || versions.length === 0) {
          console.warn("No versions to render or versions is not an array");
          accordion.innerHTML =
              `
      <div class="alert alert-info">
      <i class="fa-solid fa-info-circle"></i>
      <div>
        <h3 class="font-bold">버전 정보가 없습니다</h3>
        <p>이 모듈에 대한 버전 정보가 아직 등록되지 않았습니다.</p>
      </div>
      </div>
      `
          ;
          return;
        }

        accordion.innerHTML = '';

        // 최신 버전 찾기
        const latestVersion = versions.find(v => v.isLatest === true) || versions[0];

        // 먼저 최신 버전 정보 표시
        renderLatestVersionSection(accordion, latestVersion, moduleType);

        // 전체 버전 정보를 중첩 아코디언으로 표시
        renderAllVersionsSection(accordion, versions, moduleType);
      }

      /**
       * 최신 버전 정보 섹션을 렌더링
       * @param {HTMLElement} container - 컨테이너 요소
       * @param {Object} latestVersion - 최신 버전 정보 객체
       * @param {string} moduleType - 모듈 타입
       */
      function renderLatestVersionSection(container, latestVersion, moduleType) {
        const moduleTypeLower = moduleType.toLowerCase();

        // 최신 버전 제목 (항상 활성화)
        const titleDiv = document.createElement('input');
        titleDiv.type = 'checkbox';
        titleDiv.checked = true;
        titleDiv.className = `${moduleTypeLower}-main-title`;
        titleDiv.setAttribute('aria-label', '최신 버전');

        const titleLabel = document.createElement('div');
        titleLabel.className = `collapse-title text-lg font-medium ${moduleTypeLower}-main-title-label`;
        titleLabel.innerHTML =
            `
      <div class="version-row flex items-center justify-between">
      <div class="version-label flex items-center gap-2">
      <i class="fa-solid fa-code-branch"></i>
      최신 버전 <span class="version-tag font-mono">${latestVersion.versionNumber}</span>
      <span class="badge badge-sm badge-success">최신</span>
      </div>
      <span class="version-date text-sm text-gray-500">${formatDate(latestVersion.releaseDate)}</span>
      </div>
      `
        ;

        // 최신 버전 콘텐츠 (항상 활성화)
        const contentDiv = document.createElement('div');
        contentDiv.className =
            `collapse-content ${moduleTypeLower}-main-content`
        ;

        // 업데이트 목록
        const updateList = createUpdatesList(latestVersion.updates);
        contentDiv.appendChild(updateList);

        // 컨테이너에 추가
        const collapseDiv = document.createElement('div');
        collapseDiv.className = 'collapse collapse-arrow bg-base-200';
        collapseDiv.appendChild(titleDiv);
        collapseDiv.appendChild(titleLabel);
        collapseDiv.appendChild(contentDiv);
        container.appendChild(collapseDiv);
      }

      /**
       * 전체 버전 정보 섹션을 중첩 아코디언으로 렌더링
       * @param {HTMLElement} container - 컨테이너 요소
       * @param {Array} versions - 버전 정보 배열
       * @param {string} moduleType - 모듈 타입
       */
      function renderAllVersionsSection(container, versions, moduleType) {
        // 모듈 타입을 소문자로 변환
        const moduleTypeLower = moduleType.toLowerCase();

        // 모든 버전 섹션 타이틀
        const allVersionsTitleInput = document.createElement('input');
        allVersionsTitleInput.type = 'checkbox';
        allVersionsTitleInput.className = `${moduleTypeLower}-main-title`;
        allVersionsTitleInput.setAttribute('aria-label', '전체 버전 기록');

        const allVersionsTitleLabel = document.createElement('div');
        allVersionsTitleLabel.className = `collapse-title text-lg font-medium ${moduleTypeLower}-main-title-label`;
        allVersionsTitleLabel.innerHTML =
            `
      <div class="version-row flex items-center gap-2">
      <i class="fa-solid fa-history"></i>
      전체 버전 기록
      </div>
      `
        ;

        // 모든 버전 섹션 콘텐츠
        const allVersionsContentDiv = document.createElement('div');
        allVersionsContentDiv.className =
            `collapse-content ${moduleTypeLower}-main-content`
        ;

        // 중첩 아코디언 생성 (모듈 타입으로 클래스 구분)
        const nestedAccordion = document.createElement('div');
        nestedAccordion.className =
            `space-y-2 ${moduleTypeLower}-nested-accordion`
        ;
        nestedAccordion.setAttribute('data-module', moduleTypeLower);

        // 모든 버전 정보 추가
        versions.forEach((version, index) => {
          const versionCollapse = document.createElement('div');
          versionCollapse.className = 'collapse collapse-arrow bg-base-100';
          
          const versionTitleInput = document.createElement('input');
          versionTitleInput.type = 'checkbox';
          versionTitleInput.className = `${moduleTypeLower}-version-title`;
          versionTitleInput.setAttribute('data-version-index', index);
          versionTitleInput.setAttribute('aria-label', `버전 ${version.versionNumber}`);

          const versionTitleLabel = document.createElement('div');
          versionTitleLabel.className = `collapse-title ${moduleTypeLower}-version-title-label`;
          versionTitleLabel.innerHTML =
              `
      <div class="version-row flex items-center justify-between">
      <div class="version-label flex items-center gap-2">
      <i class="fa-solid fa-code-branch"></i>
      버전 <span class="version-tag font-mono">${version.versionNumber}</span>
          ${version.isLatest ? '<span class="badge badge-sm badge-success">최신</span>' : ''}
      </div>
      <span class="version-date text-sm text-gray-500">${formatDate(version.releaseDate)}</span>
      </div>
      `
          ;

          const versionContentDiv = document.createElement('div');
          versionContentDiv.className =
              `collapse-content ${moduleTypeLower}-version-content`
          ;
          versionContentDiv.setAttribute('data-version-index', index);

          // 업데이트 목록
          const updateList = createUpdatesList(version.updates);
          versionContentDiv.appendChild(updateList);

          // 중첩 아코디언에 추가
          versionCollapse.appendChild(versionTitleInput);
          versionCollapse.appendChild(versionTitleLabel);
          versionCollapse.appendChild(versionContentDiv);
          nestedAccordion.appendChild(versionCollapse);
        });

        // 중첩 아코디언을 콘텐츠에 추가
        allVersionsContentDiv.appendChild(nestedAccordion);

        // 전체 버전 섹션을 컨테이너에 추가
        const allVersionsCollapse = document.createElement('div');
        allVersionsCollapse.className = 'collapse collapse-arrow bg-base-200';
        allVersionsCollapse.appendChild(allVersionsTitleInput);
        allVersionsCollapse.appendChild(allVersionsTitleLabel);
        allVersionsCollapse.appendChild(allVersionsContentDiv);
        container.appendChild(allVersionsCollapse);
      }

      /**
       * 업데이트 목록을 생성
       * @param {Array} updates - 업데이트 정보 배열
       * @returns {HTMLElement} 업데이트 목록 요소
       */
      function createUpdatesList(updates) {
        const updateList = document.createElement('ul');
        updateList.className = 'space-y-2';

        if (updates && Array.isArray(updates) && updates.length > 0) {
          updates.forEach(update => {
            const item = document.createElement('li');
            item.className = 'flex items-start gap-2';

            // moduleUpdateType에 따른 아이콘 매핑
            let iconName = "info-circle";

            // moduleUpdateType에 따라 아이콘 선택
            if (update.moduleUpdateType) {
              switch(update.moduleUpdateType) {
                case "RELEASE":
                  iconName = "rocket";
                  break;
                case "OPTIMIZATION":
                  iconName = "microchip";
                  break;
                case "PERFORMANCE":
                  iconName = "bolt";
                  break;
                case "BUGFIX":
                  iconName = "bug";
                  break;
                case "FEATURE":
                  iconName = "star";
                  break;
                case "SECURITY":
                  iconName = "shield";
                  break;
                case "DESIGN":
                  iconName = "paintbrush";
                  break;
                case "DOCUMENTATION":
                  iconName = "book";
                  break;
                default:
                  iconName = "info-circle";
              }
            }

            item.innerHTML = `
        <div class="flex-1">
          <div class="font-semibold mb-1 flex items-center gap-2">
            <i class="fa-solid fa-${iconName}"></i>
            ${update.updateTitle}
          </div>
          <div class="text-sm text-gray-600">${update.updateDescription || ''}</div>
        </div>
      `;
            updateList.appendChild(item);
          });
        } else {
          updateList.innerHTML = `
      <li class="text-gray-500">
        업데이트 정보가 없습니다
      </li>
    `;
        }

        return updateList;
      }

      /**
       * 날짜 형식 포맷팅 함수
       * @param {string} dateString - 날짜 문자열
       * @returns {string} 포맷팅된 날짜 문자열
       */
      function formatDate(dateString) {
        if (!dateString) {
          return '';
        }

        try {
          const date = new Date(dateString);
          if (isNaN(date.getTime())) {
            return dateString;
          }

          return date.toLocaleDateString('ko-KR', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          });
        } catch (e) {
          console.error('Date formatting error:', e);
          return dateString;
        }
      }
  </script>
</div>
</body>
</html>