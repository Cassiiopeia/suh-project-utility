<!-- fragments/header.html -->
<head th:fragment="head(title)">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />
  <title th:text="${title}">S.LAB</title>

  <!-- Tailwind CSS + DaisyUI -->
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />

  <!-- Font Awesome Icons (브랜드 아이콘 포함) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Pretendard 폰트 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/variable/pretendardvariable.css">

  <!-- 커스텀 CSS -->
  <link rel="stylesheet" href="/css/common.css">

  <!-- 스터디 모듈 관련 CSS (마크다운 에디터 등) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.1.0/github-markdown-light.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">

  <!-- 전역 변수 추가 -->
  <th:block th:replace="~{fragments/conf :: conf}"> </th:block>

  <!-- 스크립트 파일 포함 -->
  <script th:src="@{/js/jquery.min.js}"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script th:src="@{/js/common.js}"></script>

  <style>
    /* Tailwind와 함께 사용할 기본 스타일 */
    html, body, button, input, select, textarea {
      font-family: 'Pretendard Variable', -apple-system, BlinkMacSystemFont, system-ui, Roboto, 'Helvetica Neue', 'Segoe UI', 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', sans-serif !important;
    }

    /* DaisyUI Primary 색상 커스텀 */
    [data-theme="light"], :root {
      --color-primary: oklch(0.61 0.24 252.55 / 1);
      --color-primary-content: oklch(1 0 0 / 1);
    }
  </style>
</head>

<div th:fragment="header">
  <!-- DaisyUI Navbar - 파란색 테마 -->
  <div class="navbar bg-white shadow-md fixed top-0 left-0 right-0 z-50 px-4 lg:px-8">
    <div class="navbar-start">
      <a href="/dashboard" class="flex items-center gap-2 hover:opacity-80 transition-opacity">
        <img src="/images/logo_no_text.png" alt="로고" class="h-8 w-8">
        <!-- 데스크탑: SAECHAN LAB -->
        <span class="hidden lg:inline text-lg font-bold text-gray-800">SAECHAN LAB</span>
        <!-- 모바일: S-LAB -->
        <span class="lg:hidden text-lg font-bold text-gray-800">S-LAB</span>
      </a>

      <!-- 버전 태그 (모든 화면 크기에서 표시) -->
      <button onclick="openChangelogModal()"
              class="badge gap-1 px-3 py-1 text-xs hover:opacity-80 transition-opacity cursor-pointer ml-2"
              style="background-color: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd;">
        <i class="fa-solid fa-tag"></i>
        <span id="header-version-tag">v1.0.0</span>
      </button>
    </div>

    <div class="navbar-end">
      <!-- Desktop Menu -->
      <div class="hidden lg:flex items-center gap-1">
        <!-- 다크모드 토글 -->
        <label class="swap swap-rotate cursor-pointer p-2">
          <input type="checkbox" class="theme-controller" value="dark" id="theme-toggle-desktop" />
          <!-- 해 아이콘 (라이트 모드일 때 표시) -->
          <svg class="swap-off h-6 w-6 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M5.64,17l-.71.71a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0l.71-.71A1,1,0,0,0,5.64,17ZM5,12a1,1,0,0,0-1-1H3a1,1,0,0,0,0,2H4A1,1,0,0,0,5,12Zm7-7a1,1,0,0,0,1-1V3a1,1,0,0,0-2,0V4A1,1,0,0,0,12,5ZM5.64,7.05a1,1,0,0,0,.7.29,1,1,0,0,0,.71-.29,1,1,0,0,0,0-1.41l-.71-.71A1,1,0,0,0,4.93,6.34Zm12,.29a1,1,0,0,0,.7-.29l.71-.71a1,1,0,1,0-1.41-1.41L17,5.64a1,1,0,0,0,0,1.41A1,1,0,0,0,17.66,7.34ZM21,11H20a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm-9,8a1,1,0,0,0-1,1v1a1,1,0,0,0,2,0V20A1,1,0,0,0,12,19ZM18.36,17A1,1,0,0,0,17,18.36l.71.71a1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41ZM12,6.5A5.5,5.5,0,1,0,17.5,12,5.51,5.51,0,0,0,12,6.5Zm0,9A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"/>
          </svg>
          <!-- 달 아이콘 (다크 모드일 때 표시) -->
          <svg class="swap-on h-6 w-6 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z"/>
          </svg>
        </label>
        <a href="/profile" class="btn btn-ghost btn-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600">
          <i class="fa-solid fa-user"></i>
          프로필
        </a>
        <a href="/dashboard" class="btn btn-ghost btn-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600">
          <i class="fa-solid fa-clipboard-list"></i>
          대시보드
        </a>
        <div class="dropdown dropdown-end">
          <div tabindex="0" role="button" class="btn btn-ghost btn-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600">
            <i class="fa-solid fa-ellipsis"></i>
            더보기
            <i class="fa-solid fa-chevron-down text-xs"></i>
          </div>
          <ul tabindex="0" class="dropdown-content menu bg-white rounded-box shadow-lg z-50 w-56 p-2 mt-2 border border-gray-100">
            <li><a href="/issue-helper" class="hover:bg-blue-50 hover:text-blue-600"><i class="fa-brands fa-github w-5"></i>깃헙 이슈</a></li>
            <li><a href="/translator" class="hover:bg-blue-50 hover:text-blue-600"><i class="fa-solid fa-language w-5"></i>번역기</a></li>
            <li class="divider my-1"></li>
            <li><a href="/notice-management" class="hover:bg-blue-50 hover:text-blue-600"><i class="fa-solid fa-bullhorn w-5"></i>공지사항 관리</a></li>
            <li><a href="/docker-logs" class="hover:bg-blue-50 hover:text-blue-600"><i class="fa-solid fa-terminal w-5"></i>컨테이너 로그</a></li>
            <li><a href="/study-management" class="hover:bg-blue-50 hover:text-blue-600"><i class="fa-solid fa-book w-5"></i>스터디 플랜</a></li>
            <li><a href="/grass" class="hover:bg-blue-50 hover:text-blue-600"><i class="fa-solid fa-leaf w-5"></i>Grass Planter</a></li>
            <li><a href="/ai-server" class="hover:bg-blue-50 hover:text-blue-600"><i class="fa-solid fa-server w-5"></i>AI 서버 관리</a></li>
            <li><a href="/chatbot-management" class="hover:bg-blue-50 hover:text-blue-600"><i class="fa-solid fa-database w-5"></i>챗봇 문서 관리</a></li>
          </ul>
        </div>

        <!-- 로그인 버튼 (초기 숨김) -->
        <a href="/login" id="login-btn-desktop" class="btn btn-primary btn-sm" style="display: none;">
          <i class="fa-solid fa-right-to-bracket"></i>
          로그인
        </a>

        <!-- 로그아웃 버튼 (초기 숨김) -->
        <form th:action="@{/logout}" method="post" id="logout-btn-desktop" style="display: none; margin: 0;">
          <button type="submit" class="btn btn-ghost btn-sm text-red-500 hover:bg-red-50">
            <i class="fa-solid fa-right-from-bracket"></i>
            로그아웃
          </button>
        </form>
      </div>

      <!-- Mobile Menu -->
      <div class="lg:hidden flex items-center gap-1">
        <!-- 모바일 다크모드 토글 (dropdown 외부) -->
        <label class="swap swap-rotate cursor-pointer p-2">
          <input type="checkbox" class="theme-controller" value="dark" id="theme-toggle-mobile" />
          <svg class="swap-off h-6 w-6 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M5.64,17l-.71.71a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0l.71-.71A1,1,0,0,0,5.64,17ZM5,12a1,1,0,0,0-1-1H3a1,1,0,0,0,0,2H4A1,1,0,0,0,5,12Zm7-7a1,1,0,0,0,1-1V3a1,1,0,0,0-2,0V4A1,1,0,0,0,12,5ZM5.64,7.05a1,1,0,0,0,.7.29,1,1,0,0,0,.71-.29,1,1,0,0,0,0-1.41l-.71-.71A1,1,0,0,0,4.93,6.34Zm12,.29a1,1,0,0,0,.7-.29l.71-.71a1,1,0,1,0-1.41-1.41L17,5.64a1,1,0,0,0,0,1.41A1,1,0,0,0,17.66,7.34ZM21,11H20a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm-9,8a1,1,0,0,0-1,1v1a1,1,0,0,0,2,0V20A1,1,0,0,0,12,19ZM18.36,17A1,1,0,0,0,17,18.36l.71.71a1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41ZM12,6.5A5.5,5.5,0,1,0,17.5,12,5.51,5.51,0,0,0,12,6.5Zm0,9A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"/>
          </svg>
          <svg class="swap-on h-6 w-6 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z"/>
          </svg>
        </label>

        <!-- 로그인 버튼 (초기 숨김) -->
        <a href="/login" id="login-btn-mobile" class="btn btn-primary btn-sm btn-circle" style="display: none;">
          <i class="fa-solid fa-right-to-bracket"></i>
        </a>

        <!-- 햄버거 메뉴 dropdown -->
        <div class="dropdown dropdown-end">
          <div tabindex="0" role="button" class="btn btn-ghost btn-circle">
            <i class="fa-solid fa-bars text-xl text-gray-700"></i>
          </div>
          <ul tabindex="0" class="dropdown-content menu bg-white rounded-box shadow-lg z-50 w-64 p-2 mt-3 border border-gray-100">
            <li class="menu-title text-gray-500 text-xs font-semibold px-4 py-2">메뉴</li>
            <li><a href="/profile" class="hover:bg-blue-50 hover:text-blue-600"><i class="fa-solid fa-user w-5"></i>프로필</a></li>
            <li class="divider my-1"></li>
            <li><a href="/dashboard" class="hover:bg-blue-50 hover:text-blue-600"><i class="fa-solid fa-clipboard-list w-5"></i>대시보드</a></li>
            <li><a href="/issue-helper" class="hover:bg-blue-50 hover:text-blue-600"><i class="fa-brands fa-github w-5"></i>깃헙 이슈 도우미</a></li>
            <li><a href="/translator" class="hover:bg-blue-50 hover:text-blue-600"><i class="fa-solid fa-language w-5"></i>커스텀 AI 번역기</a></li>
            <li><a href="/notice-management" class="hover:bg-blue-50 hover:text-blue-600"><i class="fa-solid fa-bullhorn w-5"></i>공지사항 관리</a></li>
            <li><a href="/docker-logs" class="hover:bg-blue-50 hover:text-blue-600"><i class="fa-solid fa-terminal w-5"></i>컨테이너 로그</a></li>
            <li><a href="/study-management" class="hover:bg-blue-50 hover:text-blue-600"><i class="fa-solid fa-book w-5"></i>스터디 플랜</a></li>
            <li><a href="/grass" class="hover:bg-blue-50 hover:text-blue-600"><i class="fa-solid fa-leaf w-5"></i>Grass Planter</a></li>
            <li><a href="/ai-server" class="hover:bg-blue-50 hover:text-blue-600"><i class="fa-solid fa-server w-5"></i>AI 서버 관리</a></li>
            <li><a href="/chatbot-management" class="hover:bg-blue-50 hover:text-blue-600"><i class="fa-solid fa-database w-5"></i>챗봇 문서 관리</a></li>
            <li class="divider my-1"></li>

            <!-- 로그아웃 버튼 (초기 숨김) -->
            <li id="logout-btn-mobile" style="display: none;">
              <form th:action="@{/logout}" method="post" class="w-full" style="margin: 0;">
                <button type="submit" class="text-red-500 hover:bg-red-50 w-full text-left flex items-center gap-2">
                  <i class="fa-solid fa-right-from-bracket w-5"></i>
                  로그아웃
                </button>
              </form>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  <!-- 헤더 아래 여백 -->
  <div class="h-16"></div>

  <!-- Changelog 모달 (모든 페이지에서 사용 가능) -->
  <dialog id="changelog-modal" class="modal">
    <div class="modal-box max-w-lg bg-base-100">
      <!-- 모달 헤더 -->
      <div class="flex items-start gap-4 mb-4">
        <div class="w-12 h-12 bg-primary/10 rounded-xl flex items-center justify-center flex-shrink-0">
          <i class="fa-solid fa-tag text-primary text-xl"></i>
        </div>
        <div class="flex-1">
          <h3 class="font-bold text-lg">Changelog</h3>
          <p class="text-sm text-gray-500">SUH Project Utility</p>
        </div>
        <form method="dialog">
          <button class="btn btn-sm btn-circle btn-ghost">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </form>
      </div>

      <!-- 최신 버전 정보 -->
      <div id="changelog-content" class="space-y-4">
        <!-- 로딩 스켈레톤 -->
        <div id="changelog-loading" class="space-y-3">
          <div class="skeleton h-6 w-32"></div>
          <div class="skeleton h-4 w-full"></div>
          <div class="skeleton h-4 w-3/4"></div>
          <div class="skeleton h-4 w-5/6"></div>
        </div>

        <!-- 실제 컨텐츠 (JS로 채움) -->
        <div id="changelog-data" class="hidden">
          <!-- 버전 헤더 -->
          <div class="flex items-center gap-2 mb-3">
            <span id="changelog-version" class="font-bold text-lg">v1.4.6</span>
            <span class="badge badge-soft badge-success text-xs">Latest</span>
            <span id="changelog-date" class="text-sm text-gray-500">2025-12-13</span>
          </div>

          <!-- 변경사항 목록 -->
          <ul id="changelog-items" class="space-y-2 text-sm text-gray-700">
            <!-- JS로 채워짐 -->
          </ul>
        </div>
      </div>

      <!-- 모달 푸터 -->
      <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200">
        <span id="changelog-updated" class="text-xs text-gray-400">Last updated: -</span>
        <a href="https://github.com/Cassiiopeia/suh-project-utility/blob/main/CHANGELOG.md"
           target="_blank"
           class="text-sm text-primary hover:underline flex items-center gap-1">
          View on GitHub
          <i class="fa-solid fa-arrow-right text-xs"></i>
        </a>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <!-- Changelog 관련 JavaScript -->
  <script th:inline="javascript">
    // 헤더 버전 정보 로드 (페이지 로드 시)
    document.addEventListener('DOMContentLoaded', function() {
      loadHeaderVersion();
    });

    function loadHeaderVersion() {
      fetch('https://raw.githubusercontent.com/Cassiiopeia/suh-project-utility/main/CHANGELOG.json')
        .then(response => response.json())
        .then(data => {
          const versionTag = document.getElementById('header-version-tag');
          if (versionTag && data.metadata && data.metadata.currentVersion) {
            versionTag.textContent = 'v' + data.metadata.currentVersion;
          }
        })
        .catch(error => console.error('헤더 버전 정보 로드 실패:', error));
    }

    // Changelog 모달 열기
    function openChangelogModal() {
      const modal = document.getElementById('changelog-modal');
      if (modal) {
        modal.showModal();
        loadChangelog();
      }
    }

    // Changelog 데이터 로드
    function loadChangelog() {
      const loadingEl = document.getElementById('changelog-loading');
      const dataEl = document.getElementById('changelog-data');

      // 이미 로드된 경우 스킵
      if (!dataEl.classList.contains('hidden')) return;

      // GitHub raw URL에서 CHANGELOG.json 가져오기
      fetch('https://raw.githubusercontent.com/Cassiiopeia/suh-project-utility/main/CHANGELOG.json')
        .then(response => response.json())
        .then(data => {
          renderChangelog(data);
          loadingEl.classList.add('hidden');
          dataEl.classList.remove('hidden');
        })
        .catch(error => {
          console.error('Changelog 로드 실패:', error);
          loadingEl.innerHTML = `
            <div class="text-center text-gray-500">
              <i class="fa-solid fa-circle-exclamation text-2xl mb-2"></i>
              <p>변경 이력을 불러올 수 없습니다.</p>
            </div>
          `;
        });
    }

    // Changelog 데이터 렌더링
    function renderChangelog(data) {
      const latestRelease = data.releases[0];
      const metadata = data.metadata;

      // 버전 정보
      document.getElementById('changelog-version').textContent = 'v' + latestRelease.version;
      document.getElementById('changelog-date').textContent = latestRelease.date;

      // 마지막 업데이트
      const lastUpdated = new Date(metadata.lastUpdated);
      document.getElementById('changelog-updated').textContent =
        'Last updated: ' + lastUpdated.toLocaleDateString('ko-KR');

      // 변경사항 목록
      const itemsEl = document.getElementById('changelog-items');
      itemsEl.innerHTML = '';

      // parsed_changes에서 아이템 추출
      const changes = latestRelease.parsed_changes;
      for (const category in changes) {
        const categoryData = changes[category];
        if (categoryData.items && categoryData.items.length > 0) {
          categoryData.items.forEach(item => {
            const li = document.createElement('li');
            li.className = 'flex items-start gap-2';
            li.innerHTML = `
              <span class="text-primary mt-1">•</span>
              <span>${item}</span>
            `;
            itemsEl.appendChild(li);
          });
        }
      }
    }
  </script>
</div>
