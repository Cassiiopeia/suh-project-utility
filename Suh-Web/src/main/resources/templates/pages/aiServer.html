<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head th:replace="~{fragments/header :: head(title='AI 서버 관리-SAECHAN-LAB')}"></head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="ui container" id="main-content">

  <!-- 페이지 헤더 -->
  <div class="ui segment">
    <h3 class="dashboard-section-header">AI 서버 관리</h3>
    <p class="dashboard-section-description">Ollama AI 서버 상태 및 모델 관리</p>
  </div>

  <!-- 서버 상태 -->
  <div class="ui segment">
    <h4 class="ui header">
      <i class="server icon"></i>
      <div class="content">
        서버 상태
        <div class="sub header" id="serverStatus">
          <div class="ui active inline loader mini"></div>
          확인 중...
        </div>
      </div>
    </h4>
    <div class="ui labeled input fluid">
      <div class="ui label">서버 URL</div>
      <input type="text" value="https://ai.suhsaechan.kr" readonly>
    </div>
  </div>

  <!-- 모델 관리 -->
  <div class="ui segment">
    <h4 class="ui header">
      <i class="database icon"></i>
      <div class="content">
        모델 관리
        <div class="sub header">모델 다운로드 및 삭제</div>
      </div>
    </h4>

    <!-- 모델 다운로드 폼 -->
    <div class="ui form" style="margin-bottom: 2rem;">
      <div class="field">
        <label>새 모델 다운로드</label>
        <div class="ui action input">
          <input type="text" id="modelNameInput" placeholder="예: llama3.2:3b, qwen2.5:3b">
          <button class="ui primary button" id="downloadModelBtn">
            <i class="download icon"></i> 다운로드
          </button>
        </div>
        <small style="color: #6b7280;">모델명:태그 형식으로 입력하세요 (예: llama3.2:3b)</small>
      </div>
    </div>

    <!-- 모델 목록 테이블 -->
    <h5 class="ui dividing header">설치된 모델</h5>
    <table class="ui celled table" id="modelsTable">
      <thead>
        <tr>
          <th>모델 이름</th>
          <th>크기</th>
          <th>수정일</th>
          <th width="100">작업</th>
        </tr>
      </thead>
      <tbody id="modelsTableBody">
        <tr>
          <td colspan="4" class="center aligned">
            <div class="ui active inline loader"></div>
            모델 목록을 불러오는 중...
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- API 테스트 섹션 -->
  <div class="ui segment">
    <h4 class="ui header">
      <i class="code icon"></i>
      <div class="content">
        API 테스트
        <div class="sub header">텍스트 생성 및 임베딩 테스트</div>
      </div>
    </h4>

    <div class="ui two column stackable grid">
      <!-- 모델 선택 -->
      <div class="column">
        <div class="ui form">
          <div class="field">
            <label>모델 선택</label>
            <div class="ui fluid selection dropdown" id="modelDropdown">
              <input type="hidden" name="selectedModel" id="modelSelect">
              <i class="dropdown icon"></i>
              <div class="default text">모델을 선택하세요</div>
              <div class="menu" id="modelMenu">
                <div class="item">
                  <div class="ui active inline loader mini"></div>
                  모델 목록을 불러오는 중...
                </div>
              </div>
            </div>
          </div>

          <!-- 모델 정보 -->
          <div id="modelInfo" style="display: none; margin-top: 1rem;">
            <div class="ui small message">
              <div class="header">모델 정보</div>
              <ul class="list">
                <li>크기: <strong id="modelSize">-</strong></li>
                <li>패밀리: <strong id="modelFamily">-</strong></li>
                <li>파라미터: <strong id="modelParams">-</strong></li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- API 설정 -->
      <div class="column">
        <div class="ui form">
          <div class="field">
            <label>입력 텍스트</label>
            <textarea id="inputText" placeholder="프롬프트를 여기에 입력하세요" rows="5"></textarea>
          </div>
          <button class="ui blue fluid button" id="runApiTestBtn">
            <i class="play icon"></i>
            API 호출 테스트
          </button>
        </div>
      </div>
    </div>

    <!-- API 응답 결과 -->
    <div id="responseSection" style="display: none; margin-top: 2rem;">
      <h5 class="ui dividing header">API 응답 결과</h5>
      <div class="ui message">
        <div class="header">응답 정보</div>
        <p>
          상태 코드: <strong id="statusCode">-</strong> |
          응답 시간: <strong id="responseTime">-</strong> |
          호출 시간: <strong id="callTime">-</strong>
        </p>
      </div>
      <div class="ui segment">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <strong>응답 데이터</strong>
          <button class="ui mini button" id="copyResponseBtn">
            <i class="copy icon"></i> 복사
          </button>
        </div>
        <pre id="responseJson" style="background: #f4f4f4; padding: 1rem; border-radius: 4px; overflow-x: auto; max-height: 400px;"></pre>
      </div>
    </div>
  </div>

</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<!-- AI 서버 관리 전용 스크립트 -->
<script>
// 전역 변수
let availableModels = [];

$(document).ready(function() {
    console.log('AI 서버 페이지 로드');

    // 초기 로드
    checkServerHealth();
    loadModelsList();

    // 버튼 이벤트
    $('#downloadModelBtn').click(downloadModel);
    $('#runApiTestBtn').click(runApiTest);
    $('#copyResponseBtn').click(copyResponseToClipboard);

    // 모델 드롭다운 초기화
    $('#modelDropdown').dropdown({
        onChange: function(value, text, $selectedItem) {
            console.log('모델 선택됨:', value);
            showModelInfo(value);
        }
    });
});

// Health Check
function checkServerHealth() {
    console.log('서버 Health Check 시작');

    const formData = new FormData();

    $.ajax({
        url: '/api/ai-server/health',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            console.log('Health Check 성공:', response);
            if (response.isHealthy) {
                $('#serverStatus').html('<i class="green check circle icon"></i> 정상 작동 중');
            } else {
                $('#serverStatus').html('<i class="yellow warning icon"></i> ' + (response.healthMessage || '상태 불명'));
            }
        },
        error: function(xhr, status, error) {
            console.error('Health Check 실패:', xhr, status, error);
            $('#serverStatus').html('<i class="red times circle icon"></i> 연결 실패');
        }
    });
}

// 모델 목록 로드
function loadModelsList() {
    console.log('모델 목록 로드 시작');

    const formData = new FormData();
    const tbody = $('#modelsTableBody');

    tbody.html('<tr><td colspan="4" class="center aligned"><div class="ui active inline loader"></div> 로딩 중...</td></tr>');

    $.ajax({
        url: '/api/ai-server/models',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            console.log('모델 목록 응답:', response);

            if (response.modelsJson) {
                try {
                    const data = JSON.parse(response.modelsJson);
                    if (data.models && data.models.length > 0) {
                        availableModels = data.models;
                        renderModelsTable(data.models);
                        updateModelDropdown(data.models);
                    } else {
                        tbody.html('<tr><td colspan="4" class="center aligned">설치된 모델이 없습니다</td></tr>');
                    }
                } catch (e) {
                    console.error('JSON 파싱 오류:', e);
                    tbody.html('<tr><td colspan="4" class="center aligned error">응답 파싱 실패</td></tr>');
                }
            } else {
                tbody.html('<tr><td colspan="4" class="center aligned">모델 목록이 비어있습니다</td></tr>');
            }
        },
        error: function(xhr, status, error) {
            console.error('모델 목록 로드 실패:', xhr, status, error);
            tbody.html('<tr><td colspan="4" class="center aligned error">모델 목록 로드 실패</td></tr>');
        }
    });
}

// 모델 목록 테이블 렌더링
function renderModelsTable(models) {
    const tbody = $('#modelsTableBody');

    if (!models || models.length === 0) {
        tbody.html('<tr><td colspan="4" class="center aligned">설치된 모델이 없습니다</td></tr>');
        return;
    }

    let html = '';
    models.forEach(function(model) {
        const size = formatModelSize(model.size);
        const date = formatDate(model.modified_at);
        const name = escapeHtml(model.name);

        html += `
            <tr>
                <td><strong>${name}</strong></td>
                <td>${size}</td>
                <td>${date}</td>
                <td>
                    <button class="ui mini red button" onclick="deleteModel('${name}')">
                        <i class="trash icon"></i> 삭제
                    </button>
                </td>
            </tr>
        `;
    });
    tbody.html(html);
}

// 모델 드롭다운 업데이트
function updateModelDropdown(models) {
    const menu = $('#modelMenu');
    menu.empty();

    if (!models || models.length === 0) {
        menu.html('<div class="item disabled">사용 가능한 모델이 없습니다</div>');
        return;
    }

    models.forEach(function(model) {
        const size = formatModelSize(model.size);
        const family = model.details?.family || 'unknown';

        const item = $(`
            <div class="item" data-value="${model.name}">
                <div class="content">
                    <div class="header">${model.name}</div>
                    <div class="description">
                        <small>${size} | ${family}</small>
                    </div>
                </div>
            </div>
        `);
        menu.append(item);
    });
}

// 모델 정보 표시
function showModelInfo(modelName) {
    const model = availableModels.find(m => m.name === modelName);
    if (!model) return;

    $('#modelSize').text(formatModelSize(model.size));
    $('#modelFamily').text(model.details?.family || '-');
    $('#modelParams').text(model.details?.parameter_size || '-');
    $('#modelInfo').show();
}

// 모델 다운로드
function downloadModel() {
    const modelName = $('#modelNameInput').val().trim();

    if (!modelName) {
        alert('모델 이름을 입력하세요');
        return;
    }

    if (!confirm(`"${modelName}" 모델을 다운로드하시겠습니까?\n\n모델 크기에 따라 시간이 오래 걸릴 수 있습니다.`)) {
        return;
    }

    const formData = new FormData();
    formData.append('modelName', modelName);

    const btn = $('#downloadModelBtn');
    btn.addClass('loading disabled');

    $.ajax({
        url: '/api/ai-server/models/pull',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            console.log('모델 다운로드 성공:', response);
            alert(`모델 다운로드가 시작되었습니다: ${modelName}\n\n백그라운드에서 다운로드가 진행됩니다.`);
            $('#modelNameInput').val('');

            // 5초 후 모델 목록 새로고침
            setTimeout(function() {
                loadModelsList();
            }, 5000);
        },
        error: function(xhr, status, error) {
            console.error('모델 다운로드 실패:', xhr, status, error);
            const message = xhr.responseJSON?.message || '다운로드 실패';
            alert('다운로드 오류: ' + message);
        },
        complete: function() {
            btn.removeClass('loading disabled');
        }
    });
}

// 모델 삭제
function deleteModel(modelName) {
    if (!confirm(`"${modelName}" 모델을 삭제하시겠습니까?`)) {
        return;
    }

    const formData = new FormData();
    formData.append('modelName', modelName);

    $.ajax({
        url: '/api/ai-server/models/delete',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            console.log('모델 삭제 성공:', response);
            alert('모델이 삭제되었습니다');
            loadModelsList();
        },
        error: function(xhr, status, error) {
            console.error('모델 삭제 실패:', xhr, status, error);
            const message = xhr.responseJSON?.message || '삭제 실패';
            alert('삭제 오류: ' + message);
        }
    });
}

// API 테스트 실행
function runApiTest() {
    console.log('API 테스트 시작');

    const selectedModel = $('#modelSelect').val();
    const inputText = $('#inputText').val().trim();

    if (!selectedModel) {
        alert('모델을 선택해주세요');
        return;
    }

    if (!inputText) {
        alert('입력 텍스트를 입력해주세요');
        return;
    }

    const testBtn = $('#runApiTestBtn');
    testBtn.addClass('loading disabled');

    const startTime = Date.now();

    const formData = new FormData();
    formData.append('model', selectedModel);
    formData.append('prompt', inputText);
    formData.append('stream', 'false');

    $.ajax({
        url: '/api/ai-server/generate',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            const endTime = Date.now();
            const responseTime = endTime - startTime;

            console.log('API 테스트 성공:', response);

            let generateResponse;
            if (response.generatedJson) {
                try {
                    generateResponse = JSON.parse(response.generatedJson);
                } catch (e) {
                    console.error('응답 파싱 오류:', e);
                    generateResponse = { error: '응답 파싱 오류', raw: response.generatedJson };
                }
            } else {
                generateResponse = { error: 'generate 응답이 없습니다' };
            }

            showApiResponse(generateResponse, 200, responseTime, selectedModel, inputText);
        },
        error: function(xhr, status, error) {
            const endTime = Date.now();
            const responseTime = endTime - startTime;

            console.error('API 테스트 오류:', xhr, status, error);

            let errorResponse;
            try {
                errorResponse = JSON.parse(xhr.responseText);
            } catch (e) {
                errorResponse = { error: error, status: xhr.status };
            }

            showApiResponse(errorResponse, xhr.status, responseTime, selectedModel, inputText);
        },
        complete: function() {
            testBtn.removeClass('loading disabled');
        }
    });
}

// API 응답 표시
function showApiResponse(response, statusCode, responseTime, model, input) {
    console.log('API 응답 표시:', response);

    $('#statusCode').text(statusCode);
    $('#responseTime').text(responseTime + 'ms');
    $('#callTime').text(new Date().toLocaleString());

    const formattedJson = JSON.stringify(response, null, 2);
    $('#responseJson').text(formattedJson);

    $('#responseSection').show();

    // 응답 섹션으로 스크롤
    $('#responseSection')[0].scrollIntoView({ behavior: 'smooth' });
}

// 응답 복사
function copyResponseToClipboard() {
    const responseText = $('#responseJson').text();

    if (navigator.clipboard) {
        navigator.clipboard.writeText(responseText).then(function() {
            const btn = $('#copyResponseBtn');
            const originalHtml = btn.html();
            btn.html('<i class="check icon"></i> 복사됨');

            setTimeout(function() {
                btn.html(originalHtml);
            }, 2000);
        });
    } else {
        const textArea = document.createElement('textarea');
        textArea.value = responseText;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);

        alert('응답이 클립보드에 복사되었습니다');
    }
}

// 유틸리티 함수
function formatModelSize(sizeInBytes) {
    if (!sizeInBytes) return '-';

    const units = ['B', 'KB', 'MB', 'GB'];
    let size = sizeInBytes;
    let unitIndex = 0;

    while (size >= 1024 && unitIndex < units.length - 1) {
        size /= 1024;
        unitIndex++;
    }

    return size.toFixed(1) + ' ' + units[unitIndex];
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    try {
        const date = new Date(dateStr);
        return date.toLocaleDateString('ko-KR');
    } catch (e) {
        return dateStr;
    }
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}
</script>

</body>
</html>
