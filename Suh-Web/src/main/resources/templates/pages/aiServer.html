<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head th:replace="~{fragments/header :: head(title='AI 서버 관리-SAECHAN-LAB')}"></head>
<body class="ai-server-page">
<div th:replace="~{fragments/header :: header}"></div>

<div class="ui container" id="main-content">
  <!-- 스켈레톤 로딩 컨테이너 - 페이지 로딩 시 임시 표시 -->
  <div id="skeleton-container">
    <div class="ui segment skeleton">
      <div class="skeleton skeleton-header-large"></div>
      <div class="skeleton skeleton-text-medium"></div>
    </div>
    <div class="ui segment skeleton">
      <div class="skeleton skeleton-text-small"></div>
      <div class="skeleton skeleton-output"></div>
    </div>
  </div>

  <!-- 실제 콘텐츠 - 로딩 후 표시 -->
  <div id="real-content" class="hide">
    <!-- 메인 헤더 -->
    <div class="ui segment">
      <h2 class="ui header">
        <i class="robot icon" style="color:#7b68ee;"></i>
        <div class="content">
          AI 서버 관리
          <div class="sub header">Cloudflare 터널을 통한 AI 서버 상태 관리</div>
        </div>
      </h2>
      
      <!-- 컨트롤 패널 -->
      <div class="ui form">
        <div class="fields">
          <div class="eight wide field">
            <button class="ui primary button" id="refreshBtn">
              <i class="refresh icon"></i>정보 새로고침
            </button>
            <button class="ui teal button" id="testConnectionBtn">
              <i class="plug icon"></i>연결 테스트
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 서버 상태 정보 -->
    <div class="ui stackable grid">
      <!-- 상태 개요 -->
      <div class="eight wide column">
        <div class="ui segment">
          <h3 class="ui header">
            <i class="server icon"></i>
            <div class="content">서버 상태</div>
          </h3>
          
          <div class="ui statistics">
            <div class="statistic">
              <div class="value" id="serverStatus">
                <i class="circle notched loading icon"></i>
              </div>
              <div class="label">상태</div>
            </div>
          </div>
          
          <div class="ui divider"></div>
          
          <div class="ui relaxed divided list">
            <div class="item">
              <i class="clock icon"></i>
              <div class="content">
                <div class="header">마지막 업데이트</div>
                <div class="description" id="lastUpdate">확인 중...</div>
              </div>
            </div>
            <div class="item">
              <i class="linkify icon"></i>
              <div class="content">
                <div class="header">터널 URL</div>
                <div class="description" id="tunnelUrl">확인 중...</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 서비스 정보 -->
      <div class="eight wide column">
        <div class="ui segment">
          <h3 class="ui header">
            <i class="cog icon"></i>
            <div class="content">서비스 정보</div>
          </h3>
          
          <div class="ui relaxed divided list" id="serviceInfo">
            <div class="item">
              <i class="circle notched loading icon"></i>
              <div class="content">
                <div class="description">서비스 정보를 불러오는 중...</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 엔드포인트 정보 -->
    <div class="ui segment">
      <h3 class="ui header">
        <i class="sitemap icon"></i>
        <div class="content">API 엔드포인트</div>
      </h3>
      
      <div class="ui stackable four column grid" id="endpointsInfo">
        <div class="column">
          <div class="ui card">
            <div class="content">
              <div class="header">로딩 중...</div>
              <div class="description">엔드포인트 정보를 불러오는 중입니다.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 로그 영역 -->
    <div class="ui segment">
      <h3 class="ui header">
        <i class="file alternate outline icon"></i>
        <div class="content">활동 로그</div>
      </h3>
      
      <div class="ui fluid card">
        <div class="content">
          <div class="ui comments" id="activityLog">
            <div class="comment">
              <div class="content">
                <div class="author">시스템</div>
                <div class="metadata">
                  <div class="date">방금 전</div>
                </div>
                <div class="text">AI 서버 관리 페이지가 로드되었습니다.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<!-- AI 서버 관리 전용 스크립트 -->
<script>
$(document).ready(function() {
    // 초기화
    initAiServerPage();
    
    // 새로고침 버튼 이벤트
    $('#refreshBtn').click(function() {
        loadTunnelInfo();
    });
    
    // 연결 테스트 버튼 이벤트
    $('#testConnectionBtn').click(function() {
        testConnection();
    });
    
    // 5분마다 자동 새로고침
    setInterval(function() {
        loadTunnelInfo();
    }, 300000); // 5분 = 300,000ms
});

function initAiServerPage() {
    // 스켈레톤 숨기고 실제 콘텐츠 표시
    setTimeout(function() {
        $('#skeleton-container').hide();
        $('#real-content').show();
        loadTunnelInfo();
    }, 500);
}

function loadTunnelInfo() {
    addLog('터널 정보를 조회하는 중...');
    
    $.ajax({
        url: '/api/ai-server/tunnel-info',
        method: 'GET',
        success: function(response) {
            if (response.success && response.data) {
                updateUI(response.data);
                addLog('터널 정보 조회 완료');
            } else {
                showError('터널 정보 조회 실패: ' + response.message);
                addLog('터널 정보 조회 실패: ' + response.message, 'error');
            }
        },
        error: function(xhr, status, error) {
            showError('서버 통신 오류: ' + error);
            addLog('서버 통신 오류: ' + error, 'error');
        }
    });
}

function updateUI(data) {
    // 서버 상태 업데이트
    const isActive = data.status === 'active';
    $('#serverStatus').html(
        isActive 
            ? '<i class="check circle icon green"></i>활성' 
            : '<i class="times circle icon red"></i>비활성'
    );
    
    // 마지막 업데이트 시간
    $('#lastUpdate').text(data.timestamp || '알 수 없음');
    
    // 터널 URL
    const urlElement = $('#tunnelUrl');
    if (data.url) {
        urlElement.html(`<a href="${data.url}" target="_blank">${data.url}</a>`);
    } else {
        urlElement.text('사용 가능한 URL이 없습니다');
    }
    
    // 서비스 정보 업데이트
    updateServiceInfo(data.service_info);
    
    // 엔드포인트 정보 업데이트
    updateEndpoints(data.endpoints);
}

function updateServiceInfo(serviceInfo) {
    const container = $('#serviceInfo');
    container.empty();
    
    if (serviceInfo) {
        container.append(`
            <div class="item">
                <i class="tag icon"></i>
                <div class="content">
                    <div class="header">서비스명</div>
                    <div class="description">${serviceInfo.name || '알 수 없음'}</div>
                </div>
            </div>
            <div class="item">
                <i class="code branch icon"></i>
                <div class="content">
                    <div class="header">버전</div>
                    <div class="description">${serviceInfo.version || '알 수 없음'}</div>
                </div>
            </div>
            <div class="item">
                <i class="plug icon"></i>
                <div class="content">
                    <div class="header">프록시 포트</div>
                    <div class="description">${serviceInfo.proxy_port || '알 수 없음'}</div>
                </div>
            </div>
            <div class="item">
                <i class="target icon"></i>
                <div class="content">
                    <div class="header">타겟 포트</div>
                    <div class="description">${serviceInfo.target_port || '알 수 없음'}</div>
                </div>
            </div>
        `);
    } else {
        container.append(`
            <div class="item">
                <i class="question circle icon"></i>
                <div class="content">
                    <div class="description">서비스 정보를 사용할 수 없습니다</div>
                </div>
            </div>
        `);
    }
}

function updateEndpoints(endpoints) {
    const container = $('#endpointsInfo');
    container.empty();
    
    if (endpoints) {
        const endpointList = [
            { name: 'Health Check', url: endpoints.health, icon: 'heartbeat' },
            { name: 'Info', url: endpoints.info, icon: 'info circle' },
            { name: 'Tunnel Info', url: endpoints.tunnel_info, icon: 'sitemap' },
            { name: 'Test', url: endpoints.test, icon: 'lab' }
        ];
        
        endpointList.forEach(endpoint => {
            if (endpoint.url) {
                container.append(`
                    <div class="column">
                        <div class="ui card">
                            <div class="content">
                                <div class="header">
                                    <i class="${endpoint.icon} icon"></i>
                                    ${endpoint.name}
                                </div>
                                <div class="description">
                                    <a href="${endpoint.url}" target="_blank" class="ui small button">
                                        <i class="external alternate icon"></i>
                                        접속
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `);
            }
        });
    } else {
        container.append(`
            <div class="column">
                <div class="ui card">
                    <div class="content">
                        <div class="header">정보 없음</div>
                        <div class="description">엔드포인트 정보를 사용할 수 없습니다.</div>
                    </div>
                </div>
            </div>
        `);
    }
}

function testConnection() {
    addLog('연결 테스트를 시작합니다...');
    
    $.ajax({
        url: '/api/ai-server/status',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                if (response.data) {
                    showSuccess('연결 테스트 성공: AI 서버가 정상적으로 작동 중입니다');
                    addLog('연결 테스트 성공', 'success');
                } else {
                    showWarning('AI 서버가 비활성화되어 있습니다');
                    addLog('AI 서버 비활성화 상태', 'warning');
                }
            } else {
                showError('연결 테스트 실패: ' + response.message);
                addLog('연결 테스트 실패: ' + response.message, 'error');
            }
        },
        error: function(xhr, status, error) {
            showError('연결 테스트 오류: ' + error);
            addLog('연결 테스트 오류: ' + error, 'error');
        }
    });
}

function addLog(message, type = 'info') {
    const logContainer = $('#activityLog');
    const now = new Date();
    const timeStr = now.toLocaleTimeString('ko-KR');
    
    let iconClass = 'info circle';
    let colorClass = '';
    
    switch(type) {
        case 'success':
            iconClass = 'check circle';
            colorClass = 'green';
            break;
        case 'error':
            iconClass = 'times circle';
            colorClass = 'red';
            break;
        case 'warning':
            iconClass = 'exclamation triangle';
            colorClass = 'orange';
            break;
    }
    
    logContainer.prepend(`
        <div class="comment">
            <div class="content">
                <div class="author ${colorClass}">
                    <i class="${iconClass} icon"></i>
                    시스템
                </div>
                <div class="metadata">
                    <div class="date">${timeStr}</div>
                </div>
                <div class="text">${message}</div>
            </div>
        </div>
    `);
    
    // 로그가 너무 많아지면 오래된 것 삭제
    const comments = logContainer.find('.comment');
    if (comments.length > 20) {
        comments.slice(20).remove();
    }
}

function showSuccess(message) {
    $('body').toast({
        class: 'success',
        message: message,
        position: 'top right'
    });
}

function showError(message) {
    $('body').toast({
        class: 'error',
        message: message,
        position: 'top right'
    });
}

function showWarning(message) {
    $('body').toast({
        class: 'warning',
        message: message,
        position: 'top right'
    });
}
</script>

</body>
</html>
