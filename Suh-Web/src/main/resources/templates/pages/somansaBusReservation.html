<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head(title='소만사 버스 예약 - 자동 예약 관리')}"></head>
<body class="somansa-bus-page bg-gray-50">
<div th:replace="~{fragments/header :: header}"></div>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" id="main-content">
  <div class="mb-6">
    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
      <i class="fa-solid fa-bus text-blue-500"></i>
      소만사 버스 예약
    </h2>
    <p class="text-gray-500 mt-1">통근버스 자동 예약 관리 시스템</p>
  </div>

  <div class="card bg-base-100 shadow-sm border border-gray-100 mb-6">
    <div class="card-body">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
        <div>
          <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
            <i class="fa-solid fa-users text-blue-500"></i>
            사용자 목록
          </h3>
          <p class="text-gray-500 text-sm">등록된 버스 예약 사용자 관리</p>
        </div>
        <button class="btn btn-primary w-auto" onclick="showAddUserModal()">
          <i class="fa-solid fa-plus"></i>
          사용자 추가
        </button>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4" id="userCardContainer">
        <div th:each="user : ${users}" class="card bg-base-100 border border-gray-200 hover:shadow-md transition-shadow">
          <div class="card-body p-4">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-2">
                <i class="fa-solid fa-user text-xl text-gray-700"></i>
                <span class="font-semibold text-gray-800" th:text="${user.displayName}">username</span>
              </div>
              <div th:if="${user.isActive}" class="badge badge-success badge-sm">활성</div>
              <div th:unless="${user.isActive}" class="badge badge-ghost badge-sm">비활성</div>
            </div>

            <div class="text-sm text-gray-500 mb-3" th:text="${user.loginId}">email@somansa.com</div>

            <div class="space-y-2 mb-4">
              <div class="flex items-center gap-2 text-sm text-gray-600">
                <i class="fa-solid fa-check-circle text-green-500" th:if="${user.isVerified}"></i>
                <i class="fa-solid fa-times-circle text-red-500" th:unless="${user.isVerified}"></i>
                <span th:text="${user.isVerified ? '인증됨' : '미인증'}">인증됨</span>
              </div>
            </div>

            <div class="flex gap-2 justify-end">
              <button class="btn btn-circle btn-sm btn-info"
                      th:data-user-id="${user.somansaBusUserId}"
                      onclick="showScheduleModal(this.getAttribute('data-user-id'))"
                      title="스케줄 관리">
                <i class="fa-solid fa-calendar text-xs"></i>
              </button>
              <button class="btn btn-circle btn-sm btn-warning"
                      th:data-user-id="${user.somansaBusUserId}"
                      onclick="toggleUserActive(this.getAttribute('data-user-id'))"
                      title="활성화 토글">
                <i class="fa-solid fa-toggle-on text-xs"></i>
              </button>
              <button class="btn btn-circle btn-sm btn-error"
                      th:data-user-id="${user.somansaBusUserId}"
                      onclick="deleteUser(this.getAttribute('data-user-id'))"
                      title="사용자 삭제">
                <i class="fa-solid fa-trash text-xs"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card bg-base-100 shadow-sm border border-gray-100 mb-6">
    <div class="card-body">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
        <div>
          <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
            <i class="fa-solid fa-route text-blue-500"></i>
            버스 노선
          </h3>
          <p class="text-gray-500 text-sm">등록된 버스 노선 목록</p>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="table table-zebra">
          <thead>
            <tr>
              <th>구분</th>
              <th>출발시간</th>
              <th>정류장</th>
              <th>호차</th>
              <th>설명</th>
            </tr>
          </thead>
          <tbody id="routeTable">
            <tr th:each="route : ${routes}">
              <td>
                <span th:if="${route.caralias == '출근'}" class="badge badge-soft badge-info badge-sm">출근</span>
                <span th:if="${route.caralias == '퇴근'}" class="badge badge-soft badge-warning badge-sm">퇴근</span>
              </td>
              <td th:text="${route.departureTime}">06:55</td>
              <td th:text="${route.station}">당산역</td>
              <td th:text="${route.busNumber + '호'}">1호</td>
              <td th:text="${route.description}">06:55 당산역 1호 - 출근</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card bg-base-100 shadow-sm border border-gray-100">
    <div class="card-body">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
        <div>
          <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
            <i class="fa-solid fa-clock-rotate-left text-blue-500"></i>
            예약 기록
          </h3>
          <p class="text-gray-500 text-sm">최근 예약 실행 기록</p>
        </div>
        <button class="btn btn-outline btn-sm" onclick="loadReservationHistory()">
          <i class="fa-solid fa-rotate"></i>
          새로고침
        </button>
      </div>

      <div class="overflow-x-auto">
        <table class="table table-zebra">
          <thead>
            <tr>
              <th>시간</th>
              <th>사용자</th>
              <th>노선</th>
              <th>예약일</th>
              <th>상태</th>
            </tr>
          </thead>
          <tbody id="historyTable">
            <tr>
              <td colspan="5" class="text-center py-8">
                <span class="loading loading-spinner loading-md text-primary"></span>
                <span class="ml-2 text-gray-500">기록 로딩 중...</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <dialog class="modal" id="userModal">
    <div class="modal-box max-w-md">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </form>
      <h3 class="font-bold text-lg flex items-center gap-2 mb-6">
        <i class="fa-solid fa-user-plus text-blue-500"></i>
        사용자 등록
      </h3>
      <form id="userForm" class="space-y-4">
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">소만사 이메일</span>
          </label>
          <input type="email" id="loginId" name="loginId"
                 class="input w-full" placeholder="예: hong@somansa.com" required>
          <label class="label">
            <span class="label-text-alt text-gray-500">소만사 이메일로 인증됩니다</span>
          </label>
        </div>
      </form>
      <div class="modal-action">
        <form method="dialog">
          <button class="btn btn-ghost">취소</button>
        </form>
        <button class="btn btn-primary" onclick="registerUser()">
          <i class="fa-solid fa-check"></i>
          등록
        </button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <dialog class="modal" id="scheduleModal">
    <div class="modal-box max-w-2xl">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </form>
      <h3 class="font-bold text-lg flex items-center gap-2 mb-6">
        <i class="fa-solid fa-calendar text-blue-500"></i>
        스케줄 관리
      </h3>
      <input type="hidden" id="scheduleUserId">

      <div class="mb-6">
        <h4 class="font-semibold mb-3">현재 스케줄</h4>
        <div id="currentSchedules" class="space-y-2">
          <p class="text-gray-500 text-sm">등록된 스케줄이 없습니다.</p>
        </div>
      </div>

      <div class="divider"></div>

      <form id="scheduleForm" class="space-y-4">
        <h4 class="font-semibold">새 스케줄 추가</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">노선 선택</span>
            </label>
            <select class="select w-full" id="routeId" name="routeId" required>
              <option value="">노선을 선택하세요</option>
              <option th:each="route : ${routes}"
                      th:value="${route.somansaBusRouteId}"
                      th:text="${route.description}">노선</option>
            </select>
          </div>
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">실행 요일</span>
            </label>
            <div class="flex flex-wrap gap-2">
              <label class="label cursor-pointer gap-1">
                <input type="checkbox" name="dayOfWeek" value="MONDAY" class="checkbox checkbox-sm checkbox-primary">
                <span class="label-text">월</span>
              </label>
              <label class="label cursor-pointer gap-1">
                <input type="checkbox" name="dayOfWeek" value="TUESDAY" class="checkbox checkbox-sm checkbox-primary">
                <span class="label-text">화</span>
              </label>
              <label class="label cursor-pointer gap-1">
                <input type="checkbox" name="dayOfWeek" value="WEDNESDAY" class="checkbox checkbox-sm checkbox-primary">
                <span class="label-text">수</span>
              </label>
              <label class="label cursor-pointer gap-1">
                <input type="checkbox" name="dayOfWeek" value="THURSDAY" class="checkbox checkbox-sm checkbox-primary">
                <span class="label-text">목</span>
              </label>
              <label class="label cursor-pointer gap-1">
                <input type="checkbox" name="dayOfWeek" value="FRIDAY" class="checkbox checkbox-sm checkbox-primary">
                <span class="label-text">금</span>
              </label>
            </div>
          </div>
        </div>
      </form>
      <div class="modal-action">
        <form method="dialog">
          <button class="btn btn-ghost">닫기</button>
        </form>
        <button class="btn btn-primary" onclick="createSchedule()">
          <i class="fa-solid fa-plus"></i>
          스케줄 추가
        </button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <dialog class="modal" id="manualReserveModal">
    <div class="modal-box max-w-md">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </form>
      <h3 class="font-bold text-lg flex items-center gap-2 mb-6">
        <i class="fa-solid fa-ticket text-blue-500"></i>
        수동 예약
      </h3>
      <form id="manualReserveForm" class="space-y-4">
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">사용자</span>
          </label>
          <select class="select w-full" id="manualUserId" name="userId" required>
            <option value="">사용자 선택</option>
            <option th:each="user : ${users}"
                    th:value="${user.somansaBusUserId}"
                    th:text="${user.displayName + ' (' + user.loginId + ')'}">사용자</option>
          </select>
        </div>
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">노선</span>
          </label>
          <select class="select w-full" id="manualRouteId" name="routeId" required>
            <option value="">노선 선택</option>
            <option th:each="route : ${routes}"
                    th:value="${route.somansaBusRouteId}"
                    th:text="${route.description}">노선</option>
          </select>
        </div>
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">예약일</span>
          </label>
          <input type="date" id="reservationDate" name="reservationDate"
                 class="input w-full" required>
        </div>
      </form>
      <div class="modal-action">
        <form method="dialog">
          <button class="btn btn-ghost">취소</button>
        </form>
        <button class="btn btn-primary" onclick="executeManualReserve()">
          <i class="fa-solid fa-ticket"></i>
          예약
        </button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<script>
$(document).ready(function() {
  loadReservationHistory();

  const today = new Date();
  const tomorrow = new Date(today);
  tomorrow.setDate(tomorrow.getDate() + 1);
  $('#reservationDate').val(tomorrow.toISOString().split('T')[0]);
});

function showAddUserModal() {
  $('#userForm')[0].reset();
  document.getElementById('userModal').showModal();
}

function registerUser() {
  const loginId = $('#loginId').val();
  if (!loginId) {
    showToast('이메일을 입력해주세요.', 'negative');
    return;
  }

  sendFormRequest('/api/somansa-bus/user/register', { loginId: loginId },
    function(response) {
      showToast('사용자가 등록되었습니다.', 'positive');
      document.getElementById('userModal').close();
      location.reload();
    },
    function(xhr) {
      let errorMessage = '사용자 등록 중 오류가 발생했습니다.';
      if (xhr.responseJSON && xhr.responseJSON.message) {
        errorMessage = xhr.responseJSON.message;
      }
      showToast(errorMessage, 'negative');
    }
  );
}

function toggleUserActive(userId) {
  sendFormRequest('/api/somansa-bus/user/toggle-active', { somansaBusUserId: userId },
    function(response) {
      showToast('사용자 상태가 변경되었습니다.', 'positive');
      location.reload();
    },
    function(xhr) {
      showToast('상태 변경 중 오류가 발생했습니다.', 'negative');
    }
  );
}

function deleteUser(userId) {
  if (!confirm('정말로 이 사용자를 삭제하시겠습니까?')) {
    return;
  }

  sendFormRequest('/api/somansa-bus/user/delete', { somansaBusUserId: userId },
    function(response) {
      showToast('사용자가 삭제되었습니다.', 'positive');
      location.reload();
    },
    function(xhr) {
      showToast('사용자 삭제 중 오류가 발생했습니다.', 'negative');
    }
  );
}

function showScheduleModal(userId) {
  $('#scheduleUserId').val(userId);
  $('#scheduleForm')[0].reset();
  loadUserSchedules(userId);
  document.getElementById('scheduleModal').showModal();
}

function loadUserSchedules(userId) {
  sendFormRequest('/api/somansa-bus/schedule/list/by-user', { somansaBusUserId: userId },
    function(response) {
      displaySchedules(response.schedules || []);
    },
    function(xhr) {
      $('#currentSchedules').html('<p class="text-red-500 text-sm">스케줄 로드 실패</p>');
    }
  );
}

function displaySchedules(schedules) {
  const container = $('#currentSchedules');

  if (!schedules || schedules.length === 0) {
    container.html('<p class="text-gray-500 text-sm">등록된 스케줄이 없습니다.</p>');
    return;
  }

  container.empty();
  schedules.forEach(function(schedule) {
    const dayText = getDayText(schedule.dayOfWeek);
    const statusBadge = schedule.isActive
      ? '<span class="badge badge-success badge-sm">활성</span>'
      : '<span class="badge badge-ghost badge-sm">비활성</span>';

    const routeDesc = schedule.route ? schedule.route.description : '노선 정보 없음';

    const item = $(`
      <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
        <div class="flex items-center gap-3">
          <span class="badge badge-outline badge-sm">${escapeHtml(dayText)}</span>
          <span class="text-sm">${escapeHtml(routeDesc)}</span>
          ${statusBadge}
        </div>
        <div class="flex gap-2">
          <button class="btn btn-circle btn-sm btn-warning"
                  onclick="toggleScheduleActive('${schedule.somansaBusScheduleId}')"
                  title="활성화 토글">
            <i class="fa-solid fa-toggle-on text-xs"></i>
          </button>
          <button class="btn btn-circle btn-sm btn-error"
                  onclick="deleteSchedule('${schedule.somansaBusScheduleId}')"
                  title="삭제">
            <i class="fa-solid fa-trash text-xs"></i>
          </button>
        </div>
      </div>
    `);
    container.append(item);
  });
}

function getDayText(dayOfWeek) {
  const days = {
    'MONDAY': '월',
    'TUESDAY': '화',
    'WEDNESDAY': '수',
    'THURSDAY': '목',
    'FRIDAY': '금',
    'SATURDAY': '토',
    'SUNDAY': '일'
  };
  return days[dayOfWeek] || dayOfWeek;
}

function createSchedule() {
  const userId = $('#scheduleUserId').val();
  const routeId = $('#routeId').val();
  const checkedDays = $('input[name="dayOfWeek"]:checked').map(function() {
    return this.value;
  }).get();

  if (!routeId) {
    showToast('노선을 선택해주세요.', 'negative');
    return;
  }

  if (checkedDays.length === 0) {
    showToast('실행 요일을 선택해주세요.', 'negative');
    return;
  }

  let successCount = 0;
  let errorCount = 0;
  const totalDays = checkedDays.length;

  checkedDays.forEach(function(day) {
    sendFormRequest('/api/somansa-bus/schedule/create', {
      somansaBusUserId: userId,
      somansaBusRouteId: routeId,
      dayOfWeek: day
    },
    function(response) {
      successCount++;
      if (successCount + errorCount === totalDays) {
        if (errorCount === 0) {
          showToast('스케줄이 추가되었습니다.', 'positive');
        } else {
          showToast(`${successCount}개 성공, ${errorCount}개 실패`, 'warning');
        }
        loadUserSchedules(userId);
        $('#scheduleForm')[0].reset();
      }
    },
    function(xhr) {
      errorCount++;
      if (successCount + errorCount === totalDays) {
        showToast('스케줄 추가 중 일부 오류가 발생했습니다.', 'negative');
        loadUserSchedules(userId);
      }
    });
  });
}

function toggleScheduleActive(scheduleId) {
  const userId = $('#scheduleUserId').val();
  sendFormRequest('/api/somansa-bus/schedule/toggle-active', { somansaBusScheduleId: scheduleId },
    function(response) {
      showToast('스케줄 상태가 변경되었습니다.', 'positive');
      loadUserSchedules(userId);
    },
    function(xhr) {
      showToast('상태 변경 중 오류가 발생했습니다.', 'negative');
    }
  );
}

function deleteSchedule(scheduleId) {
  if (!confirm('정말로 이 스케줄을 삭제하시겠습니까?')) {
    return;
  }

  const userId = $('#scheduleUserId').val();
  sendFormRequest('/api/somansa-bus/schedule/delete', { somansaBusScheduleId: scheduleId },
    function(response) {
      showToast('스케줄이 삭제되었습니다.', 'positive');
      loadUserSchedules(userId);
    },
    function(xhr) {
      showToast('스케줄 삭제 중 오류가 발생했습니다.', 'negative');
    }
  );
}

function showManualReserveModal() {
  $('#manualReserveForm')[0].reset();
  document.getElementById('manualReserveModal').showModal();
}

function executeManualReserve() {
  const userId = $('#manualUserId').val();
  const routeId = $('#manualRouteId').val();
  const reservationDate = $('#reservationDate').val();

  if (!userId || !routeId || !reservationDate) {
    showToast('모든 필드를 입력해주세요.', 'negative');
    return;
  }

  sendFormRequest('/api/somansa-bus/reserve/manual', {
    somansaBusUserId: userId,
    somansaBusRouteId: routeId,
    reservationDate: reservationDate
  },
  function(response) {
    showToast('예약이 완료되었습니다.', 'positive');
    document.getElementById('manualReserveModal').close();
    loadReservationHistory();
  },
  function(xhr) {
    let errorMessage = '예약 중 오류가 발생했습니다.';
    if (xhr.responseJSON && xhr.responseJSON.message) {
      errorMessage = xhr.responseJSON.message;
    }
    showToast(errorMessage, 'negative');
  });
}

function loadReservationHistory() {
  sendFormRequest('/api/somansa-bus/schedule/list/active', {},
    function(response) {
      displayReservationHistory([]);
    },
    function(xhr) {
      $('#historyTable').html('<tr><td colspan="5" class="text-center py-8 text-gray-500">기록 로드 실패</td></tr>');
    }
  );
}

function displayReservationHistory(histories) {
  const tableBody = $('#historyTable');

  if (!histories || histories.length === 0) {
    tableBody.html('<tr><td colspan="5" class="text-center py-8 text-gray-500">예약 기록이 없습니다.</td></tr>');
    return;
  }

  tableBody.empty();
  histories.forEach(function(history) {
    const row = $('<tr>');

    const timeCell = $('<td>');
    timeCell.text(history.createdDate ? new Date(history.createdDate).toLocaleString('ko-KR') : '-');
    row.append(timeCell);

    const userCell = $('<td>');
    userCell.text(history.user ? history.user.displayName : '-');
    row.append(userCell);

    const routeCell = $('<td>');
    routeCell.text(history.route ? history.route.description : '-');
    row.append(routeCell);

    const dateCell = $('<td>');
    dateCell.text(history.reservationDate || '-');
    row.append(dateCell);

    const statusCell = $('<td>');
    if (history.isSuccess) {
      statusCell.html('<span class="badge badge-success badge-sm">성공</span>');
    } else {
      statusCell.html('<span class="badge badge-error badge-sm">실패</span>');
    }
    row.append(statusCell);

    tableBody.append(row);
  });
}

function escapeHtml(text) {
  if (typeof text !== 'string') return text;
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}
</script>
</body>
</html>
