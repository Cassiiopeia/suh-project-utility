<!-- src/main/resources/templates/pages/chatbotManagement.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head(title='챗봇 문서 관리-SAECHAN-LAB')}"></head>
<body class="chatbot-management-page bg-gray-50">
<div th:replace="~{fragments/header :: header}"></div>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" id="main-content">
  <!-- 페이지 헤더 -->
  <div class="mb-6">
    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
      <i class="fa-solid fa-database text-purple-500"></i>
      챗봇 문서 관리
    </h2>
    <p class="text-gray-500 mt-1">RAG 챗봇이 참조할 문서를 관리합니다. (Qdrant 벡터DB 연동)</p>
  </div>

  <!-- 통계 카드 -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="card bg-base-100 shadow-sm border border-gray-100">
      <div class="card-body p-4">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-lg bg-blue-100 flex items-center justify-center">
            <i class="fa-solid fa-file-lines text-blue-600 text-xl"></i>
          </div>
          <div>
            <p class="text-gray-500 text-sm">총 문서 수</p>
            <p class="text-2xl font-bold" id="stat-total-docs">0</p>
          </div>
        </div>
      </div>
    </div>
    <div class="card bg-base-100 shadow-sm border border-gray-100">
      <div class="card-body p-4">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-lg bg-green-100 flex items-center justify-center">
            <i class="fa-solid fa-check-circle text-green-600 text-xl"></i>
          </div>
          <div>
            <p class="text-gray-500 text-sm">활성 문서</p>
            <p class="text-2xl font-bold" id="stat-active-docs">0</p>
          </div>
        </div>
      </div>
    </div>
    <div class="card bg-base-100 shadow-sm border border-gray-100">
      <div class="card-body p-4">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-lg bg-purple-100 flex items-center justify-center">
            <i class="fa-solid fa-puzzle-piece text-purple-600 text-xl"></i>
          </div>
          <div>
            <p class="text-gray-500 text-sm">총 청크 수</p>
            <p class="text-2xl font-bold" id="stat-total-chunks">0</p>
          </div>
        </div>
      </div>
    </div>
    <div class="card bg-base-100 shadow-sm border border-gray-100">
      <div class="card-body p-4">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-lg bg-amber-100 flex items-center justify-center">
            <i class="fa-solid fa-tags text-amber-600 text-xl"></i>
          </div>
          <div>
            <p class="text-gray-500 text-sm">카테고리</p>
            <p class="text-2xl font-bold" id="stat-categories">0</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 문서 관리 툴바 -->
  <div class="card bg-base-100 shadow-sm border border-gray-100 mb-6">
    <div class="card-body p-4">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <!-- 검색 영역 -->
        <div class="join w-full lg:w-auto">
          <input type="text" id="search-keyword" class="input input-bordered join-item w-full lg:w-64" placeholder="제목 또는 카테고리 검색...">
          <button class="btn btn-primary join-item" id="search-btn">
            <i class="fa-solid fa-search"></i>
            검색
          </button>
        </div>
        <!-- 버튼 영역 -->
        <div class="flex gap-2 flex-wrap">
          <button class="btn btn-primary" id="create-btn">
            <i class="fa-solid fa-plus"></i>
            새 문서
          </button>
          <button class="btn btn-outline btn-secondary" id="init-collection-btn">
            <i class="fa-solid fa-database"></i>
            컬렉션 초기화
          </button>
          <button class="btn btn-outline" id="refresh-btn">
            <i class="fa-solid fa-rotate"></i>
            새로고침
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 문서 목록 테이블 -->
  <div class="card bg-base-100 shadow-sm border border-gray-100">
    <div class="card-body p-4">
      <div id="document-table" class="modal-table-container"></div>
      <div id="loading-indicator" class="flex justify-center py-8">
        <span class="loading loading-spinner loading-lg text-primary"></span>
      </div>
      <div id="error-message" class="alert alert-error hidden">
        <i class="fa-solid fa-circle-exclamation"></i>
        <div>
          <h3 class="font-bold">데이터 로드 실패</h3>
          <span>문서를 불러오는 중 오류가 발생했습니다. 새로고침을 시도해주세요.</span>
        </div>
      </div>
      <div id="empty-message" class="alert alert-info hidden">
        <i class="fa-solid fa-info-circle"></i>
        <div>
          <h3 class="font-bold">문서가 없습니다</h3>
          <span>새 문서를 추가하여 챗봇이 참조할 지식을 등록하세요.</span>
        </div>
      </div>
    </div>
  </div>

  <!-- 문서 등록/수정 모달 -->
  <dialog class="modal" id="document-modal">
    <div class="modal-box max-w-4xl">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </form>
      <h3 class="font-bold text-lg mb-4" id="modal-title">문서 등록</h3>
      <form id="document-form" class="space-y-4">
        <input type="hidden" id="document-id">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">제목 <span class="text-red-500">*</span></span>
            </label>
            <input type="text" id="document-title" class="input input-bordered w-full" placeholder="문서 제목을 입력하세요">
          </div>
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">카테고리 <span class="text-red-500">*</span></span>
            </label>
            <select id="document-category" class="select select-bordered w-full">
              <option value="site-info">사이트 정보</option>
              <option value="features">기능 안내</option>
              <option value="faq">자주 묻는 질문</option>
              <option value="guide">사용 가이드</option>
              <option value="project">프로젝트 정보</option>
              <option value="other">기타</option>
            </select>
          </div>
        </div>
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">설명</span>
          </label>
          <input type="text" id="document-description" class="input input-bordered w-full" placeholder="문서에 대한 간단한 설명 (선택)">
        </div>
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">내용 (Markdown) <span class="text-red-500">*</span></span>
          </label>
          <textarea id="document-content" class="textarea textarea-bordered h-64 font-mono text-sm" placeholder="문서 내용을 마크다운 형식으로 입력하세요..."></textarea>
          <label class="label">
            <span class="label-text-alt text-gray-500">마크다운 문법을 지원합니다. 청크 분할: 약 500자 단위</span>
          </label>
        </div>
      </form>
      <div class="modal-action">
        <form method="dialog">
          <button class="btn btn-ghost">취소</button>
        </form>
        <button class="btn btn-primary" id="save-btn">
          <i class="fa-solid fa-save"></i>
          저장
        </button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <!-- 문서 상세 모달 -->
  <dialog class="modal" id="document-detail-modal">
    <div class="modal-box max-w-4xl">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </form>
      <h3 class="font-bold text-xl mb-4" id="detail-title"></h3>

      <!-- 메타 정보 -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 rounded-lg p-4 mb-4">
        <div class="space-y-2">
          <p class="flex items-center gap-2 text-gray-600">
            <i class="fa-solid fa-tag text-purple-500"></i>
            <strong>카테고리:</strong>
            <span id="detail-category" class="badge badge-primary"></span>
          </p>
          <p class="flex items-center gap-2 text-gray-600">
            <i class="fa-solid fa-calendar text-purple-500"></i>
            <strong>생성일:</strong>
            <span id="detail-created-date"></span>
          </p>
          <p class="flex items-center gap-2 text-gray-600">
            <i class="fa-solid fa-clock text-purple-500"></i>
            <strong>수정일:</strong>
            <span id="detail-updated-date"></span>
          </p>
        </div>
        <div class="space-y-2">
          <p class="flex items-center gap-2 text-gray-600">
            <i class="fa-solid fa-puzzle-piece text-purple-500"></i>
            <strong>청크 수:</strong>
            <span id="detail-chunk-count"></span>개
          </p>
          <p class="flex items-center gap-2 text-gray-600">
            <i class="fa-solid fa-circle-check text-purple-500"></i>
            <strong>처리 상태:</strong>
            <span id="detail-processed"></span>
          </p>
          <p class="flex items-center gap-2 text-gray-600">
            <i class="fa-solid fa-power-off text-purple-500"></i>
            <strong>활성화:</strong>
            <span id="detail-active"></span>
          </p>
        </div>
      </div>

      <!-- 설명 -->
      <div id="detail-description-section" class="mb-4">
        <h4 class="font-semibold text-gray-700 mb-2">설명</h4>
        <p id="detail-description" class="text-gray-600 bg-gray-50 rounded p-3"></p>
      </div>

      <div class="divider"></div>

      <!-- 내용 미리보기 -->
      <h4 class="font-semibold text-gray-700 mb-2">내용 미리보기</h4>
      <div class="prose max-w-none bg-gray-50 rounded-lg p-4 max-h-64 overflow-y-auto" id="detail-content"></div>

      <div class="modal-action">
        <button class="btn btn-info" id="reprocess-btn">
          <i class="fa-solid fa-rotate"></i>
          재처리
        </button>
        <button class="btn btn-primary" id="edit-btn">
          <i class="fa-solid fa-pen-to-square"></i>
          수정
        </button>
        <button class="btn btn-error" id="delete-btn">
          <i class="fa-solid fa-trash"></i>
          삭제
        </button>
        <button class="btn btn-outline" id="toggle-active-btn">
          <i class="fa-solid fa-power-off"></i>
          활성화/비활성화
        </button>
        <form method="dialog">
          <button class="btn btn-ghost">닫기</button>
        </form>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<!-- Tabulator 라이브러리 -->
<link href="https://unpkg.com/tabulator-tables@5.4.4/dist/css/tabulator.min.css" rel="stylesheet">
<script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.4.4/dist/js/tabulator.min.js"></script>

<script>
  $(document).ready(function() {
    // 전역 변수
    let allDocuments = [];

    // Tabulator 테이블 초기화
    const documentTable = new Tabulator("#document-table", {
      height: "400px",
      layout: "fitColumns",
      pagination: true,
      paginationSize: 10,
      columns: [
        {title: "제목", field: "title", width: 250, formatter: function(cell) {
          const value = cell.getValue();
          const isActive = cell.getRow().getData().isActive;
          const icon = isActive ?
            '<i class="fa-solid fa-file-lines text-blue-500 mr-2"></i>' :
            '<i class="fa-solid fa-file-lines text-gray-400 mr-2"></i>';
          return icon + value;
        }},
        {title: "카테고리", field: "category", width: 120, formatter: function(cell) {
          const value = cell.getValue();
          const categoryMap = {
            'site-info': '사이트 정보',
            'features': '기능 안내',
            'faq': 'FAQ',
            'guide': '사용 가이드',
            'project': '프로젝트',
            'other': '기타'
          };
          return `<span class="badge badge-outline badge-sm">${categoryMap[value] || value}</span>`;
        }},
        {title: "설명", field: "description", width: 200, formatter: function(cell) {
          const value = cell.getValue();
          return value ? (value.length > 30 ? value.substring(0, 30) + '...' : value) : '-';
        }},
        {title: "청크", field: "chunkCount", width: 80, hozAlign: "center"},
        {title: "처리", field: "isProcessed", formatter: "tickCross", width: 70, hozAlign: "center"},
        {title: "활성", field: "isActive", formatter: "tickCross", width: 70, hozAlign: "center"},
        {title: "생성일", field: "createdDate", formatter: function(cell) {
          return cell.getValue() ? new Date(cell.getValue()).toLocaleDateString() : '-';
        }, width: 100},
        {title: "관리", formatter: function() {
          return `<div class="flex gap-1">
            <button class="btn btn-xs btn-info view-btn" title="상세보기"><i class="fa-solid fa-eye"></i></button>
            <button class="btn btn-xs btn-success edit-row-btn" title="수정"><i class="fa-solid fa-pen"></i></button>
            <button class="btn btn-xs btn-error delete-row-btn" title="삭제"><i class="fa-solid fa-trash"></i></button>
          </div>`;
        }, width: 120, headerSort: false, hozAlign: "center", cellClick: function(e, cell) {
          const rowData = cell.getRow().getData();
          const element = e.target;

          if ($(element).hasClass('view-btn') || $(element).parent().hasClass('view-btn')) {
            showDocumentDetail(rowData);
          } else if ($(element).hasClass('edit-row-btn') || $(element).parent().hasClass('edit-row-btn')) {
            editDocument(rowData.documentId);
          } else if ($(element).hasClass('delete-row-btn') || $(element).parent().hasClass('delete-row-btn')) {
            if (confirm('정말로 이 문서를 삭제하시겠습니까? 벡터DB에서도 삭제됩니다.')) {
              deleteDocument(rowData.documentId);
            }
          }

          e.stopPropagation();
        }}
      ],
      rowClick: function(e, row) {
        showDocumentDetail(row.getData());
      }
    });

    // 문서 목록 로드
    loadDocuments();

    // 새로고침 버튼 클릭 이벤트
    $('#refresh-btn').click(function() {
      loadDocuments();
    });

    // 검색 버튼 클릭 이벤트
    $('#search-btn').click(function() {
      const keyword = $('#search-keyword').val().toLowerCase();
      if (keyword) {
        const filtered = allDocuments.filter(doc =>
          doc.title.toLowerCase().includes(keyword) ||
          doc.category.toLowerCase().includes(keyword) ||
          (doc.description && doc.description.toLowerCase().includes(keyword))
        );
        documentTable.setData(filtered);
      } else {
        documentTable.setData(allDocuments);
      }
    });

    // 검색 입력 필드에서 엔터 키 이벤트
    $('#search-keyword').keypress(function(e) {
      if (e.which === 13) {
        $('#search-btn').click();
      }
    });

    // 새 문서 버튼 클릭 이벤트
    $('#create-btn').click(function() {
      resetDocumentForm();
      $('#modal-title').text('문서 등록');
      document.getElementById('document-modal').showModal();
    });

    // 컬렉션 초기화 버튼
    $('#init-collection-btn').click(function() {
      if (confirm('벡터 컬렉션을 초기화하시겠습니까? (기존 데이터는 유지됩니다)')) {
        initializeCollection();
      }
    });

    // 저장 버튼 클릭 이벤트
    $('#save-btn').click(function() {
      saveDocument();
    });

    // 수정 버튼 클릭 이벤트
    $('#edit-btn').click(function() {
      const documentId = $('#detail-title').data('id');
      editDocument(documentId);
    });

    // 삭제 버튼 클릭 이벤트
    $('#delete-btn').click(function() {
      const documentId = $('#detail-title').data('id');
      if (confirm('정말로 이 문서를 삭제하시겠습니까? 벡터DB에서도 삭제됩니다.')) {
        deleteDocument(documentId);
      }
    });

    // 재처리 버튼 클릭 이벤트
    $('#reprocess-btn').click(function() {
      const documentId = $('#detail-title').data('id');
      if (confirm('문서를 재처리하시겠습니까? 청크가 재생성되고 벡터가 다시 저장됩니다.')) {
        reprocessDocument(documentId);
      }
    });

    // 활성화/비활성화 버튼 클릭 이벤트
    $('#toggle-active-btn').click(function() {
      const documentId = $('#detail-title').data('id');
      toggleDocumentActive(documentId);
    });

    // 문서 목록 로드 함수
    function loadDocuments() {
      $('#loading-indicator').show();
      $('#error-message').addClass('hidden');
      $('#empty-message').addClass('hidden');

      sendFormRequest(
        '/api/chatbot/document/list',
        null,
        function(response) {
          $('#loading-indicator').hide();
          if (response && response.documents) {
            allDocuments = response.documents;
            documentTable.setData(allDocuments);
            updateStatistics(allDocuments);

            if (allDocuments.length === 0) {
              $('#empty-message').removeClass('hidden');
            }
          } else {
            $('#error-message').removeClass('hidden');
            console.error('문서 로드 실패:', response);
          }
        },
        function(xhr, status, error) {
          $('#loading-indicator').hide();
          $('#error-message').removeClass('hidden');
          console.error('문서 로드 오류:', error);
        }
      );
    }

    // 통계 업데이트 함수
    function updateStatistics(documents) {
      const totalDocs = documents.length;
      const activeDocs = documents.filter(d => d.isActive).length;
      const totalChunks = documents.reduce((sum, d) => sum + (d.chunkCount || 0), 0);
      const categories = [...new Set(documents.map(d => d.category))].length;

      $('#stat-total-docs').text(totalDocs);
      $('#stat-active-docs').text(activeDocs);
      $('#stat-total-chunks').text(totalChunks);
      $('#stat-categories').text(categories);
    }

    // 문서 저장 함수
    function saveDocument() {
      const documentId = $('#document-id').val();
      const title = $('#document-title').val();
      const category = $('#document-category').val();
      const content = $('#document-content').val();
      const description = $('#document-description').val();

      if (!title || !content) {
        alert('제목과 내용을 입력해주세요.');
        return;
      }

      const url = documentId ? '/api/chatbot/document/update' : '/api/chatbot/document/create';

      sendFormRequest(
        url,
        {
          documentId: documentId || undefined,
          title: title,
          category: category,
          content: content,
          description: description || undefined
        },
        function(response) {
          if (response) {
            alert('문서가 저장되었습니다. 청크 분할 및 벡터화가 완료되었습니다.');
            document.getElementById('document-modal').close();
            loadDocuments();
          } else {
            alert('저장 실패: 알 수 없는 오류');
          }
        },
        function(xhr, status, error) {
          alert('저장 오류: ' + error);
        }
      );
    }

    // 문서 상세 정보 표시 함수
    function showDocumentDetail(doc) {
      $('#detail-title').text(doc.title).data('id', doc.documentId);

      const categoryMap = {
        'site-info': '사이트 정보',
        'features': '기능 안내',
        'faq': 'FAQ',
        'guide': '사용 가이드',
        'project': '프로젝트',
        'other': '기타'
      };
      $('#detail-category').text(categoryMap[doc.category] || doc.category);
      $('#detail-created-date').text(doc.createdDate ? new Date(doc.createdDate).toLocaleString() : '-');
      $('#detail-updated-date').text(doc.updatedDate ? new Date(doc.updatedDate).toLocaleString() : '-');
      $('#detail-chunk-count').text(doc.chunkCount || 0);

      const processedClass = doc.isProcessed ? 'badge-success' : 'badge-warning';
      const processedText = doc.isProcessed ? '완료' : '대기중';
      $('#detail-processed').html(`<span class="badge ${processedClass}">${processedText}</span>`);

      const activeClass = doc.isActive ? 'badge-success' : 'badge-error';
      const activeText = doc.isActive ? '활성' : '비활성';
      $('#detail-active').html(`<span class="badge ${activeClass}">${activeText}</span>`);

      if (doc.description) {
        $('#detail-description').text(doc.description);
        $('#detail-description-section').show();
      } else {
        $('#detail-description-section').hide();
      }

      // 내용 미리보기 (마크다운 형식 그대로 표시)
      $('#detail-content').html('<pre class="whitespace-pre-wrap text-sm">' + escapeHtml(doc.content) + '</pre>');

      // 버튼 상태 업데이트
      $('#toggle-active-btn').html(`<i class="fa-solid fa-power-off"></i> ${doc.isActive ? '비활성화' : '활성화'}`);

      document.getElementById('document-detail-modal').showModal();
    }

    // HTML 이스케이프 함수
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // 문서 수정 함수
    function editDocument(documentId) {
      sendFormRequest(
        '/api/chatbot/document/detail',
        { documentId: documentId },
        function(response) {
          if (response) {
            $('#document-id').val(response.documentId);
            $('#document-title').val(response.title);
            $('#document-category').val(response.category);
            $('#document-content').val(response.content);
            $('#document-description').val(response.description || '');

            $('#modal-title').text('문서 수정');
            document.getElementById('document-detail-modal').close();
            document.getElementById('document-modal').showModal();
          } else {
            alert('문서 정보를 불러올 수 없습니다.');
          }
        },
        function(xhr, status, error) {
          alert('문서 정보 로드 오류: ' + error);
        }
      );
    }

    // 문서 삭제 함수
    function deleteDocument(documentId) {
      sendFormRequest(
        '/api/chatbot/document/delete',
        { documentId: documentId },
        function(response) {
          alert('문서가 삭제되었습니다.');
          document.getElementById('document-detail-modal').close();
          loadDocuments();
        },
        function(xhr, status, error) {
          alert('삭제 오류: ' + error);
        }
      );
    }

    // 문서 재처리 함수
    function reprocessDocument(documentId) {
      sendFormRequest(
        '/api/chatbot/document/reprocess',
        { documentId: documentId },
        function(response) {
          if (response) {
            alert('문서가 재처리되었습니다. 청크 수: ' + response.chunkCount);
            document.getElementById('document-detail-modal').close();
            loadDocuments();
          } else {
            alert('재처리 실패');
          }
        },
        function(xhr, status, error) {
          alert('재처리 오류: ' + error);
        }
      );
    }

    // 문서 활성화/비활성화 함수
    function toggleDocumentActive(documentId) {
      sendFormRequest(
        '/api/chatbot/document/toggle-active',
        { documentId: documentId },
        function(response) {
          alert('문서 상태가 변경되었습니다.');
          document.getElementById('document-detail-modal').close();
          loadDocuments();
        },
        function(xhr, status, error) {
          alert('상태 변경 오류: ' + error);
        }
      );
    }

    // 컬렉션 초기화 함수
    function initializeCollection() {
      sendFormRequest(
        '/api/chatbot/admin/init-collection',
        null,
        function(response) {
          alert('벡터 컬렉션이 초기화되었습니다.');
        },
        function(xhr, status, error) {
          alert('초기화 오류: ' + error);
        }
      );
    }

    // 문서 폼 초기화 함수
    function resetDocumentForm() {
      $('#document-id').val('');
      $('#document-title').val('');
      $('#document-category').val('site-info');
      $('#document-content').val('');
      $('#document-description').val('');
    }
  });
</script>
</body>
</html>
