<!-- src/main/resources/templates/pages/chatbotManagement.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head(title='챗봇 문서 관리-SAECHAN-LAB')}"></head>
<body class="chatbot-management-page bg-gray-50">
<div th:replace="~{fragments/header :: header}"></div>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" id="main-content">
  <!-- 페이지 헤더 -->
  <div class="mb-6">
    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
      <i class="fa-solid fa-database text-purple-500"></i>
      챗봇 문서 관리
    </h2>
    <p class="text-gray-500 mt-1">RAG 챗봇이 참조할 문서를 관리합니다. (Qdrant 벡터DB 연동)</p>
  </div>

  <!-- 통계 카드 -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="card bg-base-100 shadow-sm border border-gray-100">
      <div class="card-body p-4">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-lg bg-blue-100 flex items-center justify-center">
            <i class="fa-solid fa-file-lines text-blue-600 text-xl"></i>
          </div>
          <div>
            <p class="text-gray-500 text-sm">총 문서 수</p>
            <p class="text-2xl font-bold" id="stat-total-docs">0</p>
          </div>
        </div>
      </div>
    </div>
    <div class="card bg-base-100 shadow-sm border border-gray-100">
      <div class="card-body p-4">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-lg bg-green-100 flex items-center justify-center">
            <i class="fa-solid fa-check-circle text-green-600 text-xl"></i>
          </div>
          <div>
            <p class="text-gray-500 text-sm">활성 문서</p>
            <p class="text-2xl font-bold" id="stat-active-docs">0</p>
          </div>
        </div>
      </div>
    </div>
    <div class="card bg-base-100 shadow-sm border border-gray-100">
      <div class="card-body p-4">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-lg bg-purple-100 flex items-center justify-center">
            <i class="fa-solid fa-puzzle-piece text-purple-600 text-xl"></i>
          </div>
          <div>
            <p class="text-gray-500 text-sm">총 청크 수</p>
            <p class="text-2xl font-bold" id="stat-total-chunks">0</p>
          </div>
        </div>
      </div>
    </div>
    <div class="card bg-base-100 shadow-sm border border-gray-100">
      <div class="card-body p-4">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-lg bg-amber-100 flex items-center justify-center">
            <i class="fa-solid fa-tags text-amber-600 text-xl"></i>
          </div>
          <div>
            <p class="text-gray-500 text-sm">카테고리</p>
            <p class="text-2xl font-bold" id="stat-categories">0</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 문서 관리 툴바 -->
  <div class="card bg-base-100 shadow-sm border border-gray-100 mb-6">
    <div class="card-body p-4">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <!-- 검색 영역 -->
        <div class="join w-full lg:w-auto">
          <input type="text" id="search-keyword" class="input join-item w-full lg:w-64" placeholder="제목 또는 카테고리 검색...">
          <button class="btn btn-primary join-item" id="search-btn">
            <i class="fa-solid fa-search"></i>
            검색
          </button>
        </div>
        <!-- 버튼 영역 -->
        <div class="flex gap-2 flex-wrap">
          <button class="btn btn-primary" id="create-btn">
            <i class="fa-solid fa-plus"></i>
            새 문서
          </button>
          <div class="tooltip tooltip-bottom" data-tip="벡터 컬렉션을 초기화합니다. 기존 문서 데이터는 유지됩니다.">
            <button class="btn btn-outline btn-secondary" id="init-collection-btn">
              <i class="fa-solid fa-database"></i>
              컬렉션 초기화
            </button>
          </div>
          <div class="tooltip tooltip-bottom" data-tip="모든 문서를 현재 설정으로 다시 처리합니다. 시간이 오래 걸릴 수 있습니다.">
            <button class="btn btn-outline btn-warning" id="reprocess-all-btn">
              <i class="fa-solid fa-arrows-rotate"></i>
              전체 재처리
            </button>
          </div>
          <button class="btn btn-outline btn-accent" id="settings-btn">
            <i class="fa-solid fa-gear"></i>
            설정
          </button>
          <button class="btn btn-outline" id="refresh-btn">
            <i class="fa-solid fa-rotate"></i>
            새로고침
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 문서 목록 테이블 -->
  <div class="card bg-base-100 shadow-sm border border-gray-100">
    <div class="card-body p-4">
      <div id="loading-indicator" class="flex justify-center py-8">
        <span class="loading loading-spinner loading-lg text-primary"></span>
      </div>
      <div id="error-message" class="alert alert-error hidden">
        <i class="fa-solid fa-circle-exclamation"></i>
        <div>
          <h3 class="font-bold">데이터 로드 실패</h3>
          <span>문서를 불러오는 중 오류가 발생했습니다. 새로고침을 시도해주세요.</span>
        </div>
      </div>
      <div id="empty-message" class="alert alert-info hidden">
        <i class="fa-solid fa-info-circle"></i>
        <div>
          <h3 class="font-bold">문서가 없습니다</h3>
          <span>새 문서를 추가하여 챗봇이 참조할 지식을 등록하세요.</span>
        </div>
      </div>
      <div id="table-container" class="hidden">
        <div class="overflow-x-auto">
          <table class="table table-zebra">
            <thead>
              <tr>
                <th>제목</th>
                <th>카테고리</th>
                <th>설명</th>
                <th>청크</th>
                <th>처리</th>
                <th>활성</th>
                <th>생성일</th>
                <th>관리</th>
              </tr>
            </thead>
            <tbody id="document-table-body">
            </tbody>
          </table>
        </div>
        <div id="document-pagination" class="flex justify-center mt-4"></div>
      </div>
    </div>
  </div>

  <!-- 문서 등록/수정 모달 -->
  <dialog class="modal" id="document-modal">
    <div class="modal-box max-w-4xl">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </form>
      <h3 class="font-bold text-lg mb-4" id="modal-title">문서 등록</h3>
      <form id="document-form" class="space-y-4">
        <input type="hidden" id="document-id">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">제목 <span class="text-red-500">*</span></span>
            </label>
            <input type="text" id="document-title" class="input w-full" placeholder="문서 제목을 입력하세요">
          </div>
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">카테고리 <span class="text-red-500">*</span></span>
            </label>
            <select id="document-category" class="select w-full">
              <option value="site-info">사이트 정보</option>
              <option value="features">기능 안내</option>
              <option value="faq">자주 묻는 질문</option>
              <option value="guide">사용 가이드</option>
              <option value="project">프로젝트 정보</option>
              <option value="other">기타</option>
            </select>
          </div>
        </div>
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">설명</span>
          </label>
          <input type="text" id="document-description" class="input w-full" placeholder="문서에 대한 간단한 설명 (선택)">
        </div>
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">내용 (Markdown) <span class="text-red-500">*</span></span>
          </label>
          <textarea id="document-content" class="textarea h-64 font-mono text-sm" placeholder="문서 내용을 마크다운 형식으로 입력하세요..."></textarea>
          <label class="label">
            <span class="label-text-alt text-gray-500">마크다운 문법을 지원합니다. 청크 분할: 약 500자 단위</span>
          </label>
        </div>
      </form>
      <div class="modal-action">
        <form method="dialog">
          <button class="btn btn-ghost">취소</button>
        </form>
        <button class="btn btn-primary" id="save-btn">
          <i class="fa-solid fa-save"></i>
          저장
        </button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <!-- 문서 상세 모달 -->
  <dialog class="modal" id="document-detail-modal">
    <div class="modal-box max-w-4xl">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </form>
      <h3 class="font-bold text-xl mb-4" id="detail-title"></h3>

      <!-- 메타 정보 -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 rounded-lg p-4 mb-4">
        <div class="space-y-2">
          <p class="flex items-center gap-2 text-gray-600">
            <i class="fa-solid fa-tag text-purple-500"></i>
            <strong>카테고리:</strong>
            <span id="detail-category" class="badge badge-primary"></span>
          </p>
          <p class="flex items-center gap-2 text-gray-600">
            <i class="fa-solid fa-calendar text-purple-500"></i>
            <strong>생성일:</strong>
            <span id="detail-created-date"></span>
          </p>
          <p class="flex items-center gap-2 text-gray-600">
            <i class="fa-solid fa-clock text-purple-500"></i>
            <strong>수정일:</strong>
            <span id="detail-updated-date"></span>
          </p>
        </div>
        <div class="space-y-2">
          <p class="flex items-center gap-2 text-gray-600">
            <i class="fa-solid fa-puzzle-piece text-purple-500"></i>
            <strong>청크 수:</strong>
            <span id="detail-chunk-count"></span>개
          </p>
          <p class="flex items-center gap-2 text-gray-600">
            <i class="fa-solid fa-circle-check text-purple-500"></i>
            <strong>처리 상태:</strong>
            <span id="detail-processed"></span>
          </p>
          <p class="flex items-center gap-2 text-gray-600">
            <i class="fa-solid fa-power-off text-purple-500"></i>
            <strong>활성화:</strong>
            <span id="detail-active"></span>
          </p>
        </div>
      </div>

      <!-- 설명 -->
      <div id="detail-description-section" class="mb-4">
        <h4 class="font-semibold text-gray-700 mb-2">설명</h4>
        <p id="detail-description" class="text-gray-600 bg-gray-50 rounded p-3"></p>
      </div>

      <div class="divider"></div>

      <!-- 내용 미리보기 -->
      <h4 class="font-semibold text-gray-700 mb-2">내용 미리보기</h4>
      <div class="prose max-w-none bg-gray-50 rounded-lg p-4 max-h-64 overflow-y-auto" id="detail-content"></div>

      <div class="modal-action">
        <button class="btn btn-info" id="reprocess-btn">
          <i class="fa-solid fa-rotate"></i>
          재처리
        </button>
        <button class="btn btn-primary" id="edit-btn">
          <i class="fa-solid fa-pen-to-square"></i>
          수정
        </button>
        <button class="btn btn-error" id="delete-btn">
          <i class="fa-solid fa-trash"></i>
          삭제
        </button>
        <button class="btn btn-outline" id="toggle-active-btn">
          <i class="fa-solid fa-power-off"></i>
          활성화/비활성화
        </button>
        <form method="dialog">
          <button class="btn btn-ghost">닫기</button>
        </form>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <!-- 설정 모달 -->
  <dialog id="settings-modal" class="modal">
    <div class="modal-box max-w-2xl">
      <h3 class="font-bold text-lg mb-4">
        <i class="fa-solid fa-gear text-blue-500"></i>
        챗봇 설정
      </h3>

      <div class="space-y-4">
        <!-- 청크 크기 설정 -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-semibold">청크 크기 (토큰 수)</span>
            <span class="label-text-alt text-gray-500">기본값: 3000</span>
          </label>
          <input type="number" id="chunk-size-input" class="input input-bordered" 
                 min="500" max="10000" step="100" placeholder="3000">
          <label class="label">
            <span class="label-text-alt text-gray-500">
              문서를 분할하는 청크의 크기입니다. 값이 클수록 더 많은 컨텍스트를 포함합니다.
            </span>
          </label>
        </div>

        <!-- 청크 중첩 설정 -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-semibold">청크 중첩 크기 (토큰 수)</span>
            <span class="label-text-alt text-gray-500">기본값: 300</span>
          </label>
          <input type="number" id="chunk-overlap-input" class="input input-bordered" 
                 min="0" max="1000" step="50" placeholder="300">
          <label class="label">
            <span class="label-text-alt text-gray-500">
              인접한 청크 간 중첩되는 부분의 크기입니다. 문맥 연속성을 유지합니다.
            </span>
          </label>
        </div>

        <!-- 안내 메시지 -->
        <div class="alert alert-info">
          <i class="fa-solid fa-info-circle"></i>
          <span>설정을 변경한 후 <strong>'전체 재처리'</strong>를 실행해야 새 설정이 적용됩니다.</span>
        </div>
      </div>

      <div class="modal-action">
        <button class="btn btn-primary" id="save-settings-btn">
          <i class="fa-solid fa-save"></i>
          저장
        </button>
        <form method="dialog">
          <button class="btn">취소</button>
        </form>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<script>
  $(document).ready(function() {
    // 전역 변수
    let allDocuments = [];
    let filteredDocuments = [];
    let currentPage = 1;
    const pageSize = 10;

    // 카테고리 맵
    const categoryMap = {
      'site-info': '사이트 정보',
      'features': '기능 안내',
      'faq': 'FAQ',
      'guide': '사용 가이드',
      'project': '프로젝트',
      'other': '기타'
    };

    // 문서 목록 로드
    loadDocuments();

    // 새로고침 버튼 클릭 이벤트
    $('#refresh-btn').click(function() {
      loadDocuments();
    });

    // 검색 버튼 클릭 이벤트
    $('#search-btn').click(function() {
      const keyword = $('#search-keyword').val().toLowerCase();
      if (keyword) {
        filteredDocuments = allDocuments.filter(doc =>
          doc.title.toLowerCase().includes(keyword) ||
          doc.category.toLowerCase().includes(keyword) ||
          (doc.description && doc.description.toLowerCase().includes(keyword))
        );
        currentPage = 1;
        renderTable(filteredDocuments);
      } else {
        filteredDocuments = [];
        currentPage = 1;
        renderTable(allDocuments);
      }
    });

    // 검색 입력 필드에서 엔터 키 이벤트
    $('#search-keyword').keypress(function(e) {
      if (e.which === 13) {
        $('#search-btn').click();
      }
    });

    // 새 문서 버튼 클릭 이벤트
    $('#create-btn').click(function() {
      resetDocumentForm();
      $('#modal-title').text('문서 등록');
      document.getElementById('document-modal').showModal();
    });

    // 컬렉션 초기화 버튼
    $('#init-collection-btn').click(function() {
      if (confirm('벡터 컬렉션을 초기화하시겠습니까? (기존 데이터는 유지됩니다)')) {
        initializeCollection();
      }
    });

    // 전체 재처리 버튼
    $('#reprocess-all-btn').click(function() {
      if (confirm('모든 문서를 다시 처리합니다. 시간이 오래 걸릴 수 있습니다. 계속하시겠습니까?')) {
        reprocessAllDocuments();
      }
    });

    // 설정 버튼
    $('#settings-btn').click(function() {
      loadServerSettings();
      document.getElementById('settings-modal').showModal();
    });

    // 설정 저장 버튼
    $('#save-settings-btn').click(function() {
      saveServerSettings();
    });

    // 저장 버튼 클릭 이벤트
    $('#save-btn').click(function() {
      saveDocument();
    });

    // 수정 버튼 클릭 이벤트
    $('#edit-btn').click(function() {
      const documentId = $('#detail-title').data('id');
      editDocument(documentId);
    });

    // 삭제 버튼 클릭 이벤트
    $('#delete-btn').click(function() {
      const documentId = $('#detail-title').data('id');
      if (confirm('정말로 이 문서를 삭제하시겠습니까? 벡터DB에서도 삭제됩니다.')) {
        deleteDocument(documentId);
      }
    });

    // 재처리 버튼 클릭 이벤트
    $('#reprocess-btn').click(function() {
      const documentId = $('#detail-title').data('id');
      if (confirm('문서를 재처리하시겠습니까? 청크가 재생성되고 벡터가 다시 저장됩니다.')) {
        reprocessDocument(documentId);
      }
    });

    // 활성화/비활성화 버튼 클릭 이벤트
    $('#toggle-active-btn').click(function() {
      const documentId = $('#detail-title').data('id');
      toggleDocumentActive(documentId);
    });

    // 테이블 row 클릭 이벤트 (이벤트 위임)
    $(document).on('click', '#document-table-body tr', function(e) {
      // 액션 버튼 클릭 시는 무시
      if ($(e.target).closest('button, a').length > 0) {
        return;
      }
      const documentId = $(this).data('document-id');
      if (documentId) {
        const doc = allDocuments.find(d => d.documentId === documentId);
        if (doc) {
          showDocumentDetail(doc);
        }
      }
    });

    // 액션 버튼 클릭 이벤트 (이벤트 위임)
    // view-btn 제거됨 - 행 클릭으로 대체

    $(document).on('click', '.edit-row-btn', function(e) {
      e.stopPropagation();
      const documentId = $(this).closest('tr').data('document-id');
      editDocument(documentId);
    });

    $(document).on('click', '.delete-row-btn', function(e) {
      e.stopPropagation();
      const documentId = $(this).closest('tr').data('document-id');
      if (confirm('정말로 이 문서를 삭제하시겠습니까? 벡터DB에서도 삭제됩니다.')) {
        deleteDocument(documentId);
      }
    });

    // 페이지네이션 클릭 이벤트
    $(document).on('click', '.pagination-btn', function(e) {
      e.preventDefault();
      const page = parseInt($(this).data('page'));
      if (page >= 1 && page !== currentPage) {
        currentPage = page;
        renderTable(filteredDocuments.length > 0 ? filteredDocuments : allDocuments);
      }
    });

    // 문서 목록 로드 함수
    function loadDocuments() {
      $('#loading-indicator').show();
      $('#error-message').addClass('hidden');
      $('#empty-message').addClass('hidden');
      $('#table-container').addClass('hidden');

      sendFormRequest(
        '/api/chatbot/document/list',
        null,
        function(response) {
          $('#loading-indicator').hide();
          if (response && response.documents) {
            allDocuments = response.documents;
            filteredDocuments = [];
            currentPage = 1;
            renderTable(allDocuments);
            updateStatistics(allDocuments);

            if (allDocuments.length === 0) {
              $('#empty-message').removeClass('hidden');
            }
          } else {
            $('#error-message').removeClass('hidden');
            console.error('문서 로드 실패:', response);
          }
        },
        function(xhr, status, error) {
          $('#loading-indicator').hide();
          $('#error-message').removeClass('hidden');
          console.error('문서 로드 오류:', error);
        }
      );
    }

    // 통계 업데이트 함수
    function updateStatistics(documents) {
      const totalDocs = documents.length;
      const activeDocs = documents.filter(d => d.isActive).length;
      const totalChunks = documents.reduce((sum, d) => sum + (d.chunkCount || 0), 0);
      const categories = [...new Set(documents.map(d => d.category))].length;

      $('#stat-total-docs').text(totalDocs);
      $('#stat-active-docs').text(activeDocs);
      $('#stat-total-chunks').text(totalChunks);
      $('#stat-categories').text(categories);
    }

    // 테이블 렌더링 함수
    function renderTable(documents) {
      if (!documents || documents.length === 0) {
        $('#table-container').addClass('hidden');
        $('#empty-message').removeClass('hidden');
        return;
      }

      $('#empty-message').addClass('hidden');
      $('#table-container').removeClass('hidden');

      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = startIndex + pageSize;
      const pageData = documents.slice(startIndex, endIndex);

      let html = '';
      pageData.forEach(function(doc) {
        const icon = doc.isActive
          ? '<i class="fa-solid fa-file-lines text-blue-500 mr-2"></i>'
          : '<i class="fa-solid fa-file-lines text-gray-400 mr-2"></i>';
        
        const titleHtml = icon + escapeHtml(doc.title);
        const categoryBadge = `<span class="badge badge-outline badge-sm">${categoryMap[doc.category] || doc.category}</span>`;
        
        const description = doc.description 
          ? (doc.description.length > 30 ? doc.description.substring(0, 30) + '...' : doc.description)
          : '-';
        
        const processedIcon = doc.isProcessed
          ? '<i class="fa-solid fa-check text-green-500"></i>'
          : '<i class="fa-solid fa-times text-red-500"></i>';
        
        const activeIcon = doc.isActive
          ? '<i class="fa-solid fa-check text-green-500"></i>'
          : '<i class="fa-solid fa-times text-red-500"></i>';

        const createdDate = doc.createdDate ? formatDate(doc.createdDate) : '-';

        html += `
          <tr class="hover:bg-base-300 cursor-pointer" data-document-id="${doc.documentId}">
            <td>${titleHtml}</td>
            <td>${categoryBadge}</td>
            <td>${escapeHtml(description)}</td>
            <td class="text-center">${doc.chunkCount || 0}</td>
            <td class="text-center">${processedIcon}</td>
            <td class="text-center">${activeIcon}</td>
            <td>${createdDate}</td>
            <td>
              <div class="flex gap-1">
                <button class="btn btn-xs btn-success edit-row-btn" title="수정">
                  <i class="fa-solid fa-pen"></i>
                </button>
                <button class="btn btn-xs btn-error delete-row-btn" title="삭제">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      });

      $('#document-table-body').html(html);
      renderPagination(documents.length);
    }

    // 페이지네이션 렌더링 함수
    function renderPagination(totalItems) {
      const totalPages = Math.ceil(totalItems / pageSize);
      
      if (totalPages <= 1) {
        $('#document-pagination').empty();
        return;
      }

      let html = '<div class="join">';
      
      // 이전 페이지 버튼
      html += `<button class="join-item btn btn-sm ${currentPage === 1 ? 'btn-disabled' : ''}" 
               data-page="${currentPage - 1}" 
               ${currentPage === 1 ? 'disabled' : ''}>
               <i class="fa-solid fa-angle-left"></i>
               </button>`;
      
      // 페이지 번호 버튼
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
          html += `<button class="join-item btn btn-sm pagination-btn ${i === currentPage ? 'btn-active' : ''}" 
                   data-page="${i}">${i}</button>`;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
          html += '<span class="join-item btn btn-sm btn-disabled">...</span>';
        }
      }
      
      // 다음 페이지 버튼
      html += `<button class="join-item btn btn-sm ${currentPage === totalPages ? 'btn-disabled' : ''}" 
               data-page="${currentPage + 1}" 
               ${currentPage === totalPages ? 'disabled' : ''}>
               <i class="fa-solid fa-angle-right"></i>
               </button>`;
      
      html += '</div>';
      $('#document-pagination').html(html);
    }

    // 날짜 포맷 함수
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      return new Date(dateStr).toLocaleDateString('ko-KR');
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return '-';
      return new Date(dateStr).toLocaleString('ko-KR');
    }

    // HTML 이스케이프 함수
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // 문서 저장 함수
    function saveDocument() {
      const documentId = $('#document-id').val();
      const title = $('#document-title').val();
      const category = $('#document-category').val();
      const content = $('#document-content').val();
      const description = $('#document-description').val();

      if (!title || !content) {
        if (typeof showToast === 'function') {
          showToast('제목과 내용을 입력해주세요.', 'warning');
        }
        return;
      }

      const url = documentId ? '/api/chatbot/document/update' : '/api/chatbot/document/create';

      sendFormRequest(
        url,
        {
          documentId: documentId || undefined,
          title: title,
          category: category,
          content: content,
          description: description || undefined
        },
        function(response) {
          if (response) {
            if (typeof showToast === 'function') {
              showToast('문서가 저장되었습니다. 청크 분할 및 벡터화가 완료되었습니다.', 'positive');
            }
            document.getElementById('document-modal').close();
            loadDocuments();
          } else {
            if (typeof showToast === 'function') {
              showToast('저장 실패: 알 수 없는 오류', 'negative');
            }
          }
        },
        function(xhr, status, error) {
          console.error('문서 저장 오류:', error);
        }
      );
    }

    // 문서 상세 정보 표시 함수
    function showDocumentDetail(doc) {
      $('#detail-title').text(doc.title).data('id', doc.documentId);
      $('#detail-category').text(categoryMap[doc.category] || doc.category);
      $('#detail-created-date').text(formatDateTime(doc.createdDate));
      $('#detail-updated-date').text(doc.updatedDate ? formatDateTime(doc.updatedDate) : '-');
      $('#detail-chunk-count').text(doc.chunkCount || 0);

      const processedClass = doc.isProcessed ? 'badge-success' : 'badge-warning';
      const processedText = doc.isProcessed ? '완료' : '대기중';
      $('#detail-processed').html(`<span class="badge ${processedClass}">${processedText}</span>`);

      const activeClass = doc.isActive ? 'badge-success' : 'badge-error';
      const activeText = doc.isActive ? '활성' : '비활성';
      $('#detail-active').html(`<span class="badge ${activeClass}">${activeText}</span>`);

      if (doc.description) {
        $('#detail-description').text(doc.description);
        $('#detail-description-section').show();
      } else {
        $('#detail-description-section').hide();
      }

      // 내용 미리보기 (마크다운 형식 그대로 표시)
      $('#detail-content').html('<pre class="whitespace-pre-wrap text-sm">' + escapeHtml(doc.content) + '</pre>');

      // 버튼 상태 업데이트
      $('#toggle-active-btn').html(`<i class="fa-solid fa-power-off"></i> ${doc.isActive ? '비활성화' : '활성화'}`);

      document.getElementById('document-detail-modal').showModal();
    }

    // 문서 수정 함수
    function editDocument(documentId) {
      sendFormRequest(
        '/api/chatbot/document/detail',
        { documentId: documentId },
        function(response) {
          if (response) {
            $('#document-id').val(response.documentId);
            $('#document-title').val(response.title);
            $('#document-category').val(response.category);
            $('#document-content').val(response.content);
            $('#document-description').val(response.description || '');

            $('#modal-title').text('문서 수정');
            document.getElementById('document-detail-modal').close();
            document.getElementById('document-modal').showModal();
          } else {
            if (typeof showToast === 'function') {
              showToast('문서 정보를 불러올 수 없습니다.', 'negative');
            }
          }
        },
        function(xhr, status, error) {
          console.error('문서 정보 로드 오류:', error);
        }
      );
    }

    // 문서 삭제 함수
    function deleteDocument(documentId) {
      sendFormRequest(
        '/api/chatbot/document/delete',
        { documentId: documentId },
        function(response) {
          if (typeof showToast === 'function') {
            showToast('문서가 삭제되었습니다.', 'positive');
          }
          document.getElementById('document-detail-modal').close();
          loadDocuments();
        },
        function(xhr, status, error) {
          console.error('문서 삭제 오류:', error);
        }
      );
    }

    // 문서 재처리 함수
    function reprocessDocument(documentId) {
      sendFormRequest(
        '/api/chatbot/document/reprocess',
        { documentId: documentId },
        function(response) {
          if (response) {
            if (typeof showToast === 'function') {
              showToast('문서가 재처리되었습니다. 청크 수: ' + response.chunkCount, 'positive');
            }
            document.getElementById('document-detail-modal').close();
            loadDocuments();
          } else {
            if (typeof showToast === 'function') {
              showToast('재처리 실패', 'negative');
            }
          }
        },
        function(xhr, status, error) {
          console.error('문서 재처리 오류:', error);
        }
      );
    }

    // 문서 활성화/비활성화 함수
    function toggleDocumentActive(documentId) {
      sendFormRequest(
        '/api/chatbot/document/toggle-active',
        { documentId: documentId },
        function(response) {
          if (typeof showToast === 'function') {
            showToast('문서 상태가 변경되었습니다.', 'positive');
          }
          document.getElementById('document-detail-modal').close();
          loadDocuments();
        },
        function(xhr, status, error) {
          console.error('문서 상태 변경 오류:', error);
        }
      );
    }

    // 컬렉션 초기화 함수
    function initializeCollection() {
      sendFormRequest(
        '/api/chatbot/admin/init-collection',
        null,
        function(response) {
          if (typeof showToast === 'function') {
            showToast('벡터 컬렉션이 초기화되었습니다.', 'positive');
          }
        },
        function(xhr, status, error) {
          console.error('컬렉션 초기화 오류:', error);
        }
      );
    }

    // 전체 재처리 함수
    function reprocessAllDocuments() {
      // 로딩 표시
      if (typeof showToast === 'function') {
        showToast('문서 재처리를 시작했습니다. 잠시만 기다려주세요...', 'info');
      }

      // 버튼 비활성화
      $('#reprocess-all-btn').prop('disabled', true).addClass('loading');

      sendFormRequest(
        '/api/chatbot/admin/reprocess-all',
        null,
        function(response) {
          // 버튼 활성화
          $('#reprocess-all-btn').prop('disabled', false).removeClass('loading');

          const totalCount = response.totalCount || 0;
          const successCount = response.successCount || 0;
          const failCount = response.failCount || 0;

          let message = `전체 재처리 완료: 총 ${totalCount}개 (성공: ${successCount}, 실패: ${failCount})`;
          
          if (typeof showToast === 'function') {
            showToast(message, failCount > 0 ? 'warning' : 'positive');
          }

          // 문서 목록 새로고침
          loadDocuments();
        },
        function(xhr, status, error) {
          // 버튼 활성화
          $('#reprocess-all-btn').prop('disabled', false).removeClass('loading');
          
          console.error('전체 재처리 오류:', error);
          if (typeof showToast === 'function') {
            showToast('전체 재처리 중 오류가 발생했습니다.', 'negative');
          }
        }
      );
    }

    // 서버 설정 로드 함수
    function loadServerSettings() {
      // 청크 크기 로드
      sendFormRequest(
        '/api/server-option/get',
        { optionKey: 'CHATBOT_CHUNK_SIZE' },
        function(response) {
          $('#chunk-size-input').val(response.optionValue || 3000);
        },
        function(xhr, status, error) {
          console.error('청크 크기 로드 오류:', error);
          $('#chunk-size-input').val(3000);
        }
      );

      // 청크 중첩 로드
      sendFormRequest(
        '/api/server-option/get',
        { optionKey: 'CHATBOT_CHUNK_OVERLAP' },
        function(response) {
          $('#chunk-overlap-input').val(response.optionValue || 300);
        },
        function(xhr, status, error) {
          console.error('청크 중첩 로드 오류:', error);
          $('#chunk-overlap-input').val(300);
        }
      );
    }

    // 서버 설정 저장 함수
    function saveServerSettings() {
      const chunkSize = $('#chunk-size-input').val();
      const chunkOverlap = $('#chunk-overlap-input').val();

      // 유효성 검사
      if (!chunkSize || chunkSize < 500 || chunkSize > 10000) {
        if (typeof showToast === 'function') {
          showToast('청크 크기는 500~10000 사이의 값이어야 합니다.', 'negative');
        }
        return;
      }

      if (!chunkOverlap || chunkOverlap < 0 || chunkOverlap > 1000) {
        if (typeof showToast === 'function') {
          showToast('청크 중첩은 0~1000 사이의 값이어야 합니다.', 'negative');
        }
        return;
      }

      // 청크 크기 저장
      sendFormRequest(
        '/api/server-option/update',
        { 
          optionKey: 'CHATBOT_CHUNK_SIZE',
          optionValue: chunkSize
        },
        function(response) {
          // 청크 중첩 저장
          sendFormRequest(
            '/api/server-option/update',
            { 
              optionKey: 'CHATBOT_CHUNK_OVERLAP',
              optionValue: chunkOverlap
            },
            function(response) {
              if (typeof showToast === 'function') {
                showToast('설정이 저장되었습니다. 전체 재처리를 실행하여 적용하세요.', 'positive');
              }
              document.getElementById('settings-modal').close();
            },
            function(xhr, status, error) {
              console.error('청크 중첩 저장 오류:', error);
              if (typeof showToast === 'function') {
                showToast('설정 저장 중 오류가 발생했습니다.', 'negative');
              }
            }
          );
        },
        function(xhr, status, error) {
          console.error('청크 크기 저장 오류:', error);
          if (typeof showToast === 'function') {
            showToast('설정 저장 중 오류가 발생했습니다.', 'negative');
          }
        }
      );
    }

    // 문서 폼 초기화 함수
    function resetDocumentForm() {
      $('#document-id').val('');
      $('#document-title').val('');
      $('#document-category').val('site-info');
      $('#document-content').val('');
      $('#document-description').val('');
    }
  });
</script>
</body>
</html>
