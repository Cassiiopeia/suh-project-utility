<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head(title='Grass Planter - GitHub 자동 커밋 관리')}"></head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="ui container grass-planter-dashboard" id="main-content">
    <!-- 페이지 헤더 -->
    <div class="ui segment">
        <h2 class="ui header">
            <i class="github icon"></i>
            <div class="content">
                Grass Planter
                <div class="sub header">GitHub 자동 커밋 관리 시스템</div>
            </div>
        </h2>
    </div>

    <!-- 프로필 카드 섹션 -->
    <div class="ui segment">
        <div class="header-with-button">
            <div>
                <h3 class="grass-section-header">
                    <i class="github icon"></i>
                    프로필 목록
                </h3>
                <p class="dashboard-section-description">등록된 GitHub 프로필 관리</p>
            </div>
            <button class="ui primary button" onclick="showAddProfileModal()">
                <i class="plus icon"></i> 프로필 추가
            </button>
        </div>

        <div class="ui four column doubling stackable grid">
            <!-- 프로필 카드들 -->
            <div class="column" th:each="profile : ${profiles}">
                <div class="ui fluid card equal-height-card">
                    <div class="content">
                        <!-- 프로필 헤더 -->
                        <div class="grass-profile-header">
                            <div class="profile-name">
                                <i class="github icon"></i>
                                <span th:text="${profile.githubUsername}">username</span>
                            </div>
                            <div>
                                <div th:if="${profile.isActive}" class="ui green circular mini label">활성</div>
                                <div th:unless="${profile.isActive}" class="ui grey circular mini label">비활성</div>
                            </div>
                        </div>
                        
                        <!-- 저장소 이름 -->
                        <div class="meta">
                            <span class="date" th:text="${profile.defaultRepositoryName ?: 'No repository'}">repository</span>
                        </div>
                        
                        <!-- 주요 정보 영역 -->
                        <div class="grass-profile-info">
                            <div class="info-item">
                                <i class="clock icon"></i>
                                <span th:text="${profile.isAutoCommitEnabled ? '자동 커밋' : '수동 커밋'}">자동 커밋</span>
                            </div>
                            
                            <div class="contribution-level-display">
                                <span class="contribution-level" th:classappend="'level-' + ${profile.targetCommitLevel ?: 0}"></span>
                                <span class="level-text">레벨 <span th:text="${profile.targetCommitLevel ?: 0}">1</span></span>
                            </div>
                            
                            <div class="info-item">
                                <i class="user icon"></i>
                                <span th:text="${profile.ownerNickname ?: '미지정'}">Cassiopeia</span>
                            </div>
                        </div>
                        
                        <!-- 버튼 영역 -->
                        <div class="grass-profile-actions">
                            <button class="ui circular icon green button" 
                                    th:data-profile-id="${profile.grassProfileId}"
                                    onclick="executeCommit(this.getAttribute('data-profile-id'))"
                                    data-tooltip="커밋 실행"
                                    data-position="top center">
                                <i class="play icon"></i>
                            </button>
                            <button class="ui circular icon blue button" 
                                    th:data-profile-id="${profile.grassProfileId}"
                                    onclick="editProfile(this.getAttribute('data-profile-id'))"
                                    data-tooltip="프로필 수정"
                                    data-position="top center">
                                <i class="edit icon"></i>
                            </button>
                            <button class="ui circular icon red button" 
                                    th:data-profile-id="${profile.grassProfileId}"
                                    onclick="deleteProfile(this.getAttribute('data-profile-id'))"
                                    data-tooltip="프로필 삭제"
                                    data-position="top center">
                                <i class="trash icon"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 커밋 로그 섹션 -->
    <div class="ui segment">
        <div class="header-with-button">
            <div>
                <h3 class="grass-section-header">
                    <i class="history icon"></i>
                    커밋 로그
                </h3>
                <p class="dashboard-section-description">최근 커밋 기록</p>
            </div>
            <button class="ui blue button" onclick="loadCommitLogs()">
                <i class="refresh icon"></i> 새로고침
            </button>
        </div>
        
        <table class="ui celled table commit-log-table">
            <thead>
                <tr>
                    <th>시간</th>
                    <th>프로필</th>
                    <th>저장소</th>
                    <th>메시지</th>
                    <th>상태</th>
                    <th>레벨</th>
                </tr>
            </thead>
            <tbody id="commitLogTable">
                <tr>
                    <td colspan="6" class="center aligned">
                        <div class="ui active inline loader"></div>
                        로그 로딩 중...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- 프로필 추가/수정 모달 -->
    <div class="ui modal" id="profileModal">
        <i class="close icon"></i>
        <div class="header">
            <i class="github icon"></i>
            GitHub 프로필 설정
        </div>
        <div class="content">
            <form class="ui form" id="profileForm">
                <input type="hidden" id="profileId" name="profileId">
                
                <div class="two fields">
                    <div class="field">
                        <label>GitHub 사용자명</label>
                        <input type="text" id="githubUsername" name="githubUsername" 
                               placeholder="예: octocat" required>
                    </div>
                    <div class="field">
                        <label>Personal Access Token (PAT)</label>
                        <input type="password" id="personalAccessToken" name="personalAccessToken" 
                               placeholder="ghp_xxxxxxxxxxxx">
                    </div>
                </div>
                
                <div class="two fields">
                    <div class="field">
                        <label>저장소 전체 이름</label>
                        <input type="text" id="repositoryFullName" name="repositoryFullName" 
                               placeholder="예: username/repository">
                    </div>
                    <div class="field">
                        <label>목표 커밋 레벨</label>
                        <select class="ui dropdown" id="targetCommitLevel" name="targetCommitLevel">
                            <option value="1">레벨 1 (연한 녹색)</option>
                            <option value="2">레벨 2 (녹색)</option>
                            <option value="3">레벨 3 (진한 녹색)</option>
                            <option value="4">레벨 4 (매우 진한 녹색)</option>
                        </select>
                    </div>
                </div>
                
                <div class="two fields">
                    <div class="field">
                        <label>담당자 닉네임</label>
                        <input type="text" id="ownerNickname" name="ownerNickname" 
                               placeholder="담당자 이름">
                    </div>
                    <div class="field">
                        <label>설정</label>
                        <div class="ui segment">
                            <div class="ui toggle checkbox">
                                <input type="checkbox" id="isActive" name="isActive" checked>
                                <label>프로필 활성화</label>
                            </div>
                            <br><br>
                            <div class="ui toggle checkbox">
                                <input type="checkbox" id="isAutoCommitEnabled" name="isAutoCommitEnabled">
                                <label>자동 커밋 활성화</label>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="actions">
            <div class="ui black deny button">
                취소
            </div>
            <div class="ui positive right labeled icon button" onclick="saveProfile()">
                저장
                <i class="checkmark icon"></i>
            </div>
        </div>
    </div>

    <!-- 커밋 실행 모달 -->
    <div class="ui small modal" id="commitModal">
        <i class="close icon"></i>
        <div class="header">
            <i class="play icon"></i>
            수동 커밋 실행
        </div>
        <div class="content">
            <form class="ui form" id="commitForm">
                <input type="hidden" id="commitProfileId" name="profileId">
                <div class="field">
                    <label>커밋 메시지</label>
                    <textarea id="commitMessage" name="commitMessage" rows="3" 
                              placeholder="커밋 메시지를 입력하세요..."></textarea>
                </div>
            </form>
        </div>
        <div class="actions">
            <div class="ui black deny button">
                취소
            </div>
            <div class="ui positive right labeled icon button" onclick="confirmCommit()">
                실행
                <i class="play icon"></i>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<script>
    // 프로필 추가 모달 표시
    function showAddProfileModal() {
        $('#profileForm')[0].reset();
        $('#profileId').val('');
        $('#profileModal').modal('show');
    }

    // 프로필 수정
    function editProfile(profileId) {
        // TODO: 프로필 정보 로드 후 모달 표시
        $('#profileId').val(profileId);
        $('#profileModal').modal('show');
    }

    // 프로필 저장
    function saveProfile() {
        const formData = new FormData($('#profileForm')[0]);
        const profileId = $('#profileId').val();
        const url = profileId ? '/api/grass/profile/update' : '/api/grass/profile/create';
        
        // 체크박스 값 처리
        formData.set('isActive', $('#isActive').is(':checked'));
        formData.set('isAutoCommitEnabled', $('#isAutoCommitEnabled').is(':checked'));
        
        // defaultRepositoryId와 ownerId 임시 설정 (실제로는 선택 UI 필요)
        formData.set('defaultRepositoryId', generateUUID());
        formData.set('ownerId', generateUUID());
        
        $.ajax({
            url: url,
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.isSuccess) {
                    alert('프로필이 저장되었습니다.');
                    location.reload();
                } else {
                    alert('오류: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                alert('프로필 저장 중 오류가 발생했습니다.');
                console.error(error);
            }
        });
    }

    // 프로필 삭제
    function deleteProfile(profileId) {
        if (confirm('정말로 이 프로필을 삭제하시겠습니까?')) {
            const formData = new FormData();
            formData.append('profileId', profileId);
            
            $.ajax({
                url: '/api/grass/profile/delete',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.isSuccess) {
                        alert('프로필이 삭제되었습니다.');
                        location.reload();
                    } else {
                        alert('오류: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('프로필 삭제 중 오류가 발생했습니다.');
                    console.error(error);
                }
            });
        }
    }

    // 커밋 실행
    function executeCommit(profileId) {
        $('#commitProfileId').val(profileId);
        $('#commitMessage').val('Manual commit from GrassPlanter');
        $('#commitModal').modal('show');
    }

    // 커밋 확인
    function confirmCommit() {
        const formData = new FormData($('#commitForm')[0]);
        
        $.ajax({
            url: '/api/grass/commit/execute',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.isSuccess) {
                    alert('커밋이 성공적으로 실행되었습니다.');
                    $('#commitModal').modal('hide');
                    loadCommitLogs();
                } else {
                    alert('커밋 실패: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                alert('커밋 실행 중 오류가 발생했습니다.');
                console.error(error);
            }
        });
    }

    // UUID 생성 헬퍼
    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    // 커밋 로그 로드
    function loadCommitLogs() {
        const formData = new FormData();
        formData.append('page', 0);
        formData.append('size', 20);
        
        $.ajax({
            url: '/api/grass/commit/logs',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.isSuccess && response.commitLogs) {
                    displayCommitLogs(response.commitLogs);
                } else {
                    $('#commitLogTable').html('<tr><td colspan="6" class="center aligned">로그를 불러올 수 없습니다.</td></tr>');
                }
            },
            error: function(xhr, status, error) {
                console.error('커밋 로그 로드 실패:', error);
                $('#commitLogTable').html('<tr><td colspan="6" class="center aligned">로그 로드 중 오류가 발생했습니다.</td></tr>');
            }
        });
    }
    
    // 커밋 로그 표시
    function displayCommitLogs(logs) {
        if (logs.length === 0) {
            $('#commitLogTable').html('<tr><td colspan="6" class="center aligned">커밋 로그가 없습니다.</td></tr>');
            return;
        }
        
        let html = '';
        logs.forEach(function(log) {
            const statusLabel = log.isSuccess 
                ? '<div class="ui green label">성공</div>' 
                : '<div class="ui red label">실패</div>';
                
            const levelColor = 'level-' + (log.commitLevel || 0);
            const levelBlock = '<span class="contribution-level ' + levelColor + '"></span>';
            
            const commitTime = log.commitTime ? new Date(log.commitTime).toLocaleString('ko-KR') : '-';
            
            html += '<tr>';
            html += '<td>' + commitTime + '</td>';
            html += '<td>' + (log.githubUsername || '-') + '</td>';
            html += '<td>' + (log.repositoryName || '-') + '</td>';
            html += '<td>' + (log.commitMessage || '-') + '</td>';
            html += '<td>' + statusLabel + '</td>';
            html += '<td class="contribution-level-cell">' + levelBlock + ' Level ' + (log.commitLevel || 0) + '</td>';
            html += '</tr>';
        });
        
        $('#commitLogTable').html(html);
    }

    // 초기화
    $(document).ready(function() {
        $('.ui.dropdown').dropdown();
        $('.ui.checkbox').checkbox();
        loadCommitLogs(); // 페이지 로드 시 커밋 로그 로드
    });
</script>
</body>
</html>