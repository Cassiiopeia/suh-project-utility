<!-- src/main/resources/templates/pages/noticeManagement.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head(title='공지사항 관리-SAECHAN-LAB')}"></head>
<body class="notice-management-page bg-gray-50">
<div th:replace="~{fragments/header :: header}"></div>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" id="main-content">
  <!-- 페이지 헤더 -->
  <div class="mb-6">
    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
      <i class="fa-solid fa-bullhorn text-blue-500"></i>
      공지사항 관리
    </h2>
    <p class="text-gray-500 mt-1">대시보드에 표시되는 공지사항을 관리합니다.</p>
  </div>

  <!-- 공지사항 관리 툴바 -->
  <div class="card bg-base-100 shadow-sm border border-gray-100 mb-6">
    <div class="card-body p-4">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <!-- 검색 영역 -->
        <div class="join w-full lg:w-auto">
          <input type="text" id="search-keyword" class="input join-item w-full lg:w-64" placeholder="검색어를 입력하세요...">
          <select class="select join-item" id="search-type">
            <option value="title">제목</option>
            <option value="content">내용</option>
          </select>
          <button class="btn btn-primary join-item" id="search-btn">
            <i class="fa-solid fa-search"></i>
            검색
          </button>
        </div>
        <!-- 버튼 영역 -->
        <div class="flex gap-2">
          <button class="btn btn-primary" id="create-btn">
            <i class="fa-solid fa-plus"></i>
            새 공지사항
          </button>
          <button class="btn btn-outline" id="refresh-btn">
            <i class="fa-solid fa-rotate"></i>
            새로고침
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 공지사항 목록 테이블 -->
  <div class="card bg-base-100 shadow-sm border border-gray-100">
    <div class="card-body p-4">
      <div id="loading-indicator" class="flex justify-center py-8">
        <span class="loading loading-spinner loading-lg text-primary"></span>
      </div>
      <div id="error-message" class="alert alert-error hidden">
        <i class="fa-solid fa-circle-exclamation"></i>
        <div>
          <h3 class="font-bold">데이터 로드 실패</h3>
          <span>공지사항을 불러오는 중 오류가 발생했습니다. 새로고침을 시도해주세요.</span>
        </div>
      </div>
      <div id="empty-message" class="alert alert-info hidden">
        <i class="fa-solid fa-info-circle"></i>
        <div>
          <h3 class="font-bold">공지사항이 없습니다</h3>
          <span>새 공지사항을 추가해주세요.</span>
        </div>
      </div>
      <div id="table-container" class="hidden">
        <div class="overflow-x-auto">
          <table class="table table-zebra">
            <thead>
              <tr>
                <th>제목</th>
                <th>중요</th>
                <th>활성화</th>
                <th>작성자</th>
                <th>게시 시작일</th>
                <th>게시 종료일</th>
                <th>조회수</th>
                <th>작성일</th>
                <th>관리</th>
              </tr>
            </thead>
            <tbody id="notice-table-body">
            </tbody>
          </table>
        </div>
        <div id="notice-pagination" class="flex justify-center mt-4"></div>
      </div>
    </div>
  </div>

  <!-- 공지사항 등록/수정 모달 -->
  <dialog class="modal" id="notice-modal">
    <div class="modal-box max-w-2xl">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </form>
      <h3 class="font-bold text-lg mb-4" id="modal-title">공지사항 등록</h3>
      <form id="notice-form" class="space-y-4">
        <input type="hidden" id="notice-id">
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">제목</span>
          </label>
          <input type="text" id="notice-title" class="input w-full" placeholder="제목을 입력하세요">
        </div>
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">내용</span>
          </label>
          <textarea id="notice-content" class="textarea h-40" placeholder="내용을 입력하세요"></textarea>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">게시 시작일</span>
            </label>
            <input type="datetime-local" id="notice-start-date" class="input w-full">
          </div>
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">게시 종료일</span>
            </label>
            <input type="datetime-local" id="notice-end-date" class="input w-full">
          </div>
        </div>
        <div class="flex flex-wrap gap-6">
          <label class="label cursor-pointer gap-2">
            <input type="checkbox" id="notice-important" class="checkbox checkbox-primary">
            <span class="label-text">중요 공지</span>
          </label>
          <label class="label cursor-pointer gap-2">
            <input type="checkbox" id="notice-active" class="checkbox checkbox-primary" checked>
            <span class="label-text">활성화</span>
          </label>
        </div>
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">작성자</span>
          </label>
          <input type="text" id="notice-author" class="input w-full" placeholder="작성자를 입력하세요">
        </div>
      </form>
      <div class="modal-action">
        <form method="dialog">
          <button class="btn btn-ghost">취소</button>
        </form>
        <button class="btn btn-primary" id="save-btn">저장</button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <!-- 공지사항 상세 모달 -->
  <dialog class="modal" id="notice-detail-modal">
    <div class="modal-box max-w-3xl">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </form>
      <h3 class="font-bold text-xl mb-4" id="detail-title"></h3>

      <!-- 메타 정보 -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 rounded-lg p-4 mb-4">
        <div class="space-y-2">
          <p class="flex items-center gap-2 text-gray-600">
            <i class="fa-solid fa-user text-blue-500"></i>
            <strong>작성자:</strong>
            <span id="detail-author"></span>
          </p>
          <p class="flex items-center gap-2 text-gray-600">
            <i class="fa-solid fa-calendar text-blue-500"></i>
            <strong>작성일:</strong>
            <span id="detail-created-date"></span>
          </p>
        </div>
        <div class="space-y-2">
          <p class="flex items-center gap-2 text-gray-600">
            <i class="fa-solid fa-eye text-blue-500"></i>
            <strong>조회수:</strong>
            <span id="detail-view-count"></span>
          </p>
          <p class="flex items-center gap-2 text-gray-600">
            <i class="fa-solid fa-clock text-blue-500"></i>
            <strong>게시 기간:</strong>
            <span id="detail-period"></span>
          </p>
          <p class="flex items-center gap-2 text-gray-600">
            <i class="fa-solid fa-circle-check text-blue-500"></i>
            <strong>상태:</strong>
            <span id="detail-status"></span>
          </p>
        </div>
      </div>

      <div class="divider"></div>

      <!-- 내용 -->
      <div class="prose max-w-none" id="detail-content"></div>

      <div class="divider"></div>

      <!-- 댓글 섹션 -->
      <h4 class="font-bold text-lg flex items-center gap-2 mb-4">
        <i class="fa-solid fa-comments text-blue-500"></i>
        댓글
      </h4>

      <!-- 댓글 목록 -->
      <div id="comment-list" class="space-y-4 mb-6">
        <div id="comments-loading" class="flex justify-center py-4">
          <span class="loading loading-spinner loading-md text-primary"></span>
        </div>
        <div id="no-comments-message" class="alert alert-info hidden">
          <i class="fa-solid fa-info-circle"></i>
          <span>아직 댓글이 없습니다. 첫 번째 댓글을 작성해보세요!</span>
        </div>
      </div>

      <!-- 댓글 작성 폼 -->
      <div class="bg-gray-50 rounded-lg p-4">
        <div class="form-control mb-3">
          <input type="text" id="comment-author" class="input input-sm w-full max-w-xs" placeholder="이름을 입력하세요">
        </div>
        <div class="form-control mb-3">
          <textarea id="comment-content" class="textarea" placeholder="댓글을 입력하세요"></textarea>
        </div>
        <button type="button" id="comment-submit" class="btn btn-primary btn-sm">
          <i class="fa-solid fa-pen"></i>
          댓글 작성
        </button>
      </div>

      <div class="modal-action">
        <button class="btn btn-primary" id="edit-btn">
          <i class="fa-solid fa-pen-to-square"></i>
          수정
        </button>
        <button class="btn btn-error" id="delete-btn">
          <i class="fa-solid fa-trash"></i>
          삭제
        </button>
        <button class="btn btn-outline" id="toggle-active-btn">
          <i class="fa-solid fa-power-off"></i>
          활성화/비활성화
        </button>
        <form method="dialog">
          <button class="btn btn-ghost">닫기</button>
        </form>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<script>
  $(document).ready(function() {
    // 전역 변수
    let allNotices = [];
    let filteredNotices = [];
    let currentPage = 1;
    const pageSize = 10;

    // 공지사항 목록 로드
    loadNotices();

    // 새로고침 버튼 클릭 이벤트
    $('#refresh-btn').click(function() {
      loadNotices();
    });

    // 검색 버튼 클릭 이벤트
    $('#search-btn').click(function() {
      const keyword = $('#search-keyword').val();
      const type = $('#search-type').val();

      if (keyword) {
        searchNotices(keyword, type);
      } else {
        loadNotices();
      }
    });

    // 검색 입력 필드에서 엔터 키 이벤트
    $('#search-keyword').keypress(function(e) {
      if (e.which === 13) {
        $('#search-btn').click();
      }
    });

    // 새 공지사항 버튼 클릭 이벤트
    $('#create-btn').click(function() {
      resetNoticeForm();
      $('#modal-title').text('공지사항 등록');
      document.getElementById('notice-modal').showModal();
    });

    // 저장 버튼 클릭 이벤트
    $('#save-btn').click(function() {
      saveNotice();
    });

    // 수정 버튼 클릭 이벤트
    $('#edit-btn').click(function() {
      const noticeId = $('#detail-title').data('id');
      editNotice(noticeId);
    });

    // 삭제 버튼 클릭 이벤트
    $('#delete-btn').click(function() {
      const noticeId = $('#detail-title').data('id');
      if (confirm('정말로 이 공지사항을 삭제하시겠습니까?')) {
        deleteNotice(noticeId);
      }
    });

    // 활성화/비활성화 버튼 클릭 이벤트
    $('#toggle-active-btn').click(function() {
      const noticeId = $('#detail-title').data('id');
      toggleNoticeActive(noticeId);
    });

    // 테이블 row 클릭 이벤트 (이벤트 위임)
    $(document).on('click', '#notice-table-body tr', function(e) {
      // 액션 버튼 클릭 시는 무시
      if ($(e.target).closest('button, a').length > 0) {
        return;
      }
      const noticeId = $(this).data('notice-id');
      if (noticeId) {
        const notice = allNotices.find(n => n.noticeId === noticeId);
        if (notice) {
          showNoticeDetail(notice);
        }
      }
    });

    // 액션 버튼 클릭 이벤트 (이벤트 위임)
    $(document).on('click', '.view-btn', function(e) {
      e.stopPropagation();
      const noticeId = $(this).closest('tr').data('notice-id');
      const notice = allNotices.find(n => n.noticeId === noticeId);
      if (notice) {
        showNoticeDetail(notice);
      }
    });

    $(document).on('click', '.edit-row-btn', function(e) {
      e.stopPropagation();
      const noticeId = $(this).closest('tr').data('notice-id');
      editNotice(noticeId);
    });

    $(document).on('click', '.delete-row-btn', function(e) {
      e.stopPropagation();
      const noticeId = $(this).closest('tr').data('notice-id');
      if (confirm('정말로 이 공지사항을 삭제하시겠습니까?')) {
        deleteNotice(noticeId);
      }
    });

    // 페이지네이션 클릭 이벤트
    $(document).on('click', '.pagination-btn', function(e) {
      e.preventDefault();
      const page = parseInt($(this).data('page'));
      if (page >= 1 && page !== currentPage) {
        currentPage = page;
        renderTable(filteredNotices.length > 0 ? filteredNotices : allNotices);
      }
    });

    // 공지사항 목록 로드 함수
    function loadNotices() {
      $('#loading-indicator').show();
      $('#error-message').addClass('hidden');
      $('#empty-message').addClass('hidden');
      $('#table-container').addClass('hidden');

      sendFormRequest(
        '/api/notice/get/all',
        null,
        function(response) {
          $('#loading-indicator').hide();
          if (response && response.notices) {
            allNotices = response.notices;
            filteredNotices = [];
            currentPage = 1;
            renderTable(allNotices);
          } else {
            $('#error-message').removeClass('hidden');
            console.error('공지사항 로드 실패:', response);
          }
        },
        function(xhr, status, error) {
          $('#loading-indicator').hide();
          $('#error-message').removeClass('hidden');
          console.error('공지사항 로드 오류:', error);
        }
      );
    }

    // 공지사항 검색 함수
    function searchNotices(keyword, type) {
      $('#loading-indicator').show();
      $('#error-message').addClass('hidden');
      $('#empty-message').addClass('hidden');
      $('#table-container').addClass('hidden');

      sendFormRequest(
        '/api/notice/search',
        {
          searchKeyword: keyword,
          searchType: type
        },
        function(response) {
          $('#loading-indicator').hide();
          if (response && response.notices) {
            filteredNotices = response.notices;
            currentPage = 1;
            renderTable(filteredNotices);
          } else {
            $('#error-message').removeClass('hidden');
            console.error('검색 실패:', response);
          }
        },
        function(xhr, status, error) {
          $('#loading-indicator').hide();
          $('#error-message').removeClass('hidden');
          console.error('검색 오류:', error);
        }
      );
    }

    // 테이블 렌더링 함수
    function renderTable(notices) {
      if (!notices || notices.length === 0) {
        $('#table-container').addClass('hidden');
        $('#empty-message').removeClass('hidden');
        return;
      }

      $('#empty-message').addClass('hidden');
      $('#table-container').removeClass('hidden');

      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = startIndex + pageSize;
      const pageData = notices.slice(startIndex, endIndex);

      let html = '';
      pageData.forEach(function(notice) {
        const titleHtml = notice.isImportant 
          ? `<i class="fa-solid fa-bell text-red-500 mr-1"></i> ${escapeHtml(notice.title)}`
          : escapeHtml(notice.title);
        
        const importantIcon = notice.isImportant 
          ? '<i class="fa-solid fa-check text-green-500"></i>' 
          : '<i class="fa-solid fa-times text-red-500"></i>';
        
        const activeIcon = notice.isActive 
          ? '<i class="fa-solid fa-check text-green-500"></i>' 
          : '<i class="fa-solid fa-times text-red-500"></i>';

        const startDate = notice.startDate ? formatDateTime(notice.startDate) : '-';
        const endDate = notice.endDate ? formatDateTime(notice.endDate) : '무기한';
        const createdDate = formatDateTime(notice.createdDate);

        html += `
          <tr class="hover:bg-base-300 cursor-pointer" data-notice-id="${notice.noticeId}">
            <td>${titleHtml}</td>
            <td class="text-center">${importantIcon}</td>
            <td class="text-center">${activeIcon}</td>
            <td>${escapeHtml(notice.author || '익명')}</td>
            <td>${startDate}</td>
            <td>${endDate}</td>
            <td class="text-center">${notice.viewCount || 0}</td>
            <td>${createdDate}</td>
            <td>
              <div class="flex gap-1">
                <button class="btn btn-xs btn-info view-btn" title="상세보기">
                  <i class="fa-solid fa-eye"></i>
                </button>
                <button class="btn btn-xs btn-success edit-row-btn" title="수정">
                  <i class="fa-solid fa-pen"></i>
                </button>
                <button class="btn btn-xs btn-error delete-row-btn" title="삭제">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      });

      $('#notice-table-body').html(html);
      renderPagination(notices.length);
    }

    // 페이지네이션 렌더링 함수
    function renderPagination(totalItems) {
      const totalPages = Math.ceil(totalItems / pageSize);
      
      if (totalPages <= 1) {
        $('#notice-pagination').empty();
        return;
      }

      let html = '<div class="join">';
      
      // 이전 페이지 버튼
      html += `<button class="join-item btn btn-sm ${currentPage === 1 ? 'btn-disabled' : ''}" 
               data-page="${currentPage - 1}" 
               ${currentPage === 1 ? 'disabled' : ''}>
               <i class="fa-solid fa-angle-left"></i>
               </button>`;
      
      // 페이지 번호 버튼
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
          html += `<button class="join-item btn btn-sm pagination-btn ${i === currentPage ? 'btn-active' : ''}" 
                   data-page="${i}">${i}</button>`;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
          html += '<span class="join-item btn btn-sm btn-disabled">...</span>';
        }
      }
      
      // 다음 페이지 버튼
      html += `<button class="join-item btn btn-sm ${currentPage === totalPages ? 'btn-disabled' : ''}" 
               data-page="${currentPage + 1}" 
               ${currentPage === totalPages ? 'disabled' : ''}>
               <i class="fa-solid fa-angle-right"></i>
               </button>`;
      
      html += '</div>';
      $('#notice-pagination').html(html);
    }

    // 날짜 포맷 함수
    function formatDateTime(dateStr) {
      if (!dateStr) return '-';
      return new Date(dateStr).toLocaleString('ko-KR');
    }

    // HTML 이스케이프 함수
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // 공지사항 저장 함수
    function saveNotice() {
      const noticeId = $('#notice-id').val();
      const title = $('#notice-title').val();
      const content = $('#notice-content').val();
      const startDate = $('#notice-start-date').val();
      const endDate = $('#notice-end-date').val();
      const isImportant = $('#notice-important').prop('checked');
      const isActive = $('#notice-active').prop('checked');
      const author = $('#notice-author').val();

      if (!title || !content) {
        if (typeof showToast === 'function') {
          showToast('제목과 내용을 입력해주세요.', 'warning');
        }
        return;
      }

      sendFormRequest(
        noticeId ? '/api/notice/update' : '/api/notice/create',
        {
          noticeId: noticeId || undefined,
          title: title,
          content: content,
          startDate: startDate || undefined,
          endDate: endDate || undefined,
          isImportant: isImportant,
          isActive: isActive,
          author: author || undefined
        },
        function(response) {
          if (response) {
            if (typeof showToast === 'function') {
              showToast(response.message || '공지사항이 저장되었습니다.', 'positive');
            }
            document.getElementById('notice-modal').close();
            loadNotices();
          } else {
            if (typeof showToast === 'function') {
              showToast('저장 실패: 알 수 없는 오류', 'negative');
            }
          }
        },
        function(xhr, status, error) {
          console.error('공지사항 저장 오류:', error);
        }
      );
    }

    // 공지사항 상세 정보 표시 함수
    function showNoticeDetail(notice) {
      $('#detail-title').text(notice.title).data('id', notice.noticeId);
      $('#detail-author').text(notice.author || '익명');
      $('#detail-view-count').text(notice.viewCount || 0);
      $('#detail-created-date').text(formatDateTime(notice.createdDate));

      const startDate = notice.startDate ? formatDateTime(notice.startDate) : '-';
      const endDate = notice.endDate ? formatDateTime(notice.endDate) : '무기한';
      $('#detail-period').text(startDate + ' ~ ' + endDate);

      const statusClass = notice.isActive ? 'badge-success' : 'badge-error';
      const statusText = notice.isActive ? '활성화' : '비활성화';
      $('#detail-status').html(`<span class="badge ${statusClass}">${statusText}</span>`);

      $('#detail-content').html(notice.content.replace(/\n/g, '<br>'));

      // 버튼 상태 업데이트
      $('#toggle-active-btn').html(`<i class="fa-solid fa-power-off"></i> ${notice.isActive ? '비활성화' : '활성화'}`);

      // 댓글 목록 불러오기
      loadComments(notice.noticeId);

      // 댓글 폼 초기화
      $('#comment-author').val('');
      $('#comment-content').val('');

      document.getElementById('notice-detail-modal').showModal();
    }

    // 공지사항 수정 함수
    function editNotice(noticeId) {
      sendFormRequest(
        '/api/notice/get/detail',
        { noticeId: noticeId },
        function(response) {
          if (response) {
            const notice = response;

            $('#notice-id').val(notice.noticeId);
            $('#notice-title').val(notice.title);
            $('#notice-content').val(notice.content);

            if (notice.startDate) {
              $('#notice-start-date').val(formatDateTimeForInput(notice.startDate));
            } else {
              $('#notice-start-date').val('');
            }

            if (notice.endDate) {
              $('#notice-end-date').val(formatDateTimeForInput(notice.endDate));
            } else {
              $('#notice-end-date').val('');
            }

            $('#notice-important').prop('checked', notice.isImportant);
            $('#notice-active').prop('checked', notice.isActive);
            $('#notice-author').val(notice.author);

            $('#modal-title').text('공지사항 수정');
            document.getElementById('notice-detail-modal').close();
            document.getElementById('notice-modal').showModal();
          } else {
            if (typeof showToast === 'function') {
              showToast('공지사항 정보를 불러올 수 없습니다.', 'negative');
            }
          }
        },
        function(xhr, status, error) {
          console.error('공지사항 정보 로드 오류:', error);
        }
      );
    }

    // 공지사항 삭제 함수
    function deleteNotice(noticeId) {
      sendFormRequest(
        '/api/notice/delete',
        { noticeId: noticeId },
        function(response) {
          if (response) {
            if (typeof showToast === 'function') {
              showToast(response.message || '공지사항이 삭제되었습니다.', 'positive');
            }
            document.getElementById('notice-detail-modal').close();
            loadNotices();
          } else {
            if (typeof showToast === 'function') {
              showToast('삭제 실패: 알 수 없는 오류', 'negative');
            }
          }
        },
        function(xhr, status, error) {
          console.error('공지사항 삭제 오류:', error);
        }
      );
    }

    // 공지사항 활성화/비활성화 함수
    function toggleNoticeActive(noticeId) {
      sendFormRequest(
        '/api/notice/toggle-active',
        { noticeId: noticeId },
        function(response) {
          if (response) {
            if (typeof showToast === 'function') {
              showToast(response.message || '상태가 변경되었습니다.', 'positive');
            }
            document.getElementById('notice-detail-modal').close();
            loadNotices();
          } else {
            if (typeof showToast === 'function') {
              showToast('상태 변경 실패: 알 수 없는 오류', 'negative');
            }
          }
        },
        function(xhr, status, error) {
          console.error('공지사항 상태 변경 오류:', error);
        }
      );
    }

    // 공지사항 폼 초기화 함수
    function resetNoticeForm() {
      $('#notice-id').val('');
      $('#notice-title').val('');
      $('#notice-content').val('');
      $('#notice-start-date').val('');
      $('#notice-end-date').val('');
      $('#notice-important').prop('checked', false);
      $('#notice-active').prop('checked', true);
      $('#notice-author').val('');
    }

    // 날짜 포맷 변환 함수
    function formatDateTimeForInput(dateTimeStr) {
      const date = new Date(dateTimeStr);
      return date.toISOString().slice(0, 16);
    }

    // 댓글 목록 로드 함수
    function loadComments(noticeId) {
      $('#comments-loading').show();
      $('#comment-list .comment-item').remove();
      $('#no-comments-message').addClass('hidden');

      sendFormRequest(
        '/api/notice/comment/list',
        { noticeId: noticeId },
        function(response) {
          $('#comments-loading').hide();

          if (response && response.noticeCommentDtos && response.noticeCommentDtos.length > 0) {
            response.noticeCommentDtos.forEach(function(comment) {
              const commentHtml = createCommentHtml(comment);
              $('#comment-list').append(commentHtml);
            });

            $('.delete-comment-btn').click(function() {
              const commentId = $(this).data('id');
              if (confirm('정말로 이 댓글을 삭제하시겠습니까?')) {
                deleteComment(commentId);
              }
            });
          } else {
            $('#no-comments-message').removeClass('hidden');
          }
        },
        function(xhr, status, error) {
          $('#comments-loading').hide();
          console.error('댓글 로드 오류:', error);
          $('#no-comments-message').removeClass('hidden').addClass('alert-error')
            .html('<i class="fa-solid fa-circle-exclamation"></i><span>댓글을 불러오는 중 오류가 발생했습니다.</span>');
        }
      );
    }

    // 댓글 HTML 생성 함수
    function createCommentHtml(comment) {
      const date = formatDateTime(comment.createdDate);
      return `
        <div class="comment-item bg-white border border-gray-200 rounded-lg p-4">
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
              <i class="fa-solid fa-user text-blue-500"></i>
            </div>
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                <span class="font-semibold text-gray-800">${escapeHtml(comment.author)}</span>
                ${comment.anonymizedIp ? `<span class="text-xs text-gray-400">(${escapeHtml(comment.anonymizedIp)})</span>` : ''}
                <span class="text-xs text-gray-400">${date}</span>
              </div>
              <p class="text-gray-700">${escapeHtml(comment.content)}</p>
              <div class="mt-2">
                <button class="btn btn-xs btn-error delete-comment-btn" data-id="${comment.noticeCommentId}">
                  <i class="fa-solid fa-trash"></i>
                  삭제
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // 댓글 작성 이벤트
    $('#comment-submit').click(function() {
      const noticeId = $('#detail-title').data('id');
      const authorName = $('#comment-author').val() || '익명';
      const content = $('#comment-content').val();

      if (!content) {
        if (typeof showToast === 'function') {
          showToast('댓글 내용을 입력해주세요.', 'warning');
        }
        return;
      }

      sendFormRequest(
        '/api/notice/comment/create',
        {
          noticeId: noticeId,
          commentAuthor: authorName,
          commentContent: content
        },
        function(response) {
          if (response) {
            $('#comment-content').val('');
            loadComments(noticeId);
          } else {
            if (typeof showToast === 'function') {
              showToast('댓글 등록 실패', 'negative');
            }
          }
        },
        function(xhr, status, error) {
          console.error('댓글 등록 오류:', error);
        }
      );
    });

    // 댓글 삭제 함수
    function deleteComment(commentId) {
      const noticeId = $('#detail-title').data('id');

      sendFormRequest(
        '/api/notice/comment/delete',
        { commentId: commentId },
        function(response) {
          if (response) {
            loadComments(noticeId);
          } else {
            if (typeof showToast === 'function') {
              showToast('댓글 삭제 실패', 'negative');
            }
          }
        },
        function(xhr, status, error) {
          console.error('댓글 삭제 오류:', error);
        }
      );
    }
  });
</script>
</body>
</html>
