<!-- src/main/resources/templates/pages/login.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head(title='로그인-SAECHAN-LAB')}"></head>
<body class="login-page">
<!-- 헤더 영역 -->
<div th:replace="~{fragments/header :: header}"></div>

<!-- 로그인 폼 영역 -->
<div class="flex justify-center px-4 mt-12">
  <div class="card bg-base-100 shadow-xl w-full max-w-md">
    <div class="card-body">
      <!-- 로고 영역 -->
      <div class="text-center mb-4">
        <img src="/images/로고_세로.png" alt="새찬 서버 로고" class="w-48 mx-auto">
      </div>

      <!-- 로그인 폼 -->
      <form th:action="@{/login}" method="post" id="loginForm" class="space-y-4">
        <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>

        <!-- 아이디 입력 -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">아이디</span>
          </label>
          <label class="input input-bordered flex items-center gap-2">
            <i class="fa-solid fa-user text-gray-400"></i>
            <input type="text" name="username" placeholder="아이디를 입력하세요" class="grow" />
          </label>
        </div>

        <!-- 비밀번호 입력 -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">비밀번호</span>
          </label>
          <label class="input input-bordered flex items-center gap-2">
            <i class="fa-solid fa-lock text-gray-400"></i>
            <input type="password" name="password" placeholder="비밀번호를 입력하세요" class="grow" />
          </label>
        </div>

        <!-- 로그인 버튼 -->
        <button type="submit" class="btn btn-primary w-full mt-6">
          <i class="fa-solid fa-right-to-bracket mr-2"></i>
          로그인
        </button>

        <!-- 에러 메시지 -->
        <div id="error-message" class="alert alert-error hidden">
          <i class="fa-solid fa-circle-exclamation"></i>
          <span></span>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 로그인 진행 시 보여줄 로딩 오버레이 -->
<div id="login-loading" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
  <div class="flex flex-col items-center gap-4">
    <span class="loading loading-spinner loading-lg text-primary"></span>
    <span class="text-white text-lg font-medium">로그인 중...</span>
  </div>
</div>

<script th:inline="javascript">
  // 페이지 로드 시 즉시 IP 정보 요청 시작
  const getClientIPPromise = $.getJSON('https://api.ipify.org?format=json');

  $(document).ready(function() {
    // DOM 로드 후 이벤트 리스너 설정
    setupLoginForm();

    // IP 정보 처리 (이미 요청 시작)
    getClientIPPromise
    .done(function(data) {
      processClientIP(data.ip);
    })
    .fail(function() {
      console.error("IP 주소를 가져오는 데 실패했습니다");
    });
  });

  function processClientIP(clientIP) {
    console.log("실제 클라이언트 IP:", clientIP);
    // AES 암호화
    const key = CryptoJS.enc.Utf8.parse(window.encryptionKey);
    const iv = CryptoJS.enc.Utf8.parse(window.encryptionIv);

    const encrypted = CryptoJS.AES.encrypt(clientIP, key, {
      iv: iv,
      mode: CryptoJS.mode.CBC,
      padding: CryptoJS.pad.Pkcs7
    });

    console.log("ClientHash 값:", encrypted.toString());
    window.clientHash = encrypted.toString();
  }

  function setupLoginForm() {
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
      loginForm.addEventListener('submit', function(e) {
        // 기존 필드 제거
        const existingField = this.querySelector('input[name="clientHash"]');
        if (existingField) existingField.remove();

        // clientHash 추가
        if (window.clientHash) {
          const hiddenField = document.createElement('input');
          hiddenField.type = 'hidden';
          hiddenField.name = 'clientHash';
          hiddenField.value = window.clientHash;
          this.appendChild(hiddenField);
        } else {
          console.warn("clientHash 값이 설정되지 않았습니다");
        }

        // 로딩 표시
        const loadingEl = document.getElementById('login-loading');
        loadingEl.classList.remove('hidden');
        loadingEl.classList.add('flex');
      });
    }
  }
</script>

<!-- footer fragment -->
<div th:replace="~{fragments/footer :: footer}"></div>
</body>
</html>
