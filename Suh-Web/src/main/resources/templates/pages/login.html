<!-- src/main/resources/templates/pages/login.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" data-theme="light">
<head th:replace="~{fragments/header :: head(title='Login - SAECHAN LAB')}"></head>
<body class="login-page min-h-screen flex flex-col bg-gradient-to-br from-slate-50 to-blue-50">
<!-- 헤더 영역 -->
<div th:replace="~{fragments/header :: header}"></div>

<!-- 로그인 폼 영역 -->
<main class="flex-1 flex items-center justify-center px-4 py-12">
  <div class="card bg-base-100 shadow-xl w-full max-w-md">
    <div class="card-body">
      <!-- 타이핑 효과 텍스트 -->
      <div class="text-center mb-2">
        <span id="typing-text" class="text-lg font-semibold text-gray-700"></span>
        <span id="typing-cursor" class="typing-cursor">|</span>
      </div>

      <!-- 로고 영역 -->
      <div class="text-center">
        <img src="/images/로고_세로.png" alt="새찬 서버 로고" class="w-48 mx-auto">
      </div>

      <!-- 개발자 프로필 배지 + 버전 배지 -->
      <div class="text-center flex justify-center gap-2 flex-wrap">
        <a href="/profile" class="badge badge-soft badge-primary gap-1 px-3 py-1 text-xs hover:opacity-80 transition-opacity">
          <i class="fa-solid fa-user-circle"></i>
          ABOUT ME
        </a>
        <button onclick="openChangelogModal()" class="badge gap-1 px-3 py-1 text-xs hover:opacity-80 transition-opacity cursor-pointer" style="background-color: #e9d5ff; color: #7c3aed; border: none;">
          <i class="fa-solid fa-code-branch"></i>
          <span id="version-tag">v1.0.0</span>
        </button>
      </div>

      <!-- 로그인 폼 -->
      <form th:action="@{/login}" method="post" id="loginForm" class="space-y-4">
        <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>

        <!-- 아이디 입력 -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">Username</span>
          </label>
          <div class="relative">
            <i class="fa-solid fa-user absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input type="text" name="username" placeholder="Enter your username"
                   class="input input-bordered w-full pl-5" />
          </div>
        </div>

        <!-- 비밀번호 입력 -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">Password</span>
          </label>
          <div class="relative">
            <i class="fa-solid fa-lock absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input type="password" id="passwordInput" name="password" placeholder="Enter your password"
                   class="input input-bordered w-full pl-5 pr-10" />
            <span id="togglePassword" class="absolute right-3 top-1/2 -translate-y-1/2 cursor-pointer hover:opacity-70">
              <i class="fa-solid fa-eye text-gray-400" id="eyeIcon"></i>
            </span>
          </div>
        </div>

        <!-- 에러 메시지 (로그인 실패 시 표시) -->
        <div th:if="${param.error}" class="flex items-center gap-2 p-3 rounded-lg border border-red-300 bg-red-50 text-red-600 text-sm">
          <i class="fa-solid fa-circle-exclamation"></i>
          <span>Invalid username or password.</span>
        </div>

        <!-- 로그인 버튼 -->
        <button type="submit" class="btn btn-primary w-full">
          <i class="fa-solid fa-right-to-bracket mr-2"></i>
          Sign In
        </button>
      </form>
    </div>
  </div>
</main>

<!-- 로그인 진행 시 보여줄 로딩 오버레이 -->
<div id="login-loading" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
  <div class="flex flex-col items-center gap-4">
    <span class="loading loading-spinner loading-lg text-primary"></span>
    <span class="text-white text-lg font-medium">Signing in...</span>
  </div>
</div>

<!-- Changelog 모달 -->
<dialog id="changelog-modal" class="modal">
  <div class="modal-box max-w-lg bg-base-100">
    <!-- 모달 헤더 -->
    <div class="flex items-start gap-4 mb-4">
      <div class="w-12 h-12 bg-primary/10 rounded-xl flex items-center justify-center flex-shrink-0">
        <i class="fa-solid fa-code-branch text-primary text-xl"></i>
      </div>
      <div class="flex-1">
        <h3 class="font-bold text-lg">Changelog</h3>
        <p class="text-sm text-gray-500">SUH Project Utility</p>
      </div>
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </form>
    </div>

    <!-- 최신 버전 정보 -->
    <div id="changelog-content" class="space-y-4">
      <!-- 로딩 스켈레톤 -->
      <div id="changelog-loading" class="space-y-3">
        <div class="skeleton h-6 w-32"></div>
        <div class="skeleton h-4 w-full"></div>
        <div class="skeleton h-4 w-3/4"></div>
        <div class="skeleton h-4 w-5/6"></div>
      </div>

      <!-- 실제 컨텐츠 (JS로 채움) -->
      <div id="changelog-data" class="hidden">
        <!-- 버전 헤더 -->
        <div class="flex items-center gap-2 mb-3">
          <span id="changelog-version" class="font-bold text-lg">v1.4.6</span>
          <span class="badge badge-soft badge-success text-xs">Latest</span>
          <span id="changelog-date" class="text-sm text-gray-500">2025-12-13</span>
        </div>

        <!-- 변경사항 목록 -->
        <ul id="changelog-items" class="space-y-2 text-sm text-gray-700">
          <!-- JS로 채워짐 -->
        </ul>
      </div>
    </div>

    <!-- 모달 푸터 -->
    <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200">
      <span id="changelog-updated" class="text-xs text-gray-400">Last updated: -</span>
      <a href="https://github.com/Cassiiopeia/suh-project-utility/blob/main/CHANGELOG.md"
         target="_blank"
         class="text-sm text-primary hover:underline flex items-center gap-1">
        View on GitHub
        <i class="fa-solid fa-arrow-right text-xs"></i>
      </a>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

<!-- footer fragment -->
<div th:replace="~{fragments/footer :: footer}"></div>

<script th:inline="javascript">
  // 페이지 로드 시 즉시 IP 정보 요청 시작
  const getClientIPPromise = $.getJSON('https://api.ipify.org?format=json');

  // 타이핑 효과 설정
  const typingText = "Welcome To SUH-LAB !!";
  let typingIndex = 0;

  $(document).ready(function() {
    // DOM 로드 후 이벤트 리스너 설정
    setupLoginForm();
    setupPasswordToggle();
    startTypingEffect();
    loadVersionFromChangelog();

    // IP 정보 처리 (이미 요청 시작)
    getClientIPPromise
    .done(function(data) {
      processClientIP(data.ip);
    })
    .fail(function() {
      console.error("IP 주소를 가져오는 데 실패했습니다");
    });
  });

  // 타이핑 효과 함수 (글자 아래 밑줄 스타일)
  function startTypingEffect() {
    const textElement = document.getElementById('typing-text');
    const cursorElement = document.getElementById('typing-cursor');

    if (!textElement) return;

    function typeNextChar() {
      if (typingIndex < typingText.length) {
        // 이전 글자의 밑줄 제거
        const prevChar = textElement.querySelector('.typing-char.current');
        if (prevChar) {
          prevChar.classList.remove('current');
        }

        const char = typingText.charAt(typingIndex);
        const span = document.createElement('span');
        span.className = 'typing-char current'; // 현재 글자에 밑줄

        // 공백 처리 - &nbsp;로 변환하여 너비 확보
        if (char === ' ') {
          span.innerHTML = '&nbsp;';
        } else {
          span.textContent = char;
        }

        textElement.appendChild(span);

        typingIndex++;
        // 타이핑 속도 (70ms)
        setTimeout(typeNextChar, 70);
      } else {
        // 타이핑 완료 - 마지막 글자 밑줄 제거, 파이프 커서 깜빡임 시작
        const lastChar = textElement.querySelector('.typing-char.current');
        if (lastChar) {
          lastChar.classList.remove('current');
        }
        if (cursorElement) {
          cursorElement.classList.add('blink');
        }
      }
    }

    typeNextChar();
  }

  // 버전 태그 업데이트 (changelog.json에서)
  function loadVersionFromChangelog() {
    fetch('https://raw.githubusercontent.com/Cassiiopeia/suh-project-utility/main/CHANGELOG.json')
      .then(response => response.json())
      .then(data => {
        const versionTag = document.getElementById('version-tag');
        if (versionTag && data.metadata && data.metadata.currentVersion) {
          versionTag.textContent = 'v' + data.metadata.currentVersion;
        }
      })
      .catch(error => {
        console.error('버전 정보 로드 실패:', error);
        // 실패 시 기본값 유지
      });
  }

  // Changelog 모달 열기
  function openChangelogModal() {
    const modal = document.getElementById('changelog-modal');
    modal.showModal();
    loadChangelog();
  }

  // Changelog 데이터 로드
  function loadChangelog() {
    const loadingEl = document.getElementById('changelog-loading');
    const dataEl = document.getElementById('changelog-data');

    // 이미 로드된 경우 스킵
    if (!dataEl.classList.contains('hidden')) return;

    // GitHub raw URL에서 CHANGELOG.json 가져오기
    fetch('https://raw.githubusercontent.com/Cassiiopeia/suh-project-utility/main/CHANGELOG.json')
      .then(response => response.json())
      .then(data => {
        renderChangelog(data);
        loadingEl.classList.add('hidden');
        dataEl.classList.remove('hidden');
      })
      .catch(error => {
        console.error('Changelog 로드 실패:', error);
        loadingEl.innerHTML = `
          <div class="text-center text-gray-500">
            <i class="fa-solid fa-circle-exclamation text-2xl mb-2"></i>
            <p>변경 이력을 불러올 수 없습니다.</p>
          </div>
        `;
      });
  }

  // Changelog 데이터 렌더링
  function renderChangelog(data) {
    const latestRelease = data.releases[0];
    const metadata = data.metadata;

    // 버전 정보
    document.getElementById('changelog-version').textContent = 'v' + latestRelease.version;
    document.getElementById('changelog-date').textContent = latestRelease.date;

    // 마지막 업데이트
    const lastUpdated = new Date(metadata.lastUpdated);
    document.getElementById('changelog-updated').textContent =
      'Last updated: ' + lastUpdated.toLocaleDateString('ko-KR');

    // 변경사항 목록
    const itemsEl = document.getElementById('changelog-items');
    itemsEl.innerHTML = '';

    // parsed_changes에서 아이템 추출
    const changes = latestRelease.parsed_changes;
    for (const category in changes) {
      const categoryData = changes[category];
      if (categoryData.items && categoryData.items.length > 0) {
        categoryData.items.forEach(item => {
          const li = document.createElement('li');
          li.className = 'flex items-start gap-2';
          li.innerHTML = `
            <span class="text-primary mt-1">•</span>
            <span>${item}</span>
          `;
          itemsEl.appendChild(li);
        });
      }
    }
  }

  function processClientIP(clientIP) {
    console.log("실제 클라이언트 IP:", clientIP);
    // AES 암호화
    const key = CryptoJS.enc.Utf8.parse(window.encryptionKey);
    const iv = CryptoJS.enc.Utf8.parse(window.encryptionIv);

    const encrypted = CryptoJS.AES.encrypt(clientIP, key, {
      iv: iv,
      mode: CryptoJS.mode.CBC,
      padding: CryptoJS.pad.Pkcs7
    });

    console.log("ClientHash 값:", encrypted.toString());
    window.clientHash = encrypted.toString();
  }

  function setupLoginForm() {
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
      loginForm.addEventListener('submit', function(e) {
        // 기존 필드 제거
        const existingField = this.querySelector('input[name="clientHash"]');
        if (existingField) existingField.remove();

        // clientHash 추가
        if (window.clientHash) {
          const hiddenField = document.createElement('input');
          hiddenField.type = 'hidden';
          hiddenField.name = 'clientHash';
          hiddenField.value = window.clientHash;
          this.appendChild(hiddenField);
        } else {
          console.warn("clientHash 값이 설정되지 않았습니다");
        }

        // 로딩 표시
        const loadingEl = document.getElementById('login-loading');
        loadingEl.classList.remove('hidden');
        loadingEl.classList.add('flex');
      });
    }
  }

  // 비밀번호 보기/숨기기 토글
  function setupPasswordToggle() {
    const toggleBtn = document.getElementById('togglePassword');
    const passwordInput = document.getElementById('passwordInput');
    const eyeIcon = document.getElementById('eyeIcon');

    if (toggleBtn && passwordInput && eyeIcon) {
      toggleBtn.addEventListener('click', function() {
        if (passwordInput.type === 'password') {
          passwordInput.type = 'text';
          eyeIcon.classList.remove('fa-eye');
          eyeIcon.classList.add('fa-eye-slash');
        } else {
          passwordInput.type = 'password';
          eyeIcon.classList.remove('fa-eye-slash');
          eyeIcon.classList.add('fa-eye');
        }
      });
    }
  }

</script>
</body>
</html>
