<!-- src/main/resources/templates/pages/translator.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head(title='ë²ˆì—­ê¸°-SAECHAN-LAB')}"></head>
<body class="translator-page bg-gray-50">
<div th:replace="~{fragments/header :: header}"></div>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- í˜ì´ì§€ í—¤ë” -->
  <div class="mb-6">
    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
      <i class="fa-solid fa-language text-blue-500"></i>
      SUH-AI ë²ˆì—­ê¸°
    </h2>
  </div>

  <!-- ë²„ì „ ì •ë³´ ì„¹ì…˜ -->
  <div th:replace="~{fragments/versionInfo :: versionInfo(moduleType='TRANSLATOR')}"></div>

  <!-- ë²ˆì—­ ì˜ì—­ -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
    <!-- ì›ë³¸ í…ìŠ¤íŠ¸ ì˜ì—­ -->
    <div class="card bg-base-100 shadow-sm border border-gray-100">
      <div class="card-body">
        <!-- ì›ë³¸ ì–¸ì–´ ì„ íƒ -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">ì›ë³¸ ì–¸ì–´</span>
          </label>
          <select id="sourceLanguage" class="select w-full">
            <option value="AUTO" selected>ğŸŒ ì–¸ì–´ ê°ì§€</option>
            <option value="KO">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
            <option value="EN">ğŸ‡ºğŸ‡¸ ì˜ì–´</option>
            <option value="JA">ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´</option>
            <option value="ZH_CN">ğŸ‡¨ğŸ‡³ ì¤‘êµ­ì–´ (ê°„ì²´)</option>
            <option value="ZH_TW">ğŸ‡¹ğŸ‡¼ ì¤‘êµ­ì–´ (ë²ˆì²´)</option>
            <option value="ES">ğŸ‡ªğŸ‡¸ ìŠ¤í˜ì¸ì–´</option>
            <option value="FR">ğŸ‡«ğŸ‡· í”„ë‘ìŠ¤ì–´</option>
            <option value="DE">ğŸ‡©ğŸ‡ª ë…ì¼ì–´</option>
            <option value="RU">ğŸ‡·ğŸ‡º ëŸ¬ì‹œì•„ì–´</option>
            <option value="PT">ğŸ‡µğŸ‡¹ í¬ë¥´íˆ¬ê°ˆì–´</option>
            <option value="IT">ğŸ‡®ğŸ‡¹ ì´íƒˆë¦¬ì•„ì–´</option>
            <option value="VI">ğŸ‡»ğŸ‡³ ë² íŠ¸ë‚¨ì–´</option>
            <option value="TH">ğŸ‡¹ğŸ‡­ íƒœêµ­ì–´</option>
            <option value="ID">ğŸ‡®ğŸ‡© ì¸ë„ë„¤ì‹œì•„ì–´</option>
          </select>
        </div>

        <!-- ì›ë³¸ í…ìŠ¤íŠ¸ ì…ë ¥ -->
        <div class="form-control mt-4">
          <textarea
            id="sourceText"
            class="textarea h-48 resize-none"
            placeholder="ë²ˆì—­í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
          <label class="label">
            <span class="label-text-alt text-gray-500">
              <span id="charCount">0</span> ê¸€ì
            </span>
          </label>
        </div>
      </div>
    </div>

    <!-- ë²ˆì—­ ê²°ê³¼ ì˜ì—­ -->
    <div class="card bg-base-100 shadow-sm border border-gray-100">
      <div class="card-body">
        <!-- ëŒ€ìƒ ì–¸ì–´ ì„ íƒ -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">ëŒ€ìƒ ì–¸ì–´</span>
          </label>
          <select id="targetLanguage" class="select w-full">
            <option value="KO" selected>ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
            <option value="EN">ğŸ‡ºğŸ‡¸ ì˜ì–´</option>
            <option value="JA">ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´</option>
            <option value="ZH_CN">ğŸ‡¨ğŸ‡³ ì¤‘êµ­ì–´ (ê°„ì²´)</option>
            <option value="ZH_TW">ğŸ‡¹ğŸ‡¼ ì¤‘êµ­ì–´ (ë²ˆì²´)</option>
            <option value="ES">ğŸ‡ªğŸ‡¸ ìŠ¤í˜ì¸ì–´</option>
            <option value="FR">ğŸ‡«ğŸ‡· í”„ë‘ìŠ¤ì–´</option>
            <option value="DE">ğŸ‡©ğŸ‡ª ë…ì¼ì–´</option>
            <option value="RU">ğŸ‡·ğŸ‡º ëŸ¬ì‹œì•„ì–´</option>
            <option value="PT">ğŸ‡µğŸ‡¹ í¬ë¥´íˆ¬ê°ˆì–´</option>
            <option value="IT">ğŸ‡®ğŸ‡¹ ì´íƒˆë¦¬ì•„ì–´</option>
            <option value="VI">ğŸ‡»ğŸ‡³ ë² íŠ¸ë‚¨ì–´</option>
            <option value="TH">ğŸ‡¹ğŸ‡­ íƒœêµ­ì–´</option>
            <option value="ID">ğŸ‡®ğŸ‡© ì¸ë„ë„¤ì‹œì•„ì–´</option>
          </select>
        </div>

        <!-- ë²ˆì—­ ê²°ê³¼ -->
        <div class="form-control mt-4">
          <div id="targetText" class="bg-gray-50 border border-gray-200 rounded-lg p-4 h-48 overflow-y-auto text-gray-700">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ë²„íŠ¼ ì˜ì—­ -->
  <div class="flex justify-center gap-4 mt-6">
    <button id="translateBtn" class="btn btn-primary">
      <i class="fa-solid fa-language"></i>
      ë²ˆì—­í•˜ê¸°
    </button>
    <button id="copyBtn" class="btn btn-outline">
      <i class="fa-solid fa-copy"></i>
      ë³µì‚¬í•˜ê¸°
    </button>
  </div>
</div>

<!-- í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ -->
<div id="toast-container"></div>
<div th:replace="~{fragments/footer :: footer}"></div>

<script>
  $(document).ready(function () {
    initElements();
    setupEventHandlers();
  });

  function initElements() {
    window.elements = {
      sourceText: document.getElementById('sourceText'),
      targetText: document.getElementById('targetText'),
      translateBtn: document.getElementById('translateBtn'),
      copyBtn: document.getElementById('copyBtn'),
      sourceLanguage: document.getElementById('sourceLanguage'),
      targetLanguage: document.getElementById('targetLanguage'),
      charCount: document.getElementById('charCount')
    };
    updateTranslationPlaceholder();
  }

  function setupEventHandlers() {
    window.elements.translateBtn.addEventListener('click', translateText);
    window.elements.copyBtn.addEventListener('click', copyTranslatedText);
    window.elements.sourceText.addEventListener('input', debounce(function() {
      updateCharCount();
      if (window.elements.sourceText.value.trim().length > 0) {
        translateText();
      } else {
        updateTranslationPlaceholder();
      }
    }, 1000));
    window.elements.sourceLanguage.addEventListener('change', function() {
      if (window.elements.sourceText.value.trim().length > 0) {
        translateText();
      }
    });
    window.elements.targetLanguage.addEventListener('change', function() {
      if (window.elements.sourceText.value.trim().length > 0) {
        translateText();
      }
    });
  }

  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  function translateText() {
    const sourceText = window.elements.sourceText.value.trim();
    if (!sourceText) {
      updateTranslationPlaceholder();
      return;
    }
    window.elements.targetText.innerHTML = `
      <div class="flex items-center justify-center h-full">
        <span class="loading loading-spinner loading-md text-primary"></span>
        <span class="ml-2 text-gray-500">ë²ˆì—­ ì¤‘...</span>
      </div>
    `;
    var formData = new FormData();
    formData.append("text", sourceText);
    formData.append("translatorType", "PAPAGO");
    formData.append("sourceLang", window.elements.sourceLanguage.value);
    formData.append("targetLang", window.elements.targetLanguage.value);

    $.ajax({
      url: '/api/translate',
      type: 'POST',
      data: formData,
      processData: false,
      contentType: false,
      success: function(response) {
        window.elements.targetText.textContent = response.translatedText || 'ë²ˆì—­ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
      },
      error: function(xhr, status, error) {
        console.error('Translation error:', error);
        window.elements.targetText.textContent = 'ì˜¤ë¥˜: ë²ˆì—­ì„ ì™„ë£Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        showToast("ë²ˆì—­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "negative");
      }
    });
  }

  function copyTranslatedText() {
    const text = window.elements.targetText.textContent;
    if (!text || text.includes('ë²ˆì—­ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤') || text.includes('ì˜¤ë¥˜:')) {
      showToast("ë³µì‚¬í•  ë²ˆì—­ í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.", "warning");
      return;
    }
    navigator.clipboard.writeText(text).then(function() {
      showToast("ë²ˆì—­ ê²°ê³¼ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.", "positive");
    }).catch(function() {
      // í´ë°± ë°©ì‹
      const textarea = document.createElement('textarea');
      textarea.value = text;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
      showToast("ë²ˆì—­ ê²°ê³¼ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.", "positive");
    });
  }

  function updateTranslationPlaceholder() {
    window.elements.targetText.innerHTML = '<span class="text-gray-400">ë²ˆì—­ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</span>';
  }

  function updateCharCount() {
    const count = window.elements.sourceText.value.length;
    window.elements.charCount.textContent = count;
  }
</script>
</body>
</html>
