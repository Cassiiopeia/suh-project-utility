<!-- src/main/resources/templates/pages/githubIssueHelper.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head(title='깃헙이슈도우미-SAECHAN-LAB')}"></head>
<body class="issue-helper-page bg-gray-50">
<div th:replace="~{fragments/header :: header}"></div>

<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- 페이지 헤더 -->
  <div class="mb-6">
    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
      <i class="fa-brands fa-github text-blue-500"></i>
      깃헙 이슈 도우미
    </h2>
  </div>

  <!-- 입력 폼 카드 -->
  <div class="card bg-base-100 shadow-sm border border-gray-100 mt-6">
    <div class="card-body">
      <form id="issueHelperForm" method="post" enctype="multipart/form-data"
            th:action="@{/api/issue-helper/create/commit-branch}">
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">GitHub Issue URL</span>
          </label>
          <input
            type="text"
            name="issueUrl"
            class="input w-full"
            placeholder="https://github.com/owner/repo/issues/2"
            required>
          <label class="label">
            <span class="label-text-alt text-gray-500">GitHub 이슈 URL을 입력하면 브랜치명과 커밋 메시지를 자동 생성합니다.</span>
          </label>
        </div>
        <input type="hidden" name="clientHash" id="clientHash">
        <button class="btn btn-primary mt-4" type="submit">
          <i class="fa-solid fa-wand-magic-sparkles"></i>
          생성하기
        </button>
      </form>
    </div>
  </div>

  <!-- 결과 카드 -->
  <div class="card bg-base-100 shadow-sm border border-gray-100 mt-6 hidden" id="resultBox">
    <div class="card-body">
      <h3 class="card-title text-lg font-semibold text-gray-800 mb-4">
        <i class="fa-solid fa-sparkles text-blue-500"></i>
        추론 결과
      </h3>

      <!-- 브랜치명 -->
      <div class="form-control mb-4">
        <label class="label">
          <span class="label-text font-medium">브랜치명</span>
        </label>
        <div class="join w-full">
          <textarea
            id="branchName"
            class="textarea join-item flex-1 min-h-14"
            readonly></textarea>
          <button class="btn btn-outline join-item" id="copyBranch">
            <i class="fa-solid fa-copy"></i>
            복사
          </button>
        </div>
      </div>

      <!-- 커밋 메시지 -->
      <div class="form-control">
        <label class="label">
          <span class="label-text font-medium">커밋 메시지</span>
        </label>
        <div class="join w-full">
          <textarea
            id="commitMessage"
            class="textarea join-item flex-1 min-h-24"
            readonly></textarea>
          <button class="btn btn-outline join-item" id="copyCommit">
            <i class="fa-solid fa-copy"></i>
            복사
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<script>
  $(function () {
    $("#issueHelperForm").submit(async function (event) {
      event.preventDefault();

      // 로딩 상태 표시
      const submitBtn = $(this).find('button[type="submit"]');
      const originalText = submitBtn.html();
      submitBtn.html('<span class="loading loading-spinner loading-sm"></span> 생성 중...');
      submitBtn.prop('disabled', true);

      try {
        $("#clientHash").val(clientHash);

        // 폼 데이터 전송
        var formData = new FormData(this);

        // AJAX 요청
        $.ajax({
          url: $(this).attr("action"),
          type: "POST",
          data: formData,
          processData: false,
          contentType: false,
          success: function (response) {
            // 응답 처리
            $("#branchName").val(response.branchName);
            $("#commitMessage").val(response.commitMessage);
            $("#resultBox").removeClass('hidden');
            showToast("브랜치명과 커밋 메시지가 생성되었습니다.", "positive");
          },
          error: function (xhr, status, error) {
            // 오류 처리
            console.error("AJAX 오류:", status, error);
            showToast("요청 처리에 실패했습니다.", "negative");
          },
          complete: function() {
            // 버튼 복원
            submitBtn.html(originalText);
            submitBtn.prop('disabled', false);
          }
        });
      } catch (error) {
        // 예외 처리
        console.error("처리 중 예외 발생:", error);
        showToast("요청 처리에 실패했습니다.", "negative");
        submitBtn.html(originalText);
        submitBtn.prop('disabled', false);
      }
    });

    // 복사 기능 - 브랜치명
    $("#copyBranch").click(function () {
      copyToClipboard($("#branchName").val(), "브랜치명이 복사되었습니다.");
    });

    // 복사 기능 - 커밋 메시지
    $("#copyCommit").click(function () {
      copyToClipboard($("#commitMessage").val(), "커밋 메시지가 복사되었습니다.");
    });

    // 클립보드 복사 유틸
    function copyToClipboard(text, msg) {
      navigator.clipboard.writeText(text).then(function() {
        showToast(msg, "positive");
      }).catch(function() {
        // 폴백 방식
        var $temp = $("<textarea>");
        $("body").append($temp);
        $temp.val(text).select();
        document.execCommand("copy");
        $temp.remove();
        showToast(msg, "positive");
      });
    }
  });
</script>
</body>
</html>
