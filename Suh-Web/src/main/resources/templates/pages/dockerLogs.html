<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head th:replace="~{fragments/header :: head(title='Docker 로그-SAECHAN-LAB')}"></head>
<body class="docker-logs-page">
<div th:replace="~{fragments/header :: header}"></div>

<div class="ui container" id="main-content">
  <!-- 스켈레톤 로딩 컨테이너 - 페이지 로딩 시 임시 표시 -->
  <div id="skeleton-container">
    <div class="ui segment skeleton">
      <div class="skeleton skeleton-header-large"></div>
      <div class="skeleton skeleton-text-medium"></div>
    </div>
    <div class="ui segment skeleton">
      <div class="skeleton skeleton-text-small"></div>
      <div class="skeleton skeleton-output"></div>
    </div>
  </div>

  <!-- 실제 콘텐츠 - 로딩 후 표시 -->
  <div id="real-content" class="hide">
    <div class="ui stackable grid">
      <!-- 컨테이너 목록 -->
      <div class="three wide column">
        <h4 class="ui header"><i class="cubes icon"></i> 컨테이너 목록</h4>
        <div class="ui relaxed divided list" id="containerList" style="max-height:70vh;overflow-y:auto;"></div>
      </div>
      <!-- 로그 영역 -->
      <div class="thirteen wide column">
    <!-- 메인 헤더 -->
    <div class="ui segment">
      <h2 class="ui header">
        <i class="fab fa-docker fa-sm" style="color:#2185d0;"></i>
        <div class="content">
          Docker 컨테이너 로그
          <div class="sub header">실시간 서버 Docker 컨테이너 로그</div>
        </div>
      </h2>
      
      <!-- 컨트롤 패널 -->
      <div class="ui form">
        <div class="fields">
          <div class="eight wide field">
            <label>컨테이너 이름</label>
            <div class="ui action input">
              <input type="text" id="containerName" placeholder="컨테이너 이름" value="sejong-malsami-back">
              <button class="ui primary button" id="startLogBtn">로그 시작</button>
              <button class="ui red button" id="stopLogBtn">중지</button>
              <button class="ui button" id="clearLogBtn">화면 지우기</button>
            </div>
          </div>
          <div class="four wide field">
            <label>라인 제한</label>
            <select class="ui dropdown" id="lineLimit">
              <option value="100">100줄</option>
              <option value="500">500줄</option>
              <option value="1000">1000줄</option>
              <option value="0">제한 없음</option>
            </select>
          </div>
          <div class="four wide field">
            <label>자동 스크롤</label>
            <div class="ui toggle checkbox auto-scroll-checkbox">
              <input type="checkbox" id="autoScroll" checked>
              <label>켜기</label>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 로그 출력 화면 -->
    <div class="ui inverted segment log-output-container">
      <pre id="logOutput"></pre>
    </div>
    
    <!-- 상태 표시 -->
    <div class="ui segment">
      <div class="ui grid">
        <div class="eight wide column">
          <div class="ui label" id="logStatus">
            <i class="circle icon"></i>
            준비됨
          </div>
        </div>
        <div class="eight wide column right aligned">
          <div class="ui label" id="lineCount">
            <i class="list ol icon"></i>
            라인: 0
          </div>
        </div>
      </div>
    </div>
    </div> <!-- column end -->
    </div> <!-- grid end -->
  </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<!-- Highlight.js 스타일 및 스크립트 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/bash.min.js"></script>

<script>
  $(document).ready(function() {
    // 변수 초기화
    let pollInterval = null;
    let logLineCount = 0;
    let lastLogHash = null;
    const logOutput = document.querySelector('#logOutput');
    const logStatusLabel = $('#logStatus');
    const lineCountLabel = $('#lineCount');
    
    // UI 초기화
    $('.ui.dropdown').dropdown();
    $('.ui.checkbox').checkbox();
    
    // 컨테이너 목록 로드
    loadContainerList();
    
    function loadContainerList() {
      $('#containerList').html('<div class="ui active inline loader mini"></div>');
      $.get('/api/docker-log/containers', function(data) {
        const list = $('#containerList');
        list.empty();
        if (!data || data.length === 0) {
          list.append('<div class="item">컨테이너 없음</div>');
          return;
        }
        data.forEach(function(c) {
          const statusClass = c.isRunning ? 'online' : 'offline';
          const imageInfo = (c.image && c.image !== 'null') ? c.image.split(':')[0] : 'Unknown';
          const item = $(
            `<a class="item container-item" data-name="${c.name}">
               <div class="status-dot ${statusClass}"></div>
               <div class="content">
                 <div class="header">${c.name}</div>
                 <div class="description" style="font-size:0.8em;">
                   <div>${c.status}</div>
                   <div style="color:#666;font-size:0.9em;margin-top:2px;">${imageInfo}</div>
                 </div>
               </div>
             </a>`);
          item.on('click', function() {
            $('#containerName').val(c.name);
            $('#startLogBtn').click();
          });
          list.append(item);
        });
      });
    }
    
    // 페이지 로딩 효과
    setTimeout(function() {
      document.getElementById('skeleton-container').classList.add('hide');
      document.getElementById('real-content').classList.remove('hide');
    }, 500);
    
    // 로그 시작 버튼 클릭 이벤트
    $('#startLogBtn').on('click', function() {
      if (pollInterval) {
        stopLogPoll();
      }
      startLogPoll();
    });
    
    // 로그 중지 버튼 클릭 이벤트
    $('#stopLogBtn').on('click', function() {
      stopLogPoll();
      updateStatus('중지됨', 'yellow');
    });
    
    // 로그 지우기 버튼 클릭 이벤트
    $('#clearLogBtn').on('click', function() {
      clearLogOutput();
      updateStatus('준비됨', 'blue');
    });
    
    // 폴링 시작 함수
    function startLogPoll() {
      const containerName = $('#containerName').val() || 'sejong-malsami-back';
      const lineLimit = $('#lineLimit').val() || 100;
      
      updateStatus('폴링 시작', 'blue');
      lastLogHash = null;
      
      // 즉시 한 번 호출
      pollLogs(containerName, lineLimit);
      
      // 이후 1초마다 폴링
      pollInterval = setInterval(function() {
        pollLogs(containerName, lineLimit);
      }, 1000);
      
      console.log('폴링 시작 - 컨테이너:', containerName, ', 간격: 1초');
    }
    
    // 폴링 중지 함수
    function stopLogPoll() {
      if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
        console.log('폴링 중지');
      }
    }
    
    // 로그 폴링 함수
    function pollLogs(containerName, lineLimit) {
      const url = `/api/docker-log/poll?containerName=${encodeURIComponent(containerName)}&lineLimit=${lineLimit}`;
      
      $.ajax({
        url: url,
        type: 'GET',
        success: function(response) {
          if (response.error) {
            console.error('로그 조회 오류:', response.error);
            updateStatus('오류: ' + response.error, 'red');
            appendToLog('\n=== 오류 ===\n' + response.error + '\n');
            stopLogPoll();
            return;
          }
          
          if (response.logs) {
            const currentHash = hashString(response.logs);
            
            // 로그가 변경되었을 때만 업데이트
            if (currentHash !== lastLogHash) {
              console.log('로그 업데이트 - 총 라인 수:', response.totalLines);
              logOutput.textContent = response.logs;
              logLineCount = response.totalLines || 0;
              updateLineCount();
              updateStatus('폴링 중', 'green');
              
              // 자동 스크롤
              if ($('#autoScroll').is(':checked')) {
                const container = document.querySelector('.log-output-container');
                container.scrollTop = container.scrollHeight;
              }
              
              lastLogHash = currentHash;
            }
          }
        },
        error: function(xhr, status, error) {
          console.error('폴링 요청 실패:', error);
          updateStatus('연결 실패', 'red');
          stopLogPoll();
        }
      });
    }
    
    // 문자열 해시 함수 (로그 변경 감지용)
    function hashString(str) {
      let hash = 0;
      if (str.length === 0) return hash;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return hash;
    }
    
    // 로그 출력 지우기 함수
    function clearLogOutput() {
      logOutput.textContent = '';
      logLineCount = 0;
      lastLogHash = null;
      updateLineCount();
    }
    
    // 로그 추가 함수 (폴링에서는 사용하지 않지만 호환성을 위해 유지)
    function appendToLog(text) {
      if (!text || text.trim().length === 0) {
        return;
      }
      const currentText = logOutput.textContent || '';
      logOutput.textContent = currentText + text;
      const allLines = logOutput.textContent.split('\n');
      logLineCount = allLines.length - 1;
      updateLineCount();
      
      if ($('#autoScroll').is(':checked')) {
        const container = document.querySelector('.log-output-container');
        container.scrollTop = container.scrollHeight;
      }
    }
    
    // 상태 업데이트 함수
    function updateStatus(text, color) {
      logStatusLabel.html(`<i class="circle ${color} icon"></i> ${text}`);
      logStatusLabel.removeClass('blue green yellow red');
      logStatusLabel.addClass(color);
    }
    
    // 라인 카운트 업데이트 함수
    function updateLineCount() {
      lineCountLabel.html(`<i class="list ol icon"></i> 라인: ${logLineCount}`);
    }
  });
</script>
</body>
</html>
