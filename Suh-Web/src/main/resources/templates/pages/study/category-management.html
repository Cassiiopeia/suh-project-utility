<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head th:replace="~{fragments/header :: head(title='카테고리 관리 - SAECHAN-LAB')}">
  <title>카테고리 관리</title>
  <!-- 추가 스타일 -->
  <style>
    .child-category-row { background-color: #f9fafb; }
  </style>
</head>
<body class="study-page category-management-page">
<div th:replace="~{fragments/header :: header}"></div>

<div class="ui container" id="main-content">
  <div class="ui segment">
    <h2 class="ui header">카테고리 관리</h2>
    <p class="study-description">스터디 노트의 카테고리를 관리합니다.</p>

    <!-- 작업 버튼 -->
    <div class="ui buttons">
      <button id="create-category-btn" class="ui primary button">
        <i class="plus icon"></i> 새 카테고리 생성
      </button>
      <a href="/study-management" class="ui button">
        <i class="arrow left icon"></i> 스터디 홈으로
      </a>
    </div>
    
    <div class="ui divider"></div>
    
    <!-- 카테고리 목록 테이블 -->
    <table class="ui celled table">
      <thead>
        <tr>
          <th>이름</th>
          <th>설명</th>
          <th>포스트 수</th>
          <th>생성일</th>
          <th>표시 순서</th>
          <th>관리</th>
        </tr>
      </thead>
      <tbody>
        <!-- 카테고리가 없는 경우 -->
        <tr th:if="${categoriesResponse == null || categoriesResponse.categories == null || categoriesResponse.categories.isEmpty()}">
          <td colspan="6" class="center aligned">등록된 카테고리가 없습니다.</td>
        </tr>
        
        <!-- 최상위 카테고리 목록 -->
        <tr th:unless="${categoriesResponse == null || categoriesResponse.categories == null || categoriesResponse.categories.isEmpty()}"
            th:each="category : ${categoriesResponse.categories}">
          <td>
            <i th:class="${category.icon != null ? category.icon : 'folder'} + ' icon'"
               th:style="${category.color != null ? 'color:' + category.color : ''}"></i>
            <a th:href="@{/study-management/category/{id}(id=${category.id})}" th:text="${category.name}"></a>
          </td>
          <td th:text="${category.description != null ? category.description : '-'}"></td>
          <td th:text="${category.postCount != null ? category.postCount : 0}"></td>
          <td th:text="${#temporals.format(category.createdDate, 'yyyy-MM-dd')}"></td>
          <td th:text="${category.displayOrder != null ? category.displayOrder : '-'}"></td>
          <td>
            <button class="ui mini blue icon button edit-category-btn"
                    th:data-id="${category.id}"
                    th:data-name="${category.name}"
                    th:data-description="${category.description}"
                    th:data-icon="${category.icon}"
                    th:data-color="${category.color}"
                    th:data-order="${category.displayOrder}">
              <i class="edit icon"></i>
            </button>
            <button class="ui mini red icon button delete-category-btn"
                    th:data-id="${category.id}"
                    th:data-name="${category.name}">
              <i class="trash icon"></i>
            </button>
          </td>
        </tr>
        
        <!-- 하위 카테고리 목록 -->
        <th:block th:unless="${categoriesResponse == null || categoriesResponse.categories == null || categoriesResponse.categories.isEmpty()}">
          <th:block th:each="parentCat : ${categoriesResponse.categories}" th:if="${!parentCat.children.isEmpty()}">
            <tr th:each="childCat : ${parentCat.children}"
                class="child-category-row">
          <td>
            <div style="margin-left: 1.5em;">
              <i th:class="${childCat.icon != null ? childCat.icon : 'file'} + ' icon'"
                 th:style="${childCat.color != null ? 'color:' + childCat.color : ''}"></i>
              <a th:href="@{/study-management/category/{id}(id=${childCat.id})}" th:text="${childCat.name}"></a>
              <div class="ui tiny label" th:text="${parentCat.name}"></div>
            </div>
          </td>
          <td th:text="${childCat.description != null ? childCat.description : '-'}"></td>
          <td th:text="${childCat.postCount != null ? childCat.postCount : 0}"></td>
          <td th:text="${#temporals.format(childCat.createdDate, 'yyyy-MM-dd')}"></td>
          <td th:text="${childCat.displayOrder != null ? childCat.displayOrder : '-'}"></td>
          <td>
            <button class="ui mini blue icon button edit-category-btn"
                    th:data-id="${childCat.id}"
                    th:data-name="${childCat.name}"
                    th:data-description="${childCat.description}"
                    th:data-icon="${childCat.icon}"
                    th:data-color="${childCat.color}"
                    th:data-order="${childCat.displayOrder}"
                    th:data-parent-id="${parentCat.id}">
              <i class="edit icon"></i>
            </button>
            <button class="ui mini red icon button delete-category-btn"
                    th:data-id="${childCat.id}"
                    th:data-name="${childCat.name}">
              <i class="trash icon"></i>
            </button>
          </td>
        </tr>
            </th:block>
          </th:block>
      </tbody>
    </table>
  </div>
</div>

<!-- 카테고리 생성/수정 모달 -->
<div class="ui small modal" id="category-modal">
  <div class="header" id="modal-title">카테고리 생성</div>
  <div class="content">
    <form class="ui form" id="category-form">
      <input type="hidden" id="category-id" name="id">
      
      <div class="field">
        <label>카테고리 이름</label>
        <input type="text" id="category-name" name="categoryName" placeholder="카테고리 이름" required>
      </div>
      
      <div class="field">
        <label>설명</label>
        <textarea id="category-description" name="categoryDescription" rows="2" placeholder="카테고리 설명"></textarea>
      </div>
      
      <div class="two fields">
        <div class="field">
          <label>아이콘 (Font Awesome 클래스)</label>
          <input type="text" id="category-icon" name="categoryIcon" placeholder="예: folder icon">
        </div>
        
        <div class="field">
          <label>색상 (CSS 컬러값)</label>
          <input type="text" id="category-color" name="categoryColor" placeholder="예: #3B82F6">
        </div>
      </div>
      
      <div class="two fields">
        <div class="field">
          <label>표시 순서</label>
          <input type="number" id="category-order" name="categoryDisplayOrder" placeholder="숫자가 작을수록 먼저 표시됩니다">
        </div>
        
        <div class="field">
          <label>상위 카테고리</label>
          <select id="category-parent" name="parentCategoryId" class="ui dropdown">
            <option value="">없음 (최상위 카테고리)</option>
            <option th:each="category : ${categoriesResponse.categories}"
                    th:value="${category.id}"
                    th:text="${category.name}"></option>
          </select>
        </div>
      </div>
    </form>
  </div>
  <div class="actions">
    <button class="ui negative button" id="cancel-btn">취소</button>
    <button class="ui positive button" id="save-btn">저장</button>
  </div>
</div>

<!-- 카테고리 삭제 확인 모달 -->
<div class="ui small modal" id="delete-confirm-modal">
  <div class="header">카테고리 삭제</div>
  <div class="content">
    <p>정말로 카테고리 "<span id="delete-category-name"></span>"을(를) 삭제하시겠습니까?</p>
    <p class="ui negative message">주의: 하위 카테고리나 포스트가 있는 카테고리는 삭제할 수 없습니다.</p>
  </div>
  <div class="actions">
    <button class="ui negative button" id="confirm-delete-btn">삭제</button>
    <button class="ui button" id="cancel-delete-btn">취소</button>
  </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<script>
  $(document).ready(function() {
    // 드롭다운 초기화
    $('.ui.dropdown').dropdown();
    
    // 카테고리 생성 버튼 클릭
    $('#create-category-btn').on('click', function() {
      // 모달 폼 초기화
      $('#category-form')[0].reset();
      $('#category-id').val('');
      $('#modal-title').text('카테고리 생성');
      
      // 모달 표시
      $('#category-modal').modal('show');
    });
    
    // 카테고리 수정 버튼 클릭
    $('.edit-category-btn').on('click', function() {
      // 모달 폼에 데이터 설정
      $('#category-id').val($(this).data('id'));
      $('#category-name').val($(this).data('name'));
      $('#category-description').val($(this).data('description'));
      $('#category-icon').val($(this).data('icon'));
      $('#category-color').val($(this).data('color'));
      $('#category-order').val($(this).data('order'));
      $('#category-parent').dropdown('set selected', $(this).data('parent-id'));
      
      // 모달 타이틀 설정
      $('#modal-title').text('카테고리 수정');
      
      // 모달 표시
      $('#category-modal').modal('show');
    });
    
    // 카테고리 삭제 버튼 클릭
    $('.delete-category-btn').on('click', function() {
      const categoryId = $(this).data('id');
      const categoryName = $(this).data('name');
      
      // 삭제 확인 모달에 카테고리 이름 설정
      $('#delete-category-name').text(categoryName);
      
      // 삭제 버튼에 카테고리 ID 설정
      $('#confirm-delete-btn').data('id', categoryId);
      
      // 삭제 확인 모달 표시
      $('#delete-confirm-modal').modal('show');
    });
    
    // 카테고리 저장 버튼 클릭
    $('#save-btn').on('click', function() {
      const formData = new FormData($('#category-form')[0]);
      
      // API URL 결정 (생성 또는 수정)
      const categoryId = $('#category-id').val();
      const apiUrl = categoryId ? '/api/study/category/update' : '/api/study/category/create';
      
      // API 호출
      $.ajax({
        url: apiUrl,
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
          if (response) {
            // 성공 시 페이지 새로고침
            location.reload();
          } else {
            alert('카테고리 저장 중 오류가 발생했습니다.');
          }
        },
        error: function(xhr, status, error) {
          alert('카테고리 저장 중 오류가 발생했습니다: ' + error);
          console.error('카테고리 저장 오류:', xhr.responseText);
        }
      });
    });
    
    // 카테고리 삭제 확인 버튼 클릭
    $('#confirm-delete-btn').on('click', function() {
      const categoryId = $(this).data('id');
      
      // API 호출
      $.ajax({
        url: '/api/study/category/delete',
        type: 'POST',
        data: {
          id: categoryId
        },
        success: function() {
          // 성공 시 페이지 새로고침
          location.reload();
        },
        error: function(xhr, status, error) {
          alert('카테고리 삭제 중 오류가 발생했습니다: ' + error);
          console.error('카테고리 삭제 오류:', xhr.responseText);
        }
      });
    });
    
    // 모달 취소 버튼
    $('#cancel-btn, #cancel-delete-btn').on('click', function() {
      $('.ui.modal').modal('hide');
    });
  });
</script>
</body>
</html>
