<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head th:replace="~{fragments/header :: head(title='카테고리 관리 - SAECHAN-LAB')}">
  <title>카테고리 관리</title>
  <!-- 추가 스타일 -->
  <style>
    .child-category-row { background-color: #f9fafb; }
  </style>
</head>
<body class="study-page category-management-page">
<div th:replace="~{fragments/header :: header}"></div>

<div class="container mx-auto px-4 py-6" id="main-content">
  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <h2 class="text-2xl font-bold mb-2">카테고리 관리</h2>
      <p class="text-gray-500 mb-4">스터디 노트의 카테고리를 관리합니다.</p>

      <!-- 작업 버튼 -->
      <div class="flex gap-2 mb-4">
        <button id="create-category-btn" class="btn btn-primary">
          <i class="fa-solid fa-plus"></i> 새 카테고리 생성
        </button>
        <a href="/study-management" class="btn btn-ghost">
          <i class="fa-solid fa-arrow-left"></i> 스터디 홈으로
        </a>
      </div>
      
      <div class="divider"></div>
      
      <!-- 카테고리 목록 테이블 -->
      <div class="overflow-x-auto">
        <table class="table table-zebra w-full">
      <thead>
        <tr>
          <th>이름</th>
          <th>설명</th>
          <th>포스트 수</th>
          <th>생성일</th>
          <th>표시 순서</th>
          <th>관리</th>
        </tr>
      </thead>
      <tbody>
        <!-- 카테고리가 없는 경우 -->
        <tr th:if="${categoriesResponse == null || categoriesResponse.categories == null || categoriesResponse.categories.isEmpty()}">
          <td colspan="6" class="text-center">등록된 카테고리가 없습니다.</td>
        </tr>
        
        <!-- 최상위 카테고리 목록 -->
        <tr th:unless="${categoriesResponse == null || categoriesResponse.categories == null || categoriesResponse.categories.isEmpty()}"
            th:each="category : ${categoriesResponse.categories}">
          <td>
            <i th:class="'fa-solid fa-' + (${category.icon != null ? category.icon.replace(' icon', '').replace(' ', '-') : 'folder'})"
               th:style="${category.color != null ? 'color:' + category.color : ''}"></i>
            <a th:href="@{/study-management/category/{id}(id=${category.id})}" th:text="${category.name}" class="ml-2"></a>
          </td>
          <td th:text="${category.description != null ? category.description : '-'}"></td>
          <td th:text="${category.postCount != null ? category.postCount : 0}"></td>
          <td th:text="${#temporals.format(category.createdDate, 'yyyy-MM-dd')}"></td>
          <td th:text="${category.displayOrder != null ? category.displayOrder : '-'}"></td>
          <td>
            <div class="flex gap-2">
              <button class="btn btn-sm btn-primary edit-category-btn"
                      th:data-id="${category.id}"
                      th:data-name="${category.name}"
                      th:data-description="${category.description}"
                      th:data-icon="${category.icon}"
                      th:data-color="${category.color}"
                      th:data-order="${category.displayOrder}">
                <i class="fa-solid fa-edit"></i>
              </button>
              <button class="btn btn-sm btn-error delete-category-btn"
                      th:data-id="${category.id}"
                      th:data-name="${category.name}">
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
        
        <!-- 하위 카테고리 목록 -->
        <th:block th:unless="${categoriesResponse == null || categoriesResponse.categories == null || categoriesResponse.categories.isEmpty()}">
          <th:block th:each="parentCat : ${categoriesResponse.categories}" th:if="${!parentCat.children.isEmpty()}">
            <tr th:each="childCat : ${parentCat.children}"
                class="child-category-row">
          <td>
            <div class="ml-6">
              <i th:class="'fa-solid fa-' + (${childCat.icon != null ? childCat.icon.replace(' icon', '').replace(' ', '-') : 'file'})"
                 th:style="${childCat.color != null ? 'color:' + childCat.color : ''}"></i>
              <a th:href="@{/study-management/category/{id}(id=${childCat.id})}" th:text="${childCat.name}" class="ml-2"></a>
              <span class="badge badge-sm ml-2" th:text="${parentCat.name}"></span>
            </div>
          </td>
          <td th:text="${childCat.description != null ? childCat.description : '-'}"></td>
          <td th:text="${childCat.postCount != null ? childCat.postCount : 0}"></td>
          <td th:text="${#temporals.format(childCat.createdDate, 'yyyy-MM-dd')}"></td>
          <td th:text="${childCat.displayOrder != null ? childCat.displayOrder : '-'}"></td>
          <td>
            <div class="flex gap-2">
              <button class="btn btn-sm btn-primary edit-category-btn"
                      th:data-id="${childCat.id}"
                      th:data-name="${childCat.name}"
                      th:data-description="${childCat.description}"
                      th:data-icon="${childCat.icon}"
                      th:data-color="${childCat.color}"
                      th:data-order="${childCat.displayOrder}"
                      th:data-parent-id="${parentCat.id}">
                <i class="fa-solid fa-edit"></i>
              </button>
              <button class="btn btn-sm btn-error delete-category-btn"
                      th:data-id="${childCat.id}"
                      th:data-name="${childCat.name}">
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
            </th:block>
          </th:block>
      </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- 카테고리 생성/수정 모달 -->
<dialog id="category-modal" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4" id="modal-title">카테고리 생성</h3>
    <form id="category-form">
      <input type="hidden" id="category-id" name="id">
      
      <div class="form-control mb-4">
        <label class="label">
          <span class="label-text">카테고리 이름</span>
        </label>
        <input type="text" id="category-name" name="categoryName" placeholder="카테고리 이름" class="input input-bordered w-full" required>
      </div>
      
      <div class="form-control mb-4">
        <label class="label">
          <span class="label-text">설명</span>
        </label>
        <textarea id="category-description" name="categoryDescription" rows="2" placeholder="카테고리 설명" class="textarea textarea-bordered"></textarea>
      </div>
      
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="form-control">
          <label class="label">
            <span class="label-text">아이콘 (Font Awesome 클래스)</span>
          </label>
          <input type="text" id="category-icon" name="categoryIcon" placeholder="예: folder icon" class="input input-bordered w-full">
        </div>
        
        <div class="form-control">
          <label class="label">
            <span class="label-text">색상 (CSS 컬러값)</span>
          </label>
          <input type="text" id="category-color" name="categoryColor" placeholder="예: #3B82F6" class="input input-bordered w-full">
        </div>
      </div>
      
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="form-control">
          <label class="label">
            <span class="label-text">표시 순서</span>
          </label>
          <input type="number" id="category-order" name="categoryDisplayOrder" placeholder="숫자가 작을수록 먼저 표시됩니다" class="input input-bordered w-full">
        </div>
        
        <div class="form-control">
          <label class="label">
            <span class="label-text">상위 카테고리</span>
          </label>
          <select id="category-parent" name="parentCategoryId" class="select select-bordered w-full">
            <option value="">없음 (최상위 카테고리)</option>
            <option th:each="category : ${categoriesResponse.categories}"
                    th:value="${category.id}"
                    th:text="${category.name}"></option>
          </select>
        </div>
      </div>
      
      <div class="modal-action">
        <button type="button" class="btn btn-ghost" id="cancel-btn">취소</button>
        <button type="button" class="btn btn-primary" id="save-btn">저장</button>
      </div>
    </form>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

<!-- 카테고리 삭제 확인 모달 -->
<dialog id="delete-confirm-modal" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">카테고리 삭제</h3>
    <p class="mb-4">정말로 카테고리 "<span id="delete-category-name" class="font-bold"></span>"을(를) 삭제하시겠습니까?</p>
    <div class="alert alert-error">
      <i class="fa-solid fa-triangle-exclamation"></i>
      <span>주의: 하위 카테고리나 포스트가 있는 카테고리는 삭제할 수 없습니다.</span>
    </div>
    <div class="modal-action">
      <button type="button" class="btn btn-error" id="confirm-delete-btn">삭제</button>
      <button type="button" class="btn btn-ghost" id="cancel-delete-btn">취소</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

<div th:replace="~{fragments/footer :: footer}"></div>

<script>
  $(document).ready(function() {
    // 카테고리 생성 버튼 클릭
    $('#create-category-btn').on('click', function() {
      // 모달 폼 초기화
      $('#category-form')[0].reset();
      $('#category-id').val('');
      $('#modal-title').text('카테고리 생성');
      
      // 모달 표시
      document.getElementById('category-modal').showModal();
    });
    
    // 카테고리 수정 버튼 클릭
    $('.edit-category-btn').on('click', function() {
      // 모달 폼에 데이터 설정
      $('#category-id').val($(this).data('id'));
      $('#category-name').val($(this).data('name'));
      $('#category-description').val($(this).data('description'));
      $('#category-icon').val($(this).data('icon'));
      $('#category-color').val($(this).data('color'));
      $('#category-order').val($(this).data('order'));
      $('#category-parent').val($(this).data('parent-id') || '');
      
      // 모달 타이틀 설정
      $('#modal-title').text('카테고리 수정');
      
      // 모달 표시
      document.getElementById('category-modal').showModal();
    });
    
    // 카테고리 삭제 버튼 클릭
    $('.delete-category-btn').on('click', function() {
      const categoryId = $(this).data('id');
      const categoryName = $(this).data('name');
      
      // 삭제 확인 모달에 카테고리 이름 설정
      $('#delete-category-name').text(categoryName);
      
      // 삭제 버튼에 카테고리 ID 설정
      $('#confirm-delete-btn').data('id', categoryId);
      
      // 삭제 확인 모달 표시
      document.getElementById('delete-confirm-modal').showModal();
    });
    
    // 카테고리 저장 버튼 클릭
    $('#save-btn').on('click', function() {
      const formData = new FormData($('#category-form')[0]);
      
      // API URL 결정 (생성 또는 수정)
      const categoryId = $('#category-id').val();
      const apiUrl = categoryId ? '/api/study/category/update' : '/api/study/category/create';
      
      // API 호출
      $.ajax({
        url: apiUrl,
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
          if (response) {
            // 성공 시 페이지 새로고침
            location.reload();
          } else {
            if (typeof showToast === 'function') {
              showToast('카테고리 저장 중 오류가 발생했습니다.', 'negative');
            }
          }
        },
        error: function(xhr, status, error) {
          // 전역 핸들러가 toast를 표시함
          console.error('카테고리 저장 오류:', xhr.responseText);
        }
      });
    });
    
    // 카테고리 삭제 확인 버튼 클릭
    $('#confirm-delete-btn').on('click', function() {
      const categoryId = $(this).data('id');
      
      // API 호출
      $.ajax({
        url: '/api/study/category/delete',
        type: 'POST',
        data: {
          id: categoryId
        },
        success: function() {
          // 성공 시 페이지 새로고침
          location.reload();
        },
        error: function(xhr, status, error) {
          // 전역 핸들러가 toast를 표시함
          console.error('카테고리 삭제 오류:', xhr.responseText);
        }
      });
    });
    
    // 모달 취소 버튼
    $('#cancel-btn').on('click', function() {
      document.getElementById('category-modal').close();
    });
    
    $('#cancel-delete-btn').on('click', function() {
      document.getElementById('delete-confirm-modal').close();
    });
  });
</script>
</body>
</html>
