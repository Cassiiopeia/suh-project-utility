name: ì´ìŠˆ ë¸Œëœì¹˜/ì»¤ë°‹ ê°€ì´ë“œ ìë™ ëŒ“ê¸€

on:
  issues:
    types: [opened, reopened]

jobs:
  add-comment:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Get Issue information
        id: issue-info
        run: |
          echo "ISSUE_URL=${{ github.event.issue.html_url }}" >> $GITHUB_ENV
      
      - name: Call Suh Project Utility API
        id: api-call
        uses: fjogeleit/http-request-action@v1
        with:
          url: 'https://lab.suhsaechan.me/api/issue-helper/create/commmit-branch/github-workflow'
          method: 'POST'
          contentType: 'multipart/form-data'
          customHeaders: '{"Accept": "application/json"}'
          data: |
            {
              "issueUrl": "${{ env.ISSUE_URL }}"
            }
            
      - name: Debug API Response
        run: |
          echo "API Status: ${{ steps.api-call.outputs.status }}"
          echo "API Response: ${{ steps.api-call.outputs.response }}"
            
      - name: Check API response
        id: check-response
        run: |
          if [ "${{ steps.api-call.outputs.status }}" == "200" ]; then
            echo "API call successful"
            # ì‘ë‹µì—ì„œ commentMarkdown í•„ë“œ ì¶”ì¶œ (ì‘ë‹µì´ JSON í˜•ì‹ì¸ì§€ í™•ì¸)
            MARKDOWN=$(echo '${{ steps.api-call.outputs.response }}' | jq -r '.commentMarkdown // empty')
            
            if [ -n "$MARKDOWN" ]; then
              echo "COMMENT_BODY=$MARKDOWN" >> $GITHUB_ENV
            else
              # fallback - JSONì—ì„œ í•„ìš”í•œ ì •ë³´ë¥¼ ìˆ˜ë™ìœ¼ë¡œ êµ¬ì„±
              BRANCH=$(echo '${{ steps.api-call.outputs.response }}' | jq -r '.branchName // "ë¸Œëœì¹˜ëª…ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"')
              COMMIT=$(echo '${{ steps.api-call.outputs.response }}' | jq -r '.commitMessage // "ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"')
              
              COMMENT_MD="<!-- ì´ ëŒ“ê¸€ì€ SUH Project Utilityì— ì˜í•´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. - https://lab.suhsaechan.me -->\n\n## ğŸ› ï¸ ë¸Œëœì¹˜/ì»¤ë°‹ ê°€ì´ë“œ\n\n### ë¸Œëœì¹˜\n\`\`\`\n$BRANCH\n\`\`\`\n\n### ì»¤ë°‹ ë©”ì‹œì§€\n\`\`\`\n$COMMIT\n\`\`\`\n\n<!-- ì´ ëŒ“ê¸€ì€ SUH Project Utilityì— ì˜í•´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. - https://lab.suhsaechan.me -->"
              
              echo "COMMENT_BODY<<EOF" >> $GITHUB_ENV
              echo -e "$COMMENT_MD" >> $GITHUB_ENV
              echo "EOF" >> $GITHUB_ENV
            fi
          else
            echo "API call failed with status ${{ steps.api-call.outputs.status }}"
            echo "COMMENT_BODY=API í˜¸ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë ˆí¬ì§€í† ë¦¬ê°€ í—ˆìš© ëª©ë¡ì— ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”." >> $GITHUB_ENV
          fi
      
      - name: Add comment to Issue
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentBody = process.env.COMMENT_BODY;
            if (!commentBody) {
              core.setFailed('ëŒ“ê¸€ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
              return;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
