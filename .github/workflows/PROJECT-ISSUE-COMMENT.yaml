name: ì´ìŠˆ ë¸Œëœì¹˜/ì»¤ë°‹ ê°€ì´ë“œ ìë™ ëŒ“ê¸€

on:
  issues:
    types: [opened, reopened]

jobs:
  add-comment:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Get Issue information
        id: issue-info
        run: |
          echo "ISSUE_URL=${{ github.event.issue.html_url }}" >> $GITHUB_ENV

      - name: Call Suh Project Utility API (multipart)
        id: api-call
        shell: bash
        run: |
          set -euo pipefail
          URL='https://lab.suhsaechan.me/api/issue-helper/create/commit-branch/github-workflow'
          RESPONSE=$(curl -sS -X POST \
            -H 'Accept: application/json' \
            -F "issueUrl=${ISSUE_URL}" \
            "${URL}" -w '\n%{http_code}')
          STATUS=$(echo "${RESPONSE}" | tail -n1)
          BODY=$(echo "${RESPONSE}" | sed '$d')
          DELIM="GHOUT_$(date +%s%N)"
          echo "status=${STATUS}" >> "$GITHUB_OUTPUT"
          {
            echo "body<<${DELIM}"
            echo "${BODY}"
            echo "${DELIM}"
          } >> "$GITHUB_OUTPUT"

      - name: Debug API Response (safe)
        env:
          API_STATUS: ${{ steps.api-call.outputs.status }}
          API_BODY: ${{ steps.api-call.outputs.body }}
        run: |
          printf 'API Status: %s\n' "$API_STATUS"
          printf 'API Response Body (raw):\n%s\n' "$API_BODY"

      - name: Check API response
        id: check-response
        shell: bash
        run: |
          set -euo pipefail
          STATUS='${{ steps.api-call.outputs.status }}'
          BODY='${{ steps.api-call.outputs.body }}'
          if [ "${STATUS}" = "200" ]; then
            echo "API call successful"
            # JSON ì‹œë„ íŒŒì‹± (ì‹¤íŒ¨ì‹œ ë¬´ì‹œ)
            MARKDOWN=$(printf '%s' "${BODY}" | jq -e -r 'try .commentMarkdown // empty' 2>/dev/null || true)
            if [ -n "${MARKDOWN}" ]; then
              {
                echo "COMMENT_BODY<<'EOF'"
                echo "${MARKDOWN}"
                echo "EOF"
              } >> "$GITHUB_ENV"
            else
              BRANCH=$(printf '%s' "${BODY}" | jq -e -r 'try .branchName // empty' 2>/dev/null || true)
              COMMIT=$(printf '%s' "${BODY}" | jq -e -r 'try .commitMessage // empty' 2>/dev/null || true)
              [ -z "${BRANCH}" ] && BRANCH='ë¸Œëœì¹˜ëª…ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
              [ -z "${COMMIT}" ] && COMMIT='ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
              COMMENT_MD="<!-- ì´ ëŒ“ê¸€ì€ SUH Project Utilityì— ì˜í•´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. - https://lab.suhsaechan.me -->\n\n## ğŸ› ï¸ ë¸Œëœì¹˜/ì»¤ë°‹ ê°€ì´ë“œ\n\n### ë¸Œëœì¹˜\n\`\`\`\n${BRANCH}\n\`\`\`\n\n### ì»¤ë°‹ ë©”ì‹œì§€\n\`\`\`\n${COMMIT}\n\`\`\`\n\n<!-- ì´ ëŒ“ê¸€ì€ SUH Project Utilityì— ì˜í•´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. - https://lab.suhsaechan.me -->"
              {
                echo "COMMENT_BODY<<'EOF'"
                echo -e "${COMMENT_MD}"
                echo "EOF"
              } >> "$GITHUB_ENV"
            fi
          else
            echo "API call failed with status ${STATUS}"
            echo "COMMENT_BODY=API í˜¸ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë ˆí¬ì§€í† ë¦¬ê°€ í—ˆìš© ëª©ë¡ì— ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”." >> "$GITHUB_ENV"
          fi

      - name: Add comment to Issue
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentBody = process.env.COMMENT_BODY;
            if (!commentBody) {
              core.setFailed('ëŒ“ê¸€ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
              return;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });