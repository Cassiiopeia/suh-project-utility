# ===================================================================
# Spring Boot + Synology PR/Issue Preview ÏãúÏä§ÌÖú
# ===================================================================
#
# PR ÎòêÎäî Issue ÏΩîÎ©òÌä∏ Î™ÖÎ†πÏñ¥Î•º ÌÜµÌï¥ Preview ÌôòÍ≤ΩÏùÑ ÏûêÎèôÏúºÎ°ú Í¥ÄÎ¶¨Ìï©ÎãàÎã§.
# Traefik Î¶¨Î≤ÑÏä§ ÌîÑÎ°ùÏãúÎ•º ÌÜµÌï¥ ÎèôÏ†Å ÎùºÏö∞ÌåÖÎê©ÎãàÎã§.
#
# üöÄ ÏÇ¨Ïö©Î≤ï:
#   @suh-lab server build    - PR/Issue ÎπåÎìú Î∞è Î∞∞Ìè¨ (Í∏∞Ï°¥ Ïª®ÌÖåÏù¥ÎÑà ÏûêÎèô ÍµêÏ≤¥)
#   @suh-lab server destroy  - Preview ÌôòÍ≤Ω ÏÇ≠Ï†ú
#   @suh-lab server status   - ÌòÑÏû¨ ÏÉÅÌÉú ÌôïÏù∏
#
# üìå IssueÏóêÏÑú ÎπåÎìú Ïãú:
#   - Issue Helper ÎåìÍ∏ÄÏóêÏÑú Î∏åÎûúÏπòÎ™ÖÏùÑ ÏûêÎèôÏúºÎ°ú Ï∂îÏ∂úÌï©ÎãàÎã§.
#   - ISSUE_HELPER_MARKER ÌôòÍ≤ΩÎ≥ÄÏàòÎ°ú ÎßàÏª§Î•º ÏÑ§Ï†ïÌï† Ïàò ÏûàÏäµÎãàÎã§.
#
# ‚öôÔ∏è ÌîÑÎ°úÏ†ùÌä∏Î≥Ñ ÌïÑÏàò ÏàòÏ†ï ÏÇ¨Ìï≠:
#   ÏïÑÎûò env ÏÑπÏÖòÏùò Í∞íÎì§ÏùÑ ÌîÑÎ°úÏ†ùÌä∏Ïóê ÎßûÍ≤å ÏàòÏ†ïÌïòÏÑ∏Ïöî.
#
# üîë GitHub Secrets:
#
#   [ÌïÑÏàò] Î™®Îì† ÌîÑÎ°úÏ†ùÌä∏ Í≥µÌÜµ:
#   - APPLICATION_YML: Spring application.yml Ï†ÑÏ≤¥ ÎÇ¥Ïö©
#   - DOCKERHUB_USERNAME: Docker Hub ÏÇ¨Ïö©ÏûêÎ™Ö
#   - DOCKERHUB_TOKEN: Docker Hub Ïï°ÏÑ∏Ïä§ ÌÜ†ÌÅ∞
#   - SERVER_HOST: ÏãúÎÜÄÎ°úÏßÄ ÏÑúÎ≤Ñ Ìò∏Ïä§Ìä∏ (Ïòà: suh-project.synology.me)
#   - SERVER_USER: SSH ÏÇ¨Ïö©ÏûêÎ™Ö
#   - SERVER_PASSWORD: SSH ÎπÑÎ∞ÄÎ≤àÌò∏
#
# üìã ÏÇ¨Ï†Ñ ÏöîÍµ¨ÏÇ¨Ìï≠:
#   - Traefik Ïª®ÌÖåÏù¥ÎÑà Ïã§Ìñâ Ï§ë (traefik-network)
#   - ÏôÄÏùºÎìúÏπ¥Îìú DNS ÏÑ§Ï†ï: *.pr.suhsaechan.kr ‚Üí ÏÑúÎ≤Ñ
#   - ÏÑúÎ≤ÑÏóê ÌîÑÎ°úÏ†ùÌä∏ ÎîîÎ†âÌÜ†Î¶¨ Ï°¥Ïû¨
#
#   ‚Äª Health CheckÎäî ÏûêÎèôÏúºÎ°ú ÏµúÏ†Å Î∞©Ïãù ÏÑ†ÌÉù (Ï∂îÍ∞Ä ÏÑ§Ï†ï Î∂àÌïÑÏöî):
#     - Spring Actuator ÏûàÏúºÎ©¥ ‚Üí /actuator/health ÏÇ¨Ïö©
#     - ÏóÜÏúºÎ©¥ ‚Üí Í∏∞Îèô Î°úÍ∑∏ Ìå®ÌÑ¥ÏúºÎ°ú ÌôïÏù∏ ("Started ... in ... seconds")
#
# üåê Traefik ÎåÄÏãúÎ≥¥Îìú:
#   https://traefik.suhsaechan.kr/dashboard/#/
#
#   ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú ÌôïÏù∏ Í∞ÄÎä•Ìïú Ï†ïÎ≥¥:
#   - Entrypoints: Ìä∏ÎûòÌîΩ ÏßÑÏûÖÏ†ê (web:80, traefik:8080)
#   - HTTP Routers: PR Preview ÎùºÏö∞ÌåÖ Í∑úÏπô Î™©Î°ù
#   - HTTP Services: Ïó∞Í≤∞Îêú Ïª®ÌÖåÏù¥ÎÑà ÏÑúÎπÑÏä§ Î™©Î°ù
#   - Middlewares: Ï†ÅÏö©Îêú ÎØ∏Îì§Ïõ®Ïñ¥ (Ïù∏Ï¶ù, Î¶¨Îã§Ïù¥Î†âÌä∏ Îì±)
#   - Providers: Docker ÌîÑÎ°úÎ∞îÏù¥Îçî ÏÉÅÌÉú
#
#   Î∞∞Ìè¨ ÌõÑ ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú ÏÉàÎ°úÏö¥ Router/ServiceÍ∞Ä Ï∂îÍ∞ÄÎêòÏóàÎäîÏßÄ ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§.
#   Ïòà: Router "suh-project-utility-pr-123" ‚Üí Service "suh-project-utility-pr-123"
#
# üìä Î¶¨ÏÜåÏä§ ÎÑ§Ïù¥Î∞ç Í∑úÏπô:
#   - Ïª®ÌÖåÏù¥ÎÑà: {PROJECT_NAME}-pr-{PR/IssueÎ≤àÌò∏}
#   - Ïù¥ÎØ∏ÏßÄ: {DOCKERHUB_USERNAME}/{PROJECT_NAME}:pr-{PR/IssueÎ≤àÌò∏}
#   - ÎèÑÎ©îÏù∏: {PROJECT_NAME}-pr-{PR/IssueÎ≤àÌò∏}.pr.suhsaechan.kr
#   - Preview URL: http://{ÎèÑÎ©îÏù∏}:8079
#
# ===================================================================

name: PROJECT-SPRING-SYNOLOGY-PR-PREVIEW

# ===================================================================
# ‚ö†Ô∏è ÌîÑÎ°úÏ†ùÌä∏Î≥Ñ ÏÑ§Ï†ï - Îã§Î•∏ ÌîÑÎ°úÏ†ùÌä∏ÏóêÏÑú ÏÇ¨Ïö© Ïãú Ïù¥ ÏÑπÏÖòÎßå ÏàòÏ†ïÌïòÏÑ∏Ïöî
# ===================================================================
env:
  # ÌîÑÎ°úÏ†ùÌä∏ Í≥†Ïú† ÏãùÎ≥ÑÏûê (Ïª®ÌÖåÏù¥ÎÑàÎ™Ö, Ïù¥ÎØ∏ÏßÄÎ™Ö, ÎèÑÎ©îÏù∏Ïóê ÏÇ¨Ïö©)
  PROJECT_NAME: suh-project-utility

  # Spring Boot ÎπåÎìú ÏÑ§Ï†ï
  JAVA_VERSION: '17'
  GRADLE_BUILD_CMD: './gradlew clean build -x test -Dspring.profiles.active=prod'
  JAR_PATH: 'Suh-Web/build/libs/app.jar'
  APPLICATION_YML_PATH: 'Suh-Web/src/main/resources/application.yml'

  # Docker ÏÑ§Ï†ï
  DOCKERFILE_PATH: './Dockerfile'
  INTERNAL_PORT: '8080'

  # Traefik & Preview ÎèÑÎ©îÏù∏ ÏÑ§Ï†ï
  TRAEFIK_NETWORK: traefik-network
  PREVIEW_DOMAIN_SUFFIX: pr.suhsaechan.kr
  PREVIEW_PORT: '8079'

  # SSH Ìè¨Ìä∏ (ÏãúÎÜÄÎ°úÏßÄ Í∏∞Î≥∏Í∞í)
  SSH_PORT: '2022'

  # Issue Helper ÎåìÍ∏Ä ÎßàÏª§ (ÌîÑÎ°úÏ†ùÌä∏Î≥Ñ ÏàòÏ†ï ÌïÑÏöî)
  # Issue ÎåìÍ∏ÄÏóêÏÑú Î∏åÎûúÏπòÎ™ÖÏùÑ Ï∂îÏ∂úÌï† Îïå ÏÇ¨Ïö©
  ISSUE_HELPER_MARKER: 'Guide by SUH-LAB'

# ===================================================================
# Ìä∏Î¶¨Í±∞ ÏÑ§Ï†ï
# ===================================================================
on:
  issue_comment:
    types: [created]      # PR ÎåìÍ∏Ä + Issue ÎåìÍ∏Ä
  issues:
    types: [closed]       # Issue Îã´Ìûò Ïãú destroy
  pull_request:
    types: [closed]       # PR Îã´Ìûò Ïãú destroy

permissions:
  contents: read
  pull-requests: write
  issues: write

# ===================================================================
# Jobs
# ===================================================================
jobs:
  # -----------------------------------------------------------------
  # Job 1: Î™ÖÎ†πÏñ¥ ÌååÏã± (PR ÎåìÍ∏Ä + Issue ÎåìÍ∏Ä Î™®Îëê ÏßÄÏõê)
  # -----------------------------------------------------------------
  check-command:
    name: Î™ÖÎ†πÏñ¥ ÌôïÏù∏
    if: github.event_name == 'issue_comment'
    runs-on: ubuntu-latest
    outputs:
      command: ${{ steps.parse.outputs.command }}
      is_valid: ${{ steps.parse.outputs.is_valid }}
      is_pr: ${{ steps.parse.outputs.is_pr }}
    steps:
      - name: ÎåìÍ∏ÄÏóê üëÄ Î¶¨Ïï°ÏÖò Ï∂îÍ∞Ä
        if: contains(github.event.comment.body, '@suh-lab') && contains(github.event.comment.body, 'server')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

      - name: Ïª§Îß®Îìú ÌååÏã±
        id: parse
        env:
          COMMENT: ${{ github.event.comment.body }}
          IS_PR: ${{ github.event.issue.pull_request }}
        run: |
          # PRÏù∏ÏßÄ IssueÏù∏ÏßÄ ÌôïÏù∏
          if [[ "$IS_PR" != "" ]]; then
            echo "is_pr=true" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è PR ÎåìÍ∏ÄÏóêÏÑú Î™ÖÎ†πÏñ¥ Í∞êÏßÄ"
          else
            echo "is_pr=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Issue ÎåìÍ∏ÄÏóêÏÑú Î™ÖÎ†πÏñ¥ Í∞êÏßÄ"
          fi

          # COMMENT Ï†ÑÎã¨
          if [[ "$COMMENT" =~ @suh-lab[[:space:]]+server[[:space:]]+build ]]; then
            echo "command=build" >> $GITHUB_OUTPUT
            echo "is_valid=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Î™ÖÎ†πÏñ¥ Í∞êÏßÄ: build"
          elif [[ "$COMMENT" =~ @suh-lab[[:space:]]+server[[:space:]]+destroy ]]; then
            echo "command=destroy" >> $GITHUB_OUTPUT
            echo "is_valid=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Î™ÖÎ†πÏñ¥ Í∞êÏßÄ: destroy"
          elif [[ "$COMMENT" =~ @suh-lab[[:space:]]+server[[:space:]]+status ]]; then
            echo "command=status" >> $GITHUB_OUTPUT
            echo "is_valid=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Î™ÖÎ†πÏñ¥ Í∞êÏßÄ: status"
          else
            echo "is_valid=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è @suh-lab server Î™ÖÎ†πÏñ¥Í∞Ä ÏïÑÎãò"
          fi

  # -----------------------------------------------------------------
  # Job 2: IssueÏóêÏÑú Î∏åÎûúÏπòÎ™Ö Ï∂îÏ∂ú
  # -----------------------------------------------------------------
  get-branch-from-issue:
    name: IssueÏóêÏÑú Î∏åÎûúÏπò Ï∂îÏ∂ú
    needs: check-command
    if: |
      needs.check-command.outputs.is_valid == 'true' &&
      needs.check-command.outputs.is_pr == 'false'
    runs-on: ubuntu-latest
    outputs:
      branch_name: ${{ steps.extract.outputs.branch }}
      found: ${{ steps.extract.outputs.found }}
      issue_number: ${{ steps.extract.outputs.issue_number }}
    steps:
      - name: Issue ÎåìÍ∏ÄÏóêÏÑú Î∏åÎûúÏπòÎ™Ö Ï∂îÏ∂ú
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue.number;
            const marker = '${{ env.ISSUE_HELPER_MARKER }}';

            console.log(`üîç Issue #${issueNumber}ÏóêÏÑú Î∏åÎûúÏπò Í≤ÄÏÉâ Ï§ë...`);
            console.log(`üìù ÎßàÏª§: ${marker}`);

            // IssueÏùò Î™®Îì† ÎåìÍ∏Ä Ï°∞Ìöå
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            // Î∏åÎûúÏπò Ï∂îÏ∂ú Ìå®ÌÑ¥ (ÎßàÏª§ÏôÄ Î¨¥Í¥ÄÌïòÍ≤å ÎèôÏùºÌïú ÌòïÏãù)
            // "### Î∏åÎûúÏπò" ÎòêÎäî "### Î∏åÎûúÏπòÎ™Ö" Îëò Îã§ Îß§Ïπ≠
            const branchRegex = /###\s*Î∏åÎûúÏπò(?:Î™Ö)?\s*\n```\s*\n([^\n]+)\s*\n```/;

            for (const comment of comments.data) {
              // ÎßàÏª§Í∞Ä Ìè¨Ìï®Îêú ÎåìÍ∏Ä Ï∞æÍ∏∞
              if (comment.body.includes(marker)) {
                const match = comment.body.match(branchRegex);
                if (match) {
                  const branchName = match[1].trim();
                  core.setOutput('branch', branchName);
                  core.setOutput('found', 'true');
                  core.setOutput('issue_number', issueNumber);
                  console.log(`‚úÖ Î∏åÎûúÏπò Î∞úÍ≤¨: ${branchName}`);
                  return;
                }
              }
            }

            // Î∏åÎûúÏπòÎ•º Ï∞æÏßÄ Î™ªÌïú Í≤ΩÏö∞ - ÏóêÎü¨Í∞Ä ÏïÑÎãò, gracefulÌïòÍ≤å Ï≤òÎ¶¨
            core.setOutput('found', 'false');
            core.setOutput('issue_number', issueNumber);
            console.log('‚ö†Ô∏è Issue Helper ÎåìÍ∏ÄÏóêÏÑú Î∏åÎûúÏπòÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');

      - name: Î∏åÎûúÏπò ÏóÜÏùå ÏïåÎ¶º
        if: steps.extract.outputs.found == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue.number;
            const marker = '${{ env.ISSUE_HELPER_MARKER }}';

            const body = [
              '## ‚ö†Ô∏è Î∏åÎûúÏπòÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§',
              '',
              '| Ìï≠Î™© | Í∞í |',
              '|------|-----|',
              `| **Issue** | #${issueNumber} |`,
              `| **ÎßàÏª§** | \`${marker}\` |`,
              '',
              '### üí° ÌôïÏù∏ ÏÇ¨Ìï≠',
              '1. Issue Helper ÎåìÍ∏ÄÏù¥ Ï°¥Ïû¨ÌïòÎäîÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî',
              '2. ÎåìÍ∏ÄÏóê `### Î∏åÎûúÏπò` ÏÑπÏÖòÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî',
              '3. `ISSUE_HELPER_MARKER` ÌôòÍ≤ΩÎ≥ÄÏàòÍ∞Ä Ïò¨Î∞îÎ•∏ÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî',
              '',
              '---',
              '*ü§ñ Ïù¥ ÎåìÍ∏ÄÏùÄ PR Preview ÏãúÏä§ÌÖúÏóê ÏùòÌï¥ ÏûêÎèô ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.*'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: body
            });

  # -----------------------------------------------------------------
  # Job 3-1: ÎπåÎìú & Î∞∞Ìè¨ (PR ÎåìÍ∏ÄÏóêÏÑú Ïã§Ìñâ)
  # -----------------------------------------------------------------
  build-preview-pr:
    name: Preview ÎπåÎìú & Î∞∞Ìè¨ (PR)
    needs: check-command
    if: |
      needs.check-command.outputs.is_valid == 'true' &&
      needs.check-command.outputs.command == 'build' &&
      needs.check-command.outputs.is_pr == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: PR Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('ref', pr.data.head.ref);
            core.setOutput('sha', pr.data.head.sha.substring(0, 7));
            return pr.data.number;

      # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
      # ÏßÑÌñâ ÏÉÅÌô© ÎåìÍ∏Ä ÏãúÏä§ÌÖú
      # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
      - name: ÏßÑÌñâ ÏÉÅÌô© ÎåìÍ∏Ä ÏÉùÏÑ±
        id: progress
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const startTime = Date.now();

            const body = [
              '## üöÄ PR Preview ÎπåÎìú Ï§ë...',
              '',
              '| Îã®Í≥Ñ | ÏÉÅÌÉú | ÏÜåÏöî ÏãúÍ∞Ñ |',
              '|------|------|----------|',
              '| üî® ÌîÑÎ°úÏ†ùÌä∏ ÎπåÎìú | ‚è≥ ÏßÑÌñâ Ï§ë... | - |',
              '| üê≥ Docker Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± | ‚è∏Ô∏è ÎåÄÍ∏∞ | - |',
              '| üöÄ ÏÑúÎ≤Ñ Î∞∞Ìè¨ & Health Check | ‚è∏Ô∏è ÎåÄÍ∏∞ | - |',
              '',
              `**[üìã Ïã§ÏãúÍ∞Ñ Î°úÍ∑∏ Î≥¥Í∏∞](${runUrl})**`,
              '',
              '---',
              '*ü§ñ Ïù¥ ÎåìÍ∏ÄÏùÄ ÏûêÎèôÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏Îê©ÎãàÎã§.*'
            ].join('\n');

            const { data: comment } = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

            core.setOutput('comment_id', comment.id);
            core.setOutput('start_time', startTime);

      - name: ÏΩîÎìú Ï≤¥ÌÅ¨ÏïÑÏõÉ
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.ref }}

      - name: JDK ÏÑ§Ï†ï
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Gradle Í∂åÌïú ÏÑ§Ï†ï
        run: chmod +x gradlew

      # =================================================================
      # ‚ö†Ô∏è [ÏòÅÏó≠ 2] ÌîÑÎ°úÏ†ùÌä∏Î≥Ñ Secret ÌååÏùº ÏÉùÏÑ±
      # =================================================================
      - name: "[ÌïÑÏàò] application.yml ÏÉùÏÑ±"
        run: |
          mkdir -p $(dirname ${{ env.APPLICATION_YML_PATH }})
          echo "${{ secrets.APPLICATION_YML }}" > ${{ env.APPLICATION_YML_PATH }}

      - name: Gradle ÎπåÎìú
        run: ${{ env.GRADLE_BUILD_CMD }}

      - name: ÏßÑÌñâ ÏÉÅÌô© - ÎπåÎìú ÏôÑÎ£å
        id: build_progress
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.progress.outputs.comment_id }};
            const startTime = ${{ steps.progress.outputs.start_time }};
            const now = Date.now();
            const elapsed = now - startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            const buildDuration = minutes > 0 ? `${minutes}Î∂Ñ ${seconds}Ï¥à` : `${seconds}Ï¥à`;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const body = [
              '## üöÄ PR Preview ÎπåÎìú Ï§ë...',
              '',
              '| Îã®Í≥Ñ | ÏÉÅÌÉú | ÏÜåÏöî ÏãúÍ∞Ñ |',
              '|------|------|----------|',
              `| üî® ÌîÑÎ°úÏ†ùÌä∏ ÎπåÎìú | ‚úÖ ÏôÑÎ£å | ${buildDuration} |`,
              '| üê≥ Docker Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± | ‚è≥ ÏßÑÌñâ Ï§ë... | - |',
              '| üöÄ ÏÑúÎ≤Ñ Î∞∞Ìè¨ & Health Check | ‚è∏Ô∏è ÎåÄÍ∏∞ | - |',
              '',
              `**[üìã Ïã§ÏãúÍ∞Ñ Î°úÍ∑∏ Î≥¥Í∏∞](${runUrl})**`,
              '',
              '---',
              '*ü§ñ Ïù¥ ÎåìÍ∏ÄÏùÄ ÏûêÎèôÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏Îê©ÎãàÎã§.*'
            ].join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

            core.setOutput('build_duration', buildDuration);
            core.setOutput('docker_start', now);

      - name: Docker Î°úÍ∑∏Ïù∏
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker Buildx ÏÑ§Ï†ï
        uses: docker/setup-buildx-action@v3

      - name: Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú & Push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ env.DOCKERFILE_PATH }}
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.PROJECT_NAME }}:pr-${{ github.event.issue.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ÏßÑÌñâ ÏÉÅÌô© - Docker ÏôÑÎ£å
        id: docker_progress
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.progress.outputs.comment_id }};
            const buildDuration = '${{ steps.build_progress.outputs.build_duration }}';
            const dockerStart = ${{ steps.build_progress.outputs.docker_start }};
            const now = Date.now();
            const dockerElapsed = now - dockerStart;
            const minutes = Math.floor(dockerElapsed / 60000);
            const seconds = Math.floor((dockerElapsed % 60000) / 1000);
            const dockerDuration = minutes > 0 ? `${minutes}Î∂Ñ ${seconds}Ï¥à` : `${seconds}Ï¥à`;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const body = [
              '## üöÄ PR Preview ÎπåÎìú Ï§ë...',
              '',
              '| Îã®Í≥Ñ | ÏÉÅÌÉú | ÏÜåÏöî ÏãúÍ∞Ñ |',
              '|------|------|----------|',
              `| üî® ÌîÑÎ°úÏ†ùÌä∏ ÎπåÎìú | ‚úÖ ÏôÑÎ£å | ${buildDuration} |`,
              `| üê≥ Docker Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± | ‚úÖ ÏôÑÎ£å | ${dockerDuration} |`,
              '| üöÄ ÏÑúÎ≤Ñ Î∞∞Ìè¨ & Health Check | ‚è≥ ÏßÑÌñâ Ï§ë... | - |',
              '',
              `**[üìã Ïã§ÏãúÍ∞Ñ Î°úÍ∑∏ Î≥¥Í∏∞](${runUrl})**`,
              '',
              '---',
              '*ü§ñ Ïù¥ ÎåìÍ∏ÄÏùÄ ÏûêÎèôÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏Îê©ÎãàÎã§.*'
            ].join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

            core.setOutput('build_duration', buildDuration);
            core.setOutput('docker_duration', dockerDuration);
            core.setOutput('deploy_start', now);

      - name: ÏÑúÎ≤ÑÏóê Î∞∞Ìè¨
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            set -e

            # ÌôòÍ≤Ω Î≥ÄÏàò ÏÑ§Ï†ï (ÏãúÎÜÄÎ°úÏßÄ NASÏö©)
            export PATH=$PATH:/usr/local/bin
            export PW="${{ secrets.SERVER_PASSWORD }}"

            # Î≥ÄÏàò ÏÑ§Ï†ï
            PR_NUMBER=${{ github.event.issue.number }}
            PROJECT_NAME="${{ env.PROJECT_NAME }}"
            CONTAINER_NAME="${PROJECT_NAME}-pr-${PR_NUMBER}"
            IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/${PROJECT_NAME}:pr-${PR_NUMBER}"
            DOMAIN="${PROJECT_NAME}-pr-${PR_NUMBER}.${{ env.PREVIEW_DOMAIN_SUFFIX }}"
            INTERNAL_PORT="${{ env.INTERNAL_PORT }}"
            TRAEFIK_NETWORK="${{ env.TRAEFIK_NETWORK }}"

            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "üöÄ PR Preview Î∞∞Ìè¨ ÏãúÏûë"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "üì¶ ÌîÑÎ°úÏ†ùÌä∏: ${PROJECT_NAME}"
            echo "üî¢ PR Î≤àÌò∏: #${PR_NUMBER}"
            echo "üìõ Ïª®ÌÖåÏù¥ÎÑà: ${CONTAINER_NAME}"
            echo "üåê ÎèÑÎ©îÏù∏: ${DOMAIN}"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

            # Ïù¥ÎØ∏ÏßÄ Pull
            echo "üì• Docker Ïù¥ÎØ∏ÏßÄ Pull Ï§ë..."
            echo $PW | sudo -S docker pull "${IMAGE}"

            # Í∏∞Ï°¥ Ïª®ÌÖåÏù¥ÎÑà ÏÇ≠Ï†ú
            echo "üóëÔ∏è Í∏∞Ï°¥ Ïª®ÌÖåÏù¥ÎÑà Ï†ïÎ¶¨ Ï§ë..."
            echo $PW | sudo -S docker rm -f "${CONTAINER_NAME}" 2>/dev/null || true

            # ÏÉà Ïª®ÌÖåÏù¥ÎÑà Ïã§Ìñâ
            echo "üê≥ ÏÉà Ïª®ÌÖåÏù¥ÎÑà Ïã§Ìñâ Ï§ë..."
            echo $PW | sudo -S docker run -d \
              --name "${CONTAINER_NAME}" \
              --network "${TRAEFIK_NETWORK}" \
              --label "traefik.enable=true" \
              --label "traefik.http.routers.${CONTAINER_NAME}.rule=Host(\`${DOMAIN}\`)" \
              --label "traefik.http.routers.${CONTAINER_NAME}.entrypoints=web" \
              --label "traefik.http.services.${CONTAINER_NAME}.loadbalancer.server.port=${INTERNAL_PORT}" \
              -e TZ=Asia/Seoul \
              -e SPRING_PROFILES_ACTIVE=prod \
              -v /etc/localtime:/etc/localtime:ro \
              "${IMAGE}"

            # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
            # Health Check (ÏµúÎåÄ 120Ï¥à ÎåÄÍ∏∞) - ÌïòÏù¥Î∏åÎ¶¨Îìú Î∞©Ïãù
            # 1. Actuator ÏûàÏúºÎ©¥ ‚Üí /actuator/health ÏÇ¨Ïö©
            # 2. ÏóÜÏúºÎ©¥ ‚Üí Î°úÍ∑∏ Ìå®ÌÑ¥ Îß§Ïπ≠ ("Started ... in ... seconds")
            # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
            echo ""
            echo "‚è≥ Health Check ÏãúÏûë (ÏµúÎåÄ 120Ï¥à ÎåÄÍ∏∞)..."
            MAX_RETRIES=24
            RETRY_COUNT=0
            HEALTH_CHECK_PASSED=false
            HEALTH_CHECK_METHOD=""

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              sleep 5
              RETRY_COUNT=$((RETRY_COUNT + 1))

              # 1. Ïª®ÌÖåÏù¥ÎÑà ÏÉÅÌÉú ÌôïÏù∏
              STATUS=$(echo $PW | sudo -S docker inspect --format='{{.State.Status}}' "${CONTAINER_NAME}" 2>/dev/null || echo "not_found")

              if [ "$STATUS" = "exited" ]; then
                echo "‚ùå Ïª®ÌÖåÏù¥ÎÑà ÎπÑÏ†ïÏÉÅ Ï¢ÖÎ£å!"
                echo ""
                echo "üìã Ïª®ÌÖåÏù¥ÎÑà Î°úÍ∑∏ (ÏµúÍ∑º 100Ï§Ñ):"
                echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                echo $PW | sudo -S docker logs --tail 100 "${CONTAINER_NAME}"
                echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                exit 1
              fi

              if [ "$STATUS" = "running" ]; then
                # 2. Actuator Health Check ÏãúÎèÑ (wget ÏÇ¨Ïö© - alpine Í∏∞Î≥∏ Ìè¨Ìï®)
                HEALTH=$(echo $PW | sudo -S docker exec "${CONTAINER_NAME}" wget -qO- http://localhost:${INTERNAL_PORT}/actuator/health 2>/dev/null || echo "")

                if echo "$HEALTH" | grep -q '"status":"UP"'; then
                  echo "‚úÖ Spring Boot Ï†ïÏÉÅ Í∏∞Îèô ÌôïÏù∏! (Actuator)"
                  HEALTH_CHECK_PASSED=true
                  HEALTH_CHECK_METHOD="Actuator"
                  break
                fi

                # 3. Actuator ÏóÜÏúºÎ©¥ Î°úÍ∑∏ Ìå®ÌÑ¥ Îß§Ïπ≠ÏúºÎ°ú Ìè¥Î∞±
                STARTED=$(echo $PW | sudo -S docker logs --tail 50 "${CONTAINER_NAME}" 2>&1 | grep -E "Started .* in [0-9.]+ seconds" || echo "")

                if [ -n "$STARTED" ]; then
                  echo "‚úÖ Spring Boot Ï†ïÏÉÅ Í∏∞Îèô ÌôïÏù∏! (Î°úÍ∑∏ Ìå®ÌÑ¥)"
                  echo "   $STARTED"
                  HEALTH_CHECK_PASSED=true
                  HEALTH_CHECK_METHOD="Log"
                  break
                fi
              fi

              echo "‚è≥ ÎåÄÍ∏∞ Ï§ë... ($RETRY_COUNT/$MAX_RETRIES) - ÏÉÅÌÉú: $STATUS"
            done

            if [ "$HEALTH_CHECK_PASSED" = "false" ]; then
              echo ""
              echo "‚ùå Health Check ÌÉÄÏûÑÏïÑÏõÉ (120Ï¥à)"
              echo ""
              echo "üìã Ïª®ÌÖåÏù¥ÎÑà Î°úÍ∑∏ (ÏµúÍ∑º 100Ï§Ñ):"
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo $PW | sudo -S docker logs --tail 100 "${CONTAINER_NAME}"
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              exit 1
            fi

            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "‚úÖ Î∞∞Ìè¨ Î∞è Health Check ÏôÑÎ£å! (Î∞©Ïãù: ${HEALTH_CHECK_METHOD})"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

      - name: Î∞∞Ìè¨ ÏôÑÎ£å ÏΩîÎ©òÌä∏
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.progress.outputs.comment_id }};
            const buildDuration = '${{ steps.docker_progress.outputs.build_duration }}';
            const dockerDuration = '${{ steps.docker_progress.outputs.docker_duration }}';
            const deployStart = ${{ steps.docker_progress.outputs.deploy_start }};
            const now = Date.now();
            const deployElapsed = now - deployStart;
            const minutes = Math.floor(deployElapsed / 60000);
            const seconds = Math.floor((deployElapsed % 60000) / 1000);
            const deployDuration = minutes > 0 ? `${minutes}Î∂Ñ ${seconds}Ï¥à` : `${seconds}Ï¥à`;

            const projectName = '${{ env.PROJECT_NAME }}';
            const domainSuffix = '${{ env.PREVIEW_DOMAIN_SUFFIX }}';
            const previewPort = '${{ env.PREVIEW_PORT }}';
            const prNumber = context.issue.number;
            const domain = `${projectName}-pr-${prNumber}.${domainSuffix}`;
            const previewUrl = `http://${domain}:${previewPort}`;
            const sha = '${{ steps.pr.outputs.sha }}';

            const body = [
              '## ‚úÖ PR Preview Î∞∞Ìè¨ ÏôÑÎ£å!',
              '',
              '| Îã®Í≥Ñ | ÏÉÅÌÉú | ÏÜåÏöî ÏãúÍ∞Ñ |',
              '|------|------|----------|',
              `| üî® ÌîÑÎ°úÏ†ùÌä∏ ÎπåÎìú | ‚úÖ ÏôÑÎ£å | ${buildDuration} |`,
              `| üê≥ Docker Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± | ‚úÖ ÏôÑÎ£å | ${dockerDuration} |`,
              `| üöÄ ÏÑúÎ≤Ñ Î∞∞Ìè¨ & Health Check | ‚úÖ ÏôÑÎ£å | ${deployDuration} |`,
              '',
              '### üåê Preview ÌôòÍ≤Ω',
              '| Ìï≠Î™© | Í∞í |',
              '|------|-----|',
              `| **Preview URL** | ${previewUrl} |`,
              `| **Ïª®ÌÖåÏù¥ÎÑà** | \`${projectName}-pr-${prNumber}\` |`,
              `| **Ïª§Î∞ã** | \`${sha}\` |`,
              '',
              '### üìã Î™ÖÎ†πÏñ¥',
              '| Î™ÖÎ†πÏñ¥ | ÏÑ§Î™Ö |',
              '|--------|------|',
              '| `@suh-lab server build` | ÏµúÏã† Ïª§Î∞ãÏúºÎ°ú Ïû¨Î∞∞Ìè¨ |',
              '| `@suh-lab server destroy` | Preview ÌôòÍ≤Ω ÏÇ≠Ï†ú |',
              '| `@suh-lab server status` | ÌòÑÏû¨ ÏÉÅÌÉú ÌôïÏù∏ |',
              '',
              '---',
              '*ü§ñ Ïù¥ ÎåìÍ∏ÄÏùÄ PR Preview ÏãúÏä§ÌÖúÏóê ÏùòÌï¥ ÏûêÎèô ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.*'
            ].join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

      - name: ÎπåÎìú/Î∞∞Ìè¨ Ïã§Ìå® Ïãú ÏóêÎü¨ ÏΩîÎ©òÌä∏
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.progress.outputs.comment_id || 0 }};
            const projectName = '${{ env.PROJECT_NAME }}';
            const prNumber = context.issue.number;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            // ÏßÑÌñâ ÏÉÅÌô©Ïóê Îî∞Îùº Ïñ¥ÎîîÏÑú Ïã§Ìå®ÌñàÎäîÏßÄ ÌëúÏãú
            const buildDuration = '${{ steps.build_progress.outputs.build_duration }}';
            const dockerDuration = '${{ steps.docker_progress.outputs.docker_duration }}';

            // Ïã§Ìå® ÏßÄÏ†ê ÌåêÎã® - Ï¥àÍ∏∞ Îã®Í≥Ñ Ïã§Ìå®ÎèÑ Íµ¨Î∂Ñ
            let buildStatus, dockerStatus, deployStatus;
            let buildTime = '-', dockerTime = '-';

            if (!commentId) {
              // ÏßÑÌñâ ÏÉÅÌô© ÎåìÍ∏Ä ÏÉùÏÑ± Ï†Ñ Ïã§Ìå® (Ï¥àÍ∏∞Ìôî Îã®Í≥Ñ)
              buildStatus = '‚ö†Ô∏è Ï¥àÍ∏∞Ìôî Ïã§Ìå®';
              dockerStatus = '-';
              deployStatus = '-';
            } else if (!buildDuration || buildDuration === '') {
              // ÎπåÎìú Îã®Í≥ÑÏóêÏÑú Ïã§Ìå®
              buildStatus = '‚ùå Ïã§Ìå®';
              dockerStatus = '‚è∏Ô∏è ÎåÄÍ∏∞';
              deployStatus = '‚è∏Ô∏è ÎåÄÍ∏∞';
            } else if (!dockerDuration || dockerDuration === '') {
              // Docker Îã®Í≥ÑÏóêÏÑú Ïã§Ìå®
              buildStatus = '‚úÖ ÏôÑÎ£å';
              dockerStatus = '‚ùå Ïã§Ìå®';
              deployStatus = '‚è∏Ô∏è ÎåÄÍ∏∞';
              buildTime = buildDuration;
            } else {
              // Î∞∞Ìè¨ Îã®Í≥ÑÏóêÏÑú Ïã§Ìå®
              buildStatus = '‚úÖ ÏôÑÎ£å';
              dockerStatus = '‚úÖ ÏôÑÎ£å';
              deployStatus = '‚ùå Ïã§Ìå®';
              buildTime = buildDuration;
              dockerTime = dockerDuration;
            }

            const body = [
              '## ‚ùå PR Preview Î∞∞Ìè¨ Ïã§Ìå®!',
              '',
              '| Îã®Í≥Ñ | ÏÉÅÌÉú | ÏÜåÏöî ÏãúÍ∞Ñ |',
              '|------|------|----------|',
              `| üî® ÌîÑÎ°úÏ†ùÌä∏ ÎπåÎìú | ${buildStatus} | ${buildTime} |`,
              `| üê≥ Docker Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± | ${dockerStatus} | ${dockerTime} |`,
              `| üöÄ ÏÑúÎ≤Ñ Î∞∞Ìè¨ & Health Check | ${deployStatus} | - |`,
              '',
              `**[üìã ÎπåÎìú/Î∞∞Ìè¨ Î°úÍ∑∏ ÌôïÏù∏](${runUrl})**`,
              '',
              '### üîç Í∞ÄÎä•Ìïú ÏõêÏù∏',
              '- Gradle ÎπåÎìú Ïã§Ìå®',
              '- Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú Ïã§Ìå®',
              '- Ïª®ÌÖåÏù¥ÎÑà ÏãúÏûë Ïã§Ìå® (Spring Boot Í∏∞Îèô Ïò§Î•ò)',
              '- Health Check ÌÉÄÏûÑÏïÑÏõÉ (120Ï¥à ÎÇ¥ Í∏∞Îèô ÏôÑÎ£å ÏïàÎê®)',
              '',
              '### üí° Îã§Ïùå Îã®Í≥Ñ',
              '1. ÏúÑ ÎßÅÌÅ¨ÏóêÏÑú ÎπåÎìú/Î∞∞Ìè¨ Î°úÍ∑∏Î•º ÌôïÏù∏ÌïòÏÑ∏Ïöî',
              '2. Î¨∏Ï†úÎ•º ÏàòÏ†ïÌïú ÌõÑ Îã§Ïãú ÏãúÎèÑÌïòÏÑ∏Ïöî: `@suh-lab server build`',
              '',
              '---',
              '*ü§ñ Ïù¥ ÎåìÍ∏ÄÏùÄ PR Preview ÏãúÏä§ÌÖúÏóê ÏùòÌï¥ ÏûêÎèô ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.*'
            ].join('\n');

            // ÏßÑÌñâ ÏÉÅÌô© ÎåìÍ∏ÄÏù¥ ÏûàÏúºÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏, ÏóÜÏúºÎ©¥ ÏÉàÎ°ú ÏÉùÏÑ±
            if (commentId) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: commentId,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }

  # -----------------------------------------------------------------
  # Job 3-2: ÎπåÎìú & Î∞∞Ìè¨ (Issue ÎåìÍ∏ÄÏóêÏÑú Ïã§Ìñâ)
  # -----------------------------------------------------------------
  build-preview-issue:
    name: Preview ÎπåÎìú & Î∞∞Ìè¨ (Issue)
    needs: [check-command, get-branch-from-issue]
    if: |
      needs.check-command.outputs.is_valid == 'true' &&
      needs.check-command.outputs.command == 'build' &&
      needs.check-command.outputs.is_pr == 'false' &&
      needs.get-branch-from-issue.outputs.found == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Î∏åÎûúÏπò Ï°¥Ïû¨ ÌôïÏù∏
        id: check_branch
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ needs.get-branch-from-issue.outputs.branch_name }}';
            const issueNumber = ${{ needs.get-branch-from-issue.outputs.issue_number }};

            console.log(`üîç Î∏åÎûúÏπò Ï°¥Ïû¨ ÌôïÏù∏: ${branchName}`);

            try {
              await github.rest.repos.getBranch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                branch: branchName
              });
              core.setOutput('exists', 'true');
              console.log(`‚úÖ Î∏åÎûúÏπò Ï°¥Ïû¨: ${branchName}`);
            } catch (error) {
              if (error.status === 404) {
                core.setOutput('exists', 'false');
                console.log(`‚ùå Î∏åÎûúÏπò ÏóÜÏùå: ${branchName}`);

                // Î∏åÎûúÏπò ÏóÜÏùå ÏïåÎ¶º ÎåìÍ∏Ä
                const body = [
                  '## ‚ùå Î∏åÎûúÏπòÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§',
                  '',
                  '| Ìï≠Î™© | Í∞í |',
                  '|------|-----|',
                  `| **Issue** | #${issueNumber} |`,
                  `| **Î∏åÎûúÏπò** | \`${branchName}\` |`,
                  '',
                  '### üí° ÌôïÏù∏ ÏÇ¨Ìï≠',
                  '1. Î∏åÎûúÏπòÍ∞Ä pushÎêòÏóàÎäîÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî',
                  '2. Î∏åÎûúÏπòÎ™ÖÏù¥ Ï†ïÌôïÌïúÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî',
                  '3. Î∏åÎûúÏπòÍ∞Ä ÏÇ≠Ï†úÎêòÏßÄ ÏïäÏïòÎäîÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî',
                  '',
                  '---',
                  '*ü§ñ Ïù¥ ÎåìÍ∏ÄÏùÄ PR Preview ÏãúÏä§ÌÖúÏóê ÏùòÌï¥ ÏûêÎèô ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.*'
                ].join('\n');

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: body
                });
              } else {
                throw error;
              }
            }

      - name: Î∏åÎûúÏπò ÏóÜÏúºÎ©¥ Ï§ëÎã®
        if: steps.check_branch.outputs.exists == 'false'
        run: |
          echo "‚ö†Ô∏è Î∏åÎûúÏπòÍ∞Ä Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏïÑ ÎπåÎìúÎ•º Í±¥ÎÑàÎúÅÎãàÎã§."
          exit 0

      - name: Issue Ï†ïÎ≥¥ ÏÑ§Ï†ï
        if: steps.check_branch.outputs.exists == 'true'
        id: issue
        run: |
          echo "ref=${{ needs.get-branch-from-issue.outputs.branch_name }}" >> $GITHUB_OUTPUT
          echo "issue_number=${{ needs.get-branch-from-issue.outputs.issue_number }}" >> $GITHUB_OUTPUT
          # Î∏åÎûúÏπòÏùò ÏµúÏã† Ïª§Î∞ã SHA Í∞ÄÏ†∏Ïò§Í∏∞
          echo "sha=$(git ls-remote https://github.com/${{ github.repository }}.git refs/heads/${{ needs.get-branch-from-issue.outputs.branch_name }} | cut -c1-7)" >> $GITHUB_OUTPUT

      # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
      # ÏßÑÌñâ ÏÉÅÌô© ÎåìÍ∏Ä ÏãúÏä§ÌÖú
      # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
      - name: ÏßÑÌñâ ÏÉÅÌô© ÎåìÍ∏Ä ÏÉùÏÑ±
        if: steps.check_branch.outputs.exists == 'true'
        id: progress
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ needs.get-branch-from-issue.outputs.issue_number }};
            const branchName = '${{ needs.get-branch-from-issue.outputs.branch_name }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const startTime = Date.now();

            const body = [
              '## üöÄ Issue Preview ÎπåÎìú Ï§ë...',
              '',
              `**Î∏åÎûúÏπò**: \`${branchName}\``,
              '',
              '| Îã®Í≥Ñ | ÏÉÅÌÉú | ÏÜåÏöî ÏãúÍ∞Ñ |',
              '|------|------|----------|',
              '| üî® ÌîÑÎ°úÏ†ùÌä∏ ÎπåÎìú | ‚è≥ ÏßÑÌñâ Ï§ë... | - |',
              '| üê≥ Docker Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± | ‚è∏Ô∏è ÎåÄÍ∏∞ | - |',
              '| üöÄ ÏÑúÎ≤Ñ Î∞∞Ìè¨ & Health Check | ‚è∏Ô∏è ÎåÄÍ∏∞ | - |',
              '',
              `**[üìã Ïã§ÏãúÍ∞Ñ Î°úÍ∑∏ Î≥¥Í∏∞](${runUrl})**`,
              '',
              '---',
              '*ü§ñ Ïù¥ ÎåìÍ∏ÄÏùÄ ÏûêÎèôÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏Îê©ÎãàÎã§.*'
            ].join('\n');

            const { data: comment } = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: body
            });

            core.setOutput('comment_id', comment.id);
            core.setOutput('start_time', startTime);

      - name: ÏΩîÎìú Ï≤¥ÌÅ¨ÏïÑÏõÉ
        if: steps.check_branch.outputs.exists == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.get-branch-from-issue.outputs.branch_name }}

      - name: JDK ÏÑ§Ï†ï
        if: steps.check_branch.outputs.exists == 'true'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Gradle Í∂åÌïú ÏÑ§Ï†ï
        if: steps.check_branch.outputs.exists == 'true'
        run: chmod +x gradlew

      # =================================================================
      # ‚ö†Ô∏è [ÏòÅÏó≠ 2] ÌîÑÎ°úÏ†ùÌä∏Î≥Ñ Secret ÌååÏùº ÏÉùÏÑ±
      # =================================================================
      - name: "[ÌïÑÏàò] application.yml ÏÉùÏÑ±"
        if: steps.check_branch.outputs.exists == 'true'
        run: |
          mkdir -p $(dirname ${{ env.APPLICATION_YML_PATH }})
          echo "${{ secrets.APPLICATION_YML }}" > ${{ env.APPLICATION_YML_PATH }}

      - name: Gradle ÎπåÎìú
        if: steps.check_branch.outputs.exists == 'true'
        run: ${{ env.GRADLE_BUILD_CMD }}

      - name: ÏßÑÌñâ ÏÉÅÌô© - ÎπåÎìú ÏôÑÎ£å
        if: steps.check_branch.outputs.exists == 'true'
        id: build_progress
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.progress.outputs.comment_id }};
            const branchName = '${{ needs.get-branch-from-issue.outputs.branch_name }}';
            const startTime = ${{ steps.progress.outputs.start_time }};
            const now = Date.now();
            const elapsed = now - startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            const buildDuration = minutes > 0 ? `${minutes}Î∂Ñ ${seconds}Ï¥à` : `${seconds}Ï¥à`;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const body = [
              '## üöÄ Issue Preview ÎπåÎìú Ï§ë...',
              '',
              `**Î∏åÎûúÏπò**: \`${branchName}\``,
              '',
              '| Îã®Í≥Ñ | ÏÉÅÌÉú | ÏÜåÏöî ÏãúÍ∞Ñ |',
              '|------|------|----------|',
              `| üî® ÌîÑÎ°úÏ†ùÌä∏ ÎπåÎìú | ‚úÖ ÏôÑÎ£å | ${buildDuration} |`,
              '| üê≥ Docker Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± | ‚è≥ ÏßÑÌñâ Ï§ë... | - |',
              '| üöÄ ÏÑúÎ≤Ñ Î∞∞Ìè¨ & Health Check | ‚è∏Ô∏è ÎåÄÍ∏∞ | - |',
              '',
              `**[üìã Ïã§ÏãúÍ∞Ñ Î°úÍ∑∏ Î≥¥Í∏∞](${runUrl})**`,
              '',
              '---',
              '*ü§ñ Ïù¥ ÎåìÍ∏ÄÏùÄ ÏûêÎèôÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏Îê©ÎãàÎã§.*'
            ].join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

            core.setOutput('build_duration', buildDuration);
            core.setOutput('docker_start', now);

      - name: Docker Î°úÍ∑∏Ïù∏
        if: steps.check_branch.outputs.exists == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker Buildx ÏÑ§Ï†ï
        if: steps.check_branch.outputs.exists == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú & Push
        if: steps.check_branch.outputs.exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ env.DOCKERFILE_PATH }}
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.PROJECT_NAME }}:pr-${{ needs.get-branch-from-issue.outputs.issue_number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ÏßÑÌñâ ÏÉÅÌô© - Docker ÏôÑÎ£å
        if: steps.check_branch.outputs.exists == 'true'
        id: docker_progress
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.progress.outputs.comment_id }};
            const branchName = '${{ needs.get-branch-from-issue.outputs.branch_name }}';
            const buildDuration = '${{ steps.build_progress.outputs.build_duration }}';
            const dockerStart = ${{ steps.build_progress.outputs.docker_start }};
            const now = Date.now();
            const dockerElapsed = now - dockerStart;
            const minutes = Math.floor(dockerElapsed / 60000);
            const seconds = Math.floor((dockerElapsed % 60000) / 1000);
            const dockerDuration = minutes > 0 ? `${minutes}Î∂Ñ ${seconds}Ï¥à` : `${seconds}Ï¥à`;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const body = [
              '## üöÄ Issue Preview ÎπåÎìú Ï§ë...',
              '',
              `**Î∏åÎûúÏπò**: \`${branchName}\``,
              '',
              '| Îã®Í≥Ñ | ÏÉÅÌÉú | ÏÜåÏöî ÏãúÍ∞Ñ |',
              '|------|------|----------|',
              `| üî® ÌîÑÎ°úÏ†ùÌä∏ ÎπåÎìú | ‚úÖ ÏôÑÎ£å | ${buildDuration} |`,
              `| üê≥ Docker Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± | ‚úÖ ÏôÑÎ£å | ${dockerDuration} |`,
              '| üöÄ ÏÑúÎ≤Ñ Î∞∞Ìè¨ & Health Check | ‚è≥ ÏßÑÌñâ Ï§ë... | - |',
              '',
              `**[üìã Ïã§ÏãúÍ∞Ñ Î°úÍ∑∏ Î≥¥Í∏∞](${runUrl})**`,
              '',
              '---',
              '*ü§ñ Ïù¥ ÎåìÍ∏ÄÏùÄ ÏûêÎèôÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏Îê©ÎãàÎã§.*'
            ].join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

            core.setOutput('build_duration', buildDuration);
            core.setOutput('docker_duration', dockerDuration);
            core.setOutput('deploy_start', now);

      - name: ÏÑúÎ≤ÑÏóê Î∞∞Ìè¨
        if: steps.check_branch.outputs.exists == 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            set -e

            # ÌôòÍ≤Ω Î≥ÄÏàò ÏÑ§Ï†ï (ÏãúÎÜÄÎ°úÏßÄ NASÏö©)
            export PATH=$PATH:/usr/local/bin
            export PW="${{ secrets.SERVER_PASSWORD }}"

            # Î≥ÄÏàò ÏÑ§Ï†ï
            ISSUE_NUMBER=${{ needs.get-branch-from-issue.outputs.issue_number }}
            PROJECT_NAME="${{ env.PROJECT_NAME }}"
            CONTAINER_NAME="${PROJECT_NAME}-pr-${ISSUE_NUMBER}"
            IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/${PROJECT_NAME}:pr-${ISSUE_NUMBER}"
            DOMAIN="${PROJECT_NAME}-pr-${ISSUE_NUMBER}.${{ env.PREVIEW_DOMAIN_SUFFIX }}"
            INTERNAL_PORT="${{ env.INTERNAL_PORT }}"
            TRAEFIK_NETWORK="${{ env.TRAEFIK_NETWORK }}"

            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "üöÄ Issue Preview Î∞∞Ìè¨ ÏãúÏûë"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "üì¶ ÌîÑÎ°úÏ†ùÌä∏: ${PROJECT_NAME}"
            echo "üî¢ Issue Î≤àÌò∏: #${ISSUE_NUMBER}"
            echo "üìõ Ïª®ÌÖåÏù¥ÎÑà: ${CONTAINER_NAME}"
            echo "üåê ÎèÑÎ©îÏù∏: ${DOMAIN}"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

            # Ïù¥ÎØ∏ÏßÄ Pull
            echo "üì• Docker Ïù¥ÎØ∏ÏßÄ Pull Ï§ë..."
            echo $PW | sudo -S docker pull "${IMAGE}"

            # Í∏∞Ï°¥ Ïª®ÌÖåÏù¥ÎÑà ÏÇ≠Ï†ú
            echo "üóëÔ∏è Í∏∞Ï°¥ Ïª®ÌÖåÏù¥ÎÑà Ï†ïÎ¶¨ Ï§ë..."
            echo $PW | sudo -S docker rm -f "${CONTAINER_NAME}" 2>/dev/null || true

            # ÏÉà Ïª®ÌÖåÏù¥ÎÑà Ïã§Ìñâ
            echo "üê≥ ÏÉà Ïª®ÌÖåÏù¥ÎÑà Ïã§Ìñâ Ï§ë..."
            echo $PW | sudo -S docker run -d \
              --name "${CONTAINER_NAME}" \
              --network "${TRAEFIK_NETWORK}" \
              --label "traefik.enable=true" \
              --label "traefik.http.routers.${CONTAINER_NAME}.rule=Host(\`${DOMAIN}\`)" \
              --label "traefik.http.routers.${CONTAINER_NAME}.entrypoints=web" \
              --label "traefik.http.services.${CONTAINER_NAME}.loadbalancer.server.port=${INTERNAL_PORT}" \
              -e TZ=Asia/Seoul \
              -e SPRING_PROFILES_ACTIVE=prod \
              -v /etc/localtime:/etc/localtime:ro \
              "${IMAGE}"

            # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
            # Health Check (ÏµúÎåÄ 120Ï¥à ÎåÄÍ∏∞) - ÌïòÏù¥Î∏åÎ¶¨Îìú Î∞©Ïãù
            # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
            echo ""
            echo "‚è≥ Health Check ÏãúÏûë (ÏµúÎåÄ 120Ï¥à ÎåÄÍ∏∞)..."
            MAX_RETRIES=24
            RETRY_COUNT=0
            HEALTH_CHECK_PASSED=false
            HEALTH_CHECK_METHOD=""

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              sleep 5
              RETRY_COUNT=$((RETRY_COUNT + 1))

              # 1. Ïª®ÌÖåÏù¥ÎÑà ÏÉÅÌÉú ÌôïÏù∏
              STATUS=$(echo $PW | sudo -S docker inspect --format='{{.State.Status}}' "${CONTAINER_NAME}" 2>/dev/null || echo "not_found")

              if [ "$STATUS" = "exited" ]; then
                echo "‚ùå Ïª®ÌÖåÏù¥ÎÑà ÎπÑÏ†ïÏÉÅ Ï¢ÖÎ£å!"
                echo ""
                echo "üìã Ïª®ÌÖåÏù¥ÎÑà Î°úÍ∑∏ (ÏµúÍ∑º 100Ï§Ñ):"
                echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                echo $PW | sudo -S docker logs --tail 100 "${CONTAINER_NAME}"
                echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                exit 1
              fi

              if [ "$STATUS" = "running" ]; then
                # 2. Actuator Health Check ÏãúÎèÑ
                HEALTH=$(echo $PW | sudo -S docker exec "${CONTAINER_NAME}" wget -qO- http://localhost:${INTERNAL_PORT}/actuator/health 2>/dev/null || echo "")

                if echo "$HEALTH" | grep -q '"status":"UP"'; then
                  echo "‚úÖ Spring Boot Ï†ïÏÉÅ Í∏∞Îèô ÌôïÏù∏! (Actuator)"
                  HEALTH_CHECK_PASSED=true
                  HEALTH_CHECK_METHOD="Actuator"
                  break
                fi

                # 3. Actuator ÏóÜÏúºÎ©¥ Î°úÍ∑∏ Ìå®ÌÑ¥ Îß§Ïπ≠ÏúºÎ°ú Ìè¥Î∞±
                STARTED=$(echo $PW | sudo -S docker logs --tail 50 "${CONTAINER_NAME}" 2>&1 | grep -E "Started .* in [0-9.]+ seconds" || echo "")

                if [ -n "$STARTED" ]; then
                  echo "‚úÖ Spring Boot Ï†ïÏÉÅ Í∏∞Îèô ÌôïÏù∏! (Î°úÍ∑∏ Ìå®ÌÑ¥)"
                  echo "   $STARTED"
                  HEALTH_CHECK_PASSED=true
                  HEALTH_CHECK_METHOD="Log"
                  break
                fi
              fi

              echo "‚è≥ ÎåÄÍ∏∞ Ï§ë... ($RETRY_COUNT/$MAX_RETRIES) - ÏÉÅÌÉú: $STATUS"
            done

            if [ "$HEALTH_CHECK_PASSED" = "false" ]; then
              echo ""
              echo "‚ùå Health Check ÌÉÄÏûÑÏïÑÏõÉ (120Ï¥à)"
              echo ""
              echo "üìã Ïª®ÌÖåÏù¥ÎÑà Î°úÍ∑∏ (ÏµúÍ∑º 100Ï§Ñ):"
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo $PW | sudo -S docker logs --tail 100 "${CONTAINER_NAME}"
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              exit 1
            fi

            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "‚úÖ Î∞∞Ìè¨ Î∞è Health Check ÏôÑÎ£å! (Î∞©Ïãù: ${HEALTH_CHECK_METHOD})"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

      - name: Î∞∞Ìè¨ ÏôÑÎ£å ÏΩîÎ©òÌä∏
        if: steps.check_branch.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.progress.outputs.comment_id }};
            const branchName = '${{ needs.get-branch-from-issue.outputs.branch_name }}';
            const buildDuration = '${{ steps.docker_progress.outputs.build_duration }}';
            const dockerDuration = '${{ steps.docker_progress.outputs.docker_duration }}';
            const deployStart = ${{ steps.docker_progress.outputs.deploy_start }};
            const now = Date.now();
            const deployElapsed = now - deployStart;
            const minutes = Math.floor(deployElapsed / 60000);
            const seconds = Math.floor((deployElapsed % 60000) / 1000);
            const deployDuration = minutes > 0 ? `${minutes}Î∂Ñ ${seconds}Ï¥à` : `${seconds}Ï¥à`;

            const projectName = '${{ env.PROJECT_NAME }}';
            const domainSuffix = '${{ env.PREVIEW_DOMAIN_SUFFIX }}';
            const previewPort = '${{ env.PREVIEW_PORT }}';
            const issueNumber = ${{ needs.get-branch-from-issue.outputs.issue_number }};
            const domain = `${projectName}-pr-${issueNumber}.${domainSuffix}`;
            const previewUrl = `http://${domain}:${previewPort}`;

            const body = [
              '## ‚úÖ Issue Preview Î∞∞Ìè¨ ÏôÑÎ£å!',
              '',
              `**Î∏åÎûúÏπò**: \`${branchName}\``,
              '',
              '| Îã®Í≥Ñ | ÏÉÅÌÉú | ÏÜåÏöî ÏãúÍ∞Ñ |',
              '|------|------|----------|',
              `| üî® ÌîÑÎ°úÏ†ùÌä∏ ÎπåÎìú | ‚úÖ ÏôÑÎ£å | ${buildDuration} |`,
              `| üê≥ Docker Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± | ‚úÖ ÏôÑÎ£å | ${dockerDuration} |`,
              `| üöÄ ÏÑúÎ≤Ñ Î∞∞Ìè¨ & Health Check | ‚úÖ ÏôÑÎ£å | ${deployDuration} |`,
              '',
              '### üåê Preview ÌôòÍ≤Ω',
              '| Ìï≠Î™© | Í∞í |',
              '|------|-----|',
              `| **Preview URL** | ${previewUrl} |`,
              `| **Ïª®ÌÖåÏù¥ÎÑà** | \`${projectName}-pr-${issueNumber}\` |`,
              `| **Î∏åÎûúÏπò** | \`${branchName}\` |`,
              '',
              '### üìã Î™ÖÎ†πÏñ¥',
              '| Î™ÖÎ†πÏñ¥ | ÏÑ§Î™Ö |',
              '|--------|------|',
              '| `@suh-lab server build` | ÏµúÏã† Ïª§Î∞ãÏúºÎ°ú Ïû¨Î∞∞Ìè¨ |',
              '| `@suh-lab server destroy` | Preview ÌôòÍ≤Ω ÏÇ≠Ï†ú |',
              '| `@suh-lab server status` | ÌòÑÏû¨ ÏÉÅÌÉú ÌôïÏù∏ |',
              '',
              '---',
              '*ü§ñ Ïù¥ ÎåìÍ∏ÄÏùÄ Issue Preview ÏãúÏä§ÌÖúÏóê ÏùòÌï¥ ÏûêÎèô ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.*'
            ].join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

      - name: ÎπåÎìú/Î∞∞Ìè¨ Ïã§Ìå® Ïãú ÏóêÎü¨ ÏΩîÎ©òÌä∏
        if: failure() && steps.check_branch.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.progress.outputs.comment_id || 0 }};
            const projectName = '${{ env.PROJECT_NAME }}';
            const issueNumber = ${{ needs.get-branch-from-issue.outputs.issue_number }};
            const branchName = '${{ needs.get-branch-from-issue.outputs.branch_name }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const buildDuration = '${{ steps.build_progress.outputs.build_duration }}';
            const dockerDuration = '${{ steps.docker_progress.outputs.docker_duration }}';

            let buildStatus, dockerStatus, deployStatus;
            let buildTime = '-', dockerTime = '-';

            if (!commentId) {
              buildStatus = '‚ö†Ô∏è Ï¥àÍ∏∞Ìôî Ïã§Ìå®';
              dockerStatus = '-';
              deployStatus = '-';
            } else if (!buildDuration || buildDuration === '') {
              buildStatus = '‚ùå Ïã§Ìå®';
              dockerStatus = '‚è∏Ô∏è ÎåÄÍ∏∞';
              deployStatus = '‚è∏Ô∏è ÎåÄÍ∏∞';
            } else if (!dockerDuration || dockerDuration === '') {
              buildStatus = '‚úÖ ÏôÑÎ£å';
              dockerStatus = '‚ùå Ïã§Ìå®';
              deployStatus = '‚è∏Ô∏è ÎåÄÍ∏∞';
              buildTime = buildDuration;
            } else {
              buildStatus = '‚úÖ ÏôÑÎ£å';
              dockerStatus = '‚úÖ ÏôÑÎ£å';
              deployStatus = '‚ùå Ïã§Ìå®';
              buildTime = buildDuration;
              dockerTime = dockerDuration;
            }

            const body = [
              '## ‚ùå Issue Preview Î∞∞Ìè¨ Ïã§Ìå®!',
              '',
              `**Î∏åÎûúÏπò**: \`${branchName}\``,
              '',
              '| Îã®Í≥Ñ | ÏÉÅÌÉú | ÏÜåÏöî ÏãúÍ∞Ñ |',
              '|------|------|----------|',
              `| üî® ÌîÑÎ°úÏ†ùÌä∏ ÎπåÎìú | ${buildStatus} | ${buildTime} |`,
              `| üê≥ Docker Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± | ${dockerStatus} | ${dockerTime} |`,
              `| üöÄ ÏÑúÎ≤Ñ Î∞∞Ìè¨ & Health Check | ${deployStatus} | - |`,
              '',
              `**[üìã ÎπåÎìú/Î∞∞Ìè¨ Î°úÍ∑∏ ÌôïÏù∏](${runUrl})**`,
              '',
              '### üîç Í∞ÄÎä•Ìïú ÏõêÏù∏',
              '- Gradle ÎπåÎìú Ïã§Ìå®',
              '- Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú Ïã§Ìå®',
              '- Ïª®ÌÖåÏù¥ÎÑà ÏãúÏûë Ïã§Ìå® (Spring Boot Í∏∞Îèô Ïò§Î•ò)',
              '- Health Check ÌÉÄÏûÑÏïÑÏõÉ (120Ï¥à ÎÇ¥ Í∏∞Îèô ÏôÑÎ£å ÏïàÎê®)',
              '',
              '### üí° Îã§Ïùå Îã®Í≥Ñ',
              '1. ÏúÑ ÎßÅÌÅ¨ÏóêÏÑú ÎπåÎìú/Î∞∞Ìè¨ Î°úÍ∑∏Î•º ÌôïÏù∏ÌïòÏÑ∏Ïöî',
              '2. Î¨∏Ï†úÎ•º ÏàòÏ†ïÌïú ÌõÑ Îã§Ïãú ÏãúÎèÑÌïòÏÑ∏Ïöî: `@suh-lab server build`',
              '',
              '---',
              '*ü§ñ Ïù¥ ÎåìÍ∏ÄÏùÄ Issue Preview ÏãúÏä§ÌÖúÏóê ÏùòÌï¥ ÏûêÎèô ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.*'
            ].join('\n');

            if (commentId) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: commentId,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: body
              });
            }

  # -----------------------------------------------------------------
  # Job 4: Preview ÏÇ≠Ï†ú (PR/Issue Îã´Ìûò ÎòêÎäî destroy Î™ÖÎ†π)
  # -----------------------------------------------------------------
  destroy-preview:
    name: Preview ÏÇ≠Ï†ú
    needs: check-command
    if: |
      always() && (
        (github.event_name == 'issue_comment' && needs.check-command.outputs.is_valid == 'true' && needs.check-command.outputs.command == 'destroy') ||
        (github.event_name == 'pull_request' && github.event.action == 'closed') ||
        (github.event_name == 'issues' && github.event.action == 'closed')
      )
    runs-on: ubuntu-latest
    steps:
      - name: PR/Issue Î≤àÌò∏ Í∞ÄÏ†∏Ïò§Í∏∞
        id: pr_number
        run: |
          if [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            echo "type=comment" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "type=pr_closed" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            echo "type=issue_closed" >> $GITHUB_OUTPUT
          fi

      - name: Ïª®ÌÖåÏù¥ÎÑà & Ïù¥ÎØ∏ÏßÄ ÏÇ≠Ï†ú
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            # ÌôòÍ≤Ω Î≥ÄÏàò ÏÑ§Ï†ï (ÏãúÎÜÄÎ°úÏßÄ NASÏö©)
            export PATH=$PATH:/usr/local/bin
            export PW="${{ secrets.SERVER_PASSWORD }}"

            PR_NUMBER=${{ steps.pr_number.outputs.number }}
            PROJECT_NAME="${{ env.PROJECT_NAME }}"
            CONTAINER_NAME="${PROJECT_NAME}-pr-${PR_NUMBER}"
            IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/${PROJECT_NAME}:pr-${PR_NUMBER}"

            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "üóëÔ∏è PR Preview ÏÇ≠Ï†ú"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "üì¶ ÌîÑÎ°úÏ†ùÌä∏: ${PROJECT_NAME}"
            echo "üî¢ PR Î≤àÌò∏: #${PR_NUMBER}"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

            # Ïª®ÌÖåÏù¥ÎÑà ÏÇ≠Ï†ú
            echo "üê≥ Ïª®ÌÖåÏù¥ÎÑà ÏÇ≠Ï†ú Ï§ë..."
            echo $PW | sudo -S docker rm -f "${CONTAINER_NAME}" 2>/dev/null || true

            # Ïù¥ÎØ∏ÏßÄ ÏÇ≠Ï†ú
            echo "üñºÔ∏è Ïù¥ÎØ∏ÏßÄ ÏÇ≠Ï†ú Ï§ë..."
            echo $PW | sudo -S docker rmi "${IMAGE}" 2>/dev/null || true

            echo "‚úÖ ÏÇ≠Ï†ú ÏôÑÎ£å!"

      - name: ÏÇ≠Ï†ú ÏôÑÎ£å ÏΩîÎ©òÌä∏
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const number = ${{ steps.pr_number.outputs.number }};
            const projectName = '${{ env.PROJECT_NAME }}';

            const body = [
              '## üóëÔ∏è Preview ÌôòÍ≤Ω ÏÇ≠Ï†ú ÏôÑÎ£å!',
              '',
              '| Ìï≠Î™© | Í∞í |',
              '|------|-----|',
              `| **Ïª®ÌÖåÏù¥ÎÑà** | \`${projectName}-pr-${number}\` |`,
              '| **ÏÉÅÌÉú** | ÏÇ≠Ï†úÎê® |',
              '',
              'Îã§Ïãú Î∞∞Ìè¨ÌïòÎ†§Î©¥: `@suh-lab server build`',
              '',
              '---',
              '*ü§ñ Ïù¥ ÎåìÍ∏ÄÏùÄ PR/Issue Preview ÏãúÏä§ÌÖúÏóê ÏùòÌï¥ ÏûêÎèô ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.*'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: number,
              body: body
            });

  # -----------------------------------------------------------------
  # Job 5: ÏÉÅÌÉú ÌôïÏù∏ (PR/Issue Î™®Îëê ÏßÄÏõê)
  # -----------------------------------------------------------------
  check-status:
    name: Preview ÏÉÅÌÉú ÌôïÏù∏
    needs: check-command
    if: needs.check-command.outputs.is_valid == 'true' && needs.check-command.outputs.command == 'status'
    runs-on: ubuntu-latest
    steps:
      - name: Ïª®ÌÖåÏù¥ÎÑà ÏÉÅÌÉú ÌôïÏù∏
        id: status
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            # ÌôòÍ≤Ω Î≥ÄÏàò ÏÑ§Ï†ï (ÏãúÎÜÄÎ°úÏßÄ NASÏö©)
            export PATH=$PATH:/usr/local/bin

            NUMBER=${{ github.event.issue.number }}
            PROJECT_NAME="${{ env.PROJECT_NAME }}"
            CONTAINER_NAME="${PROJECT_NAME}-pr-${NUMBER}"

            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "üîç Preview ÏÉÅÌÉú ÌôïÏù∏"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

            if docker ps --filter "name=${CONTAINER_NAME}" --format "{{.Names}}" | grep -q "${CONTAINER_NAME}"; then
              echo "STATUS=running"
              echo "‚úÖ Ïª®ÌÖåÏù¥ÎÑà Ïã§Ìñâ Ï§ë"
              docker ps --filter "name=${CONTAINER_NAME}" --format "table {{.Names}}\t{{.Status}}\t{{.RunningFor}}"
            else
              echo "STATUS=not_found"
              echo "‚ùå Ïª®ÌÖåÏù¥ÎÑà ÏóÜÏùå"
            fi

      - name: ÏÉÅÌÉú ÏΩîÎ©òÌä∏ (Ïã§Ìñâ Ï§ë)
        uses: appleboy/ssh-action@v1.0.3
        id: check_running
        continue-on-error: true
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            # ÌôòÍ≤Ω Î≥ÄÏàò ÏÑ§Ï†ï (ÏãúÎÜÄÎ°úÏßÄ NASÏö©)
            export PATH=$PATH:/usr/local/bin

            NUMBER=${{ github.event.issue.number }}
            PROJECT_NAME="${{ env.PROJECT_NAME }}"
            CONTAINER_NAME="${PROJECT_NAME}-pr-${NUMBER}"
            docker ps --filter "name=${CONTAINER_NAME}" --format "{{.Names}}" | grep -q "${CONTAINER_NAME}"

      - name: ÏÉÅÌÉú ÏΩîÎ©òÌä∏ ÏûëÏÑ±
        uses: actions/github-script@v7
        with:
          script: |
            const number = context.issue.number;
            const projectName = '${{ env.PROJECT_NAME }}';
            const domainSuffix = '${{ env.PREVIEW_DOMAIN_SUFFIX }}';
            const previewPort = '${{ env.PREVIEW_PORT }}';
            const domain = `${projectName}-pr-${number}.${domainSuffix}`;
            const previewUrl = `http://${domain}:${previewPort}`;
            const isRunning = '${{ steps.check_running.outcome }}' === 'success';
            const isPr = '${{ needs.check-command.outputs.is_pr }}' === 'true';
            const contextType = isPr ? 'PR' : 'Issue';

            let body;
            if (isRunning) {
              body = [
                '## ‚úÖ Preview ÌôòÍ≤Ω Ïã§Ìñâ Ï§ë',
                '',
                '| Ìï≠Î™© | Í∞í |',
                '|------|-----|',
                `| **Preview URL** | ${previewUrl} |`,
                `| **Ïª®ÌÖåÏù¥ÎÑà** | \`${projectName}-pr-${number}\` |`,
                '| **ÏÉÅÌÉú** | üü¢ Running |',
                '',
                '### üìã Î™ÖÎ†πÏñ¥',
                '| Î™ÖÎ†πÏñ¥ | ÏÑ§Î™Ö |',
                '|--------|------|',
                '| `@suh-lab server build` | ÏµúÏã† Ïª§Î∞ãÏúºÎ°ú Ïû¨Î∞∞Ìè¨ |',
                '| `@suh-lab server destroy` | Preview ÌôòÍ≤Ω ÏÇ≠Ï†ú |',
                '',
                '---',
                `*ü§ñ Ïù¥ ÎåìÍ∏ÄÏùÄ ${contextType} Preview ÏãúÏä§ÌÖúÏóê ÏùòÌï¥ ÏûêÎèô ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.*`
              ].join('\n');
            } else {
              body = [
                '## ‚ùå Preview ÌôòÍ≤Ω ÏóÜÏùå',
                '',
                '| Ìï≠Î™© | Í∞í |',
                '|------|-----|',
                `| **Ïª®ÌÖåÏù¥ÎÑà** | \`${projectName}-pr-${number}\` |`,
                '| **ÏÉÅÌÉú** | üî¥ Not Found |',
                '',
                'Î∞∞Ìè¨ÌïòÎ†§Î©¥: `@suh-lab server build`',
                '',
                '---',
                `*ü§ñ Ïù¥ ÎåìÍ∏ÄÏùÄ ${contextType} Preview ÏãúÏä§ÌÖúÏóê ÏùòÌï¥ ÏûêÎèô ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.*`
              ].join('\n');
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: number,
              body: body
            });
