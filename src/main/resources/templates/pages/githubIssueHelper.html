<!-- src/main/resources/templates/pages/githubIssueHelper.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head(title='깃헙이슈도우미-SAECHAN-LAB')}"></head>
<body class="githubIssueHelper-page">
<div th:replace="~{fragments/header :: header}"></div>
<div class="ui container">
  <h2 class="ui header">깃헙 이슈 도우미</h2>
  <form class="ui form" id="issueHelperForm" method="post" enctype="multipart/form-data"
        th:action="@{/api/issue-helper/create/commmit-branch}">
    <div class="field">
      <label>GitHub Issue URL</label>
      <input type="text" name="issueUrl" placeholder="https://github.com/owner/repo/issues/2" required>
    </div>
    <input type="hidden" name="clientHash" id="clientHash">
    <button class="ui primary button" type="submit">생성하기</button>
  </form>

  <div class="ui segment copy-box" id="resultBox" style="display: none;">
    <h4 class="ui header">추론 결과</h4>
    <div class="ui form">
      <div class="field">
        <label>브랜치명</label>
        <div class="ui action input">
          <textarea id="branchName" readonly style="min-height: 50px; width: 100%;"></textarea>
          <button class="ui button" id="copyBranch">복사</button>
        </div>
      </div>
      <div class="field">
        <label>커밋 메시지</label>
        <div class="ui action input">
          <textarea id="commitMessage" readonly style="min-height: 80px; width: 100%;"></textarea>
          <button class="ui button" id="copyCommit">복사</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 토스트 컨테이너 (없으면 자동 생성) -->
<div id="toast-container"></div>

<div th:replace="~{fragments/footer :: footer}"></div>

</body>
<script>
  $(function () {
    $("#issueHelperForm").submit(async function (event) {
      event.preventDefault();
      console.log("폼 제출 시작");

      try {
        // ClientHash 불러오기
        console.log("ClientInfo 불러오기 시도");
        const clientInfo = await getClientHash();
        console.log("ClientInfo 결과:", clientInfo);

        // ClientHash 암호화 처리
        console.log("ClientInfo 암호화 시도");
        const encryptedIp = clientInfo ? await encryptIp(clientInfo) : '';
        console.log("암호화된 IP:", encryptedIp);
        $("#clientHash").val(encryptedIp);

        // FormData 생성 및 전송
        var formData = new FormData(this);

        // FormData 내용 로깅
        console.log("폼 액션 URL:", $(this).attr("action"));
        for (let pair of formData.entries()) {
          console.log(pair[0] + ': ' + pair[1]);
        }

        console.log("AJAX 요청 시작");
        $.ajax({
          url: $(this).attr("action"),
          type: "POST",
          data: formData,
          processData: false,
          contentType: false,
          success: function (response) {
            console.log("AJAX 요청 성공:", response);
            $("#branchName").val(response.branchName);
            $("#commitMessage").val(response.commitMessage);
            $("#resultBox").show();
          },
          error: function (xhr, status, error) {
            console.error("AJAX 요청 실패");
            console.error("상태:", status);
            console.error("오류:", error);
            console.error("응답:", xhr.responseText);
            showToast("요청 처리에 실패했습니다.");
          }
        });
      } catch (error) {
        console.error("처리 중 예외 발생:", error);
        showToast("요청 처리에 실패했습니다.");
      }
    });

    // 브랜치 명 복사 버튼 클릭 시 동작
    $("#copyBranch").click(function () {
      copyToClipboard($("#branchName").val(), "브랜치명이 복사되었습니다.");
    });

    // 커밋 메시지 복사 버튼 클릭 시 동작
    $("#copyCommit").click(function () {
      copyToClipboard($("#commitMessage").val(), "커밋 메시지가 복사되었습니다.");
    });

    // 복사 함수
    function copyToClipboard(text, msg) {
      var $temp = $("<textarea>");
      $("body").append($temp);
      $temp.val(text).select();
      document.execCommand("copy");
      $temp.remove();
      showToast(msg);
    }

  });
</script>
</html>